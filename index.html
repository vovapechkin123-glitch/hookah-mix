<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>THE MENU</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700;800&family=Cormorant+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  color-scheme: dark;

  --ink: rgba(255,255,255,.94);
  --muted: rgba(255,255,255,.72);
  --soft: rgba(255,255,255,.56);

  --gold1: rgba(240,214,150,1);
  --gold2: rgba(186,118,48,1);

  --stroke: rgba(255,255,255,.10);
  --ease: cubic-bezier(.2,.9,.2,1);
  --ease2: cubic-bezier(.16,1,.3,1);

  --safeTop: env(safe-area-inset-top, 0px);
  --safeBottom: env(safe-area-inset-bottom, 0px);
}

*{ box-sizing:border-box; }
html,body{ height:100%; }

body{
  margin:0;
  overflow:hidden;
  color:var(--ink);
  font-family:"Cormorant Garamond", ui-serif, Georgia, "Times New Roman", serif;

  background:
    radial-gradient(1200px 800px at 18% 12%, rgba(240,214,150,.14), transparent 60%),
    radial-gradient(900px 700px at 82% 30%, rgba(186,118,48,.10), transparent 62%),
    radial-gradient(700px 600px at 45% 90%, rgba(0,0,0,.60), transparent 66%),
    linear-gradient(180deg, rgba(10,6,4,1), rgba(0,0,0,1));
}

body::before{
  content:"";
  position:fixed;
  inset:0;
  z-index:0;
  pointer-events:none;
  background:
    radial-gradient(1400px 900px at 50% 42%, rgba(0,0,0,.12), rgba(0,0,0,.78) 72%, rgba(0,0,0,.94) 100%),
    linear-gradient(180deg, rgba(0,0,0,.72), rgba(0,0,0,.30) 40%, rgba(0,0,0,.82));
}

body::after{
  content:"";
  position:fixed;
  inset:0;
  z-index:0;
  pointer-events:none;
  opacity:.09;
  mix-blend-mode: overlay;
  background-image:
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.7' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='240' height='240' filter='url(%23n)' opacity='.9'/%3E%3C/svg%3E");
}

#app{
  position:relative;
  z-index:1;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  padding: calc(16px + var(--safeTop)) 14px calc(16px + var(--safeBottom));
}

.book{
  width:min(500px, 100%);
  border-radius: 30px;
  padding: 16px;
  position:relative;
  overflow:hidden;

  background:
    radial-gradient(1200px 700px at 30% 12%, rgba(240,214,150,.10), transparent 62%),
    radial-gradient(900px 700px at 80% 90%, rgba(186,118,48,.08), transparent 60%),
    linear-gradient(180deg, rgba(30,18,12,.98), rgba(14,8,6,.98));

  border:1px solid rgba(255,255,255,.10);
  box-shadow:
    0 40px 150px rgba(0,0,0,.78),
    0 16px 70px rgba(0,0,0,.62);

  transform: translateZ(0);
  animation: float 6.2s ease-in-out infinite;
}

@keyframes float{
  0%,100%{ transform: translateY(0); }
  50%{ transform: translateY(-3px); }
}

.panel{
  position:relative;
  border-radius: 24px;
  overflow:hidden;
  background:
    radial-gradient(900px 520px at 30% 10%, rgba(240,214,150,.10), transparent 62%),
    radial-gradient(860px 600px at 74% 92%, rgba(186,118,48,.10), transparent 60%),
    linear-gradient(180deg, rgba(18,10,6,.94), rgba(10,6,4,.96));
  border:1px solid rgba(240,214,150,.16);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.08),
    inset 0 -28px 60px rgba(0,0,0,.62),
    0 18px 70px rgba(0,0,0,.55);
}

.topbar{
  position:relative;
  z-index:3;
  padding: 14px 14px 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.brand{
  display:flex;
  align-items:center;
  gap:10px;
  letter-spacing:.22em;
  text-transform:uppercase;
  font-weight:800;
  font-size:12px;
  font-family:"Cinzel", serif;
  color: rgba(255,255,255,.82);
}

.brand .dot{
  width:7px;height:7px;border-radius:999px;
  background: rgba(240,214,150,.82);
  box-shadow: 0 0 0 5px rgba(240,214,150,.12);
}

.iconBtn{
  width:40px;height:40px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:
    radial-gradient(120px 120px at 30% 20%, rgba(240,214,150,.18), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.22));
  color: rgba(255,255,255,.92);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
  user-select:none;
  transition: transform .14s var(--ease), box-shadow .14s var(--ease), border-color .14s var(--ease), filter .14s var(--ease);
}

.iconBtn:hover{ border-color: rgba(240,214,150,.22); filter: brightness(1.05); }
.iconBtn:active{ transform: translateY(1px) scale(.98); }
.iconBtn.on{
  border-color: rgba(240,214,150,.30);
  box-shadow: 0 0 0 5px rgba(240,214,150,.14);
}

.content{
  position:relative;
  z-index:3;
  padding: 10px 14px 12px;
  max-height: calc(100vh - 170px);
  overflow:auto;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
}

.screen{ display:none; }
.screen.active{ display:block; }

.h1{
  font-family:"Cinzel", serif;
  font-size:22px;
  margin:0 0 6px;
  letter-spacing:.03em;
  font-weight:800;
}

.sub{
  color:var(--muted);
  font-size:14px;
  line-height:1.55;
  margin:0 0 10px;
}

.btn{
  width:100%;
  padding: 12px 12px;
  border-radius: 16px;
  border:1px solid rgba(255,255,255,.10);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.24));
  color: rgba(255,255,255,.92);
  cursor:pointer;
  font-weight:900;
  font-family:"Cinzel", serif;
  letter-spacing:.08em;
}

.btn.primary{
  border-color: rgba(240,214,150,.24);
  background:
    radial-gradient(520px 260px at 30% 10%, rgba(240,214,150,.18), transparent 56%),
    linear-gradient(180deg, rgba(240,214,150,.12), rgba(0,0,0,.24));
}

.gate{
  display:flex;
  align-items:center;
  justify-content:center;
  min-height: 420px;
  padding: 12px 6px 6px;
  text-align:center;
}

.seal{
  width:104px;height:104px;border-radius:999px;
  display:flex;align-items:center;justify-content:center;
  margin: 10px auto 14px;
  cursor:pointer;
  user-select:none;
  background: radial-gradient(circle at 30% 30%, rgba(240,214,150,.98), rgba(186,118,48,.86));
  box-shadow: 0 26px 90px rgba(186,118,48,.22), inset 0 1px 0 rgba(255,255,255,.14), inset 0 -18px 30px rgba(0,0,0,.30);
  border:1px solid rgba(255,255,255,.10);
}

.seal .note{ font-size:34px; font-weight:900; }
</style>
</head>
<body>
  <div id="app">
    <div class="book">
      <div class="panel">

        <div class="topbar">
          <div class="brand">
            <span class="dot"></span>
            <span>THE MENU</span>
          </div>
          <button class="iconBtn" id="musicBtn" title="Музыка">♫</button>
        </div>

        <div class="content">

          <!-- GATE -->
          <div class="screen active" id="scr_gate">
            <div class="gate">
              <div>
                <div class="seal" id="sealBtn"><div class="note">♫</div></div>
                <div class="h1">Включите зал.</div>
                <div class="sub">Нажмите на знак.<br>Дальше — без лишних слов.</div>
                <div class="sub" style="font-size:12px;opacity:.75;margin-top:8px;">Громкость уже выставлена: 30%.</div>
              </div>
            </div>
          </div>

          <!-- DOOR -->
          <div class="screen" id="scr_door">
            <div class="h1">Открыть дверь.</div>
            <div class="sub">Это вход не в заказ.<br>Это вход в процесс.</div>
            <div style="height:1px;background:linear-gradient(90deg,transparent,rgba(240,214,150,.22),transparent);margin:12px 0;"></div>
            <button class="btn primary" id="btnDoor">Открыть</button>
            <button class="btn" id="btnDoorHelp" style="margin-top:10px;background:rgba(0,0,0,.16);">Я не могу дать гео</button>
            <div class="sub" style="font-size:12px;opacity:.7;margin-top:10px;text-align:center;">
              Если устройство молчит — сегодня без этого.
            </div>
          </div>

          <!-- OUTSIDE -->
          <div class="screen" id="scr_outside">
            <div class="h1">Снаружи.</div>
            <div class="sub">Сейчас это место не совпадает с залом.<br>Вернитесь — и повторите.</div>
            <div style="display:flex;gap:10px;margin-top:10px;">
              <button class="btn primary" id="btnOutsideRetry">Проверить снова</button>
              <button class="btn" id="btnOutsideBack">Назад</button>
            </div>
          </div>

          <!-- NO PERMISSION -->
          <div class="screen" id="scr_noPerm">
            <div class="h1">Дверь закрыта.</div>
            <div class="sub">Без разрешения на геолокацию<br>зал не открывается.</div>
            <div style="display:flex;gap:10px;margin-top:10px;">
              <button class="btn primary" id="btnNoPermRetry">Попробовать снова</button>
              <button class="btn" id="btnNoPermBack">Назад</button>
            </div>
          </div>

          <!-- GEO ERROR -->
          <div class="screen" id="scr_geoErr">
            <div class="h1">Тишина.</div>
            <div class="sub">Устройство молчит.<br>Сегодня — без этого.</div>
            <button class="btn primary" id="btnGeoErrRetry">Ещё раз</button>
            <button class="btn" id="btnGeoErrBack" style="margin-top:10px;">Назад</button>
          </div>

          <!-- WELCOME -->
          <div class="screen" id="scr_welcome">
            <div class="h1">Прежде чем мы начнём.</div>
            <div class="sub">
              Здесь не подбирают вкус.<br><br>
              Здесь фиксируют момент.<br><br>
              То, что вы получите,<br>не существует заранее.
            </div>
            <div style="height:1px;background:linear-gradient(90deg,transparent,rgba(240,214,150,.22),transparent);margin:12px 0;"></div>
            <button class="btn primary" id="btnStartCourse">Создать момент</button>
            <button class="btn" id="btnGoCabinet" style="margin-top:10px;background:rgba(0,0,0,.16);">В кабинет</button>
          </div>

          <!-- COURSE -->
          <div class="screen" id="scr_course">
            <div class="h1" id="qTitle">THE MENU</div>
            <div class="sub" id="qText">К какому цвету тянется рука сейчас?</div>
            <div id="qOptions"></div>

            <div style="display:flex;gap:10px;margin-top:10px;">
              <button class="btn" id="btnQBack" style="background:rgba(0,0,0,.16);">Назад</button>
              <button class="btn" id="btnQAbort">В кабинет</button>
            </div>
          </div>

          <!-- WAIT -->
          <div class="screen" id="scr_wait">
            <div class="gate" style="min-height:420px;">
              <div style="width:100%;text-align:center;">
                <div class="h1" id="waitTitle">Процесс идёт.</div>
                <div class="sub" id="waitSub">Не вмешивайтесь.</div>

                <div style="margin:14px auto 8px;width:92px;height:120px;position:relative;">
                  <div style="position:absolute;inset:0;border-radius:26px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);"></div>
                  <div style="position:absolute;left:16px;right:16px;top:14px;bottom:14px;border-radius:18px;border:1px solid rgba(255,255,255,.08);overflow:hidden;background:rgba(0,0,0,.10);">
                    <div id="hgTop" style="position:absolute;left:10px;right:10px;top:10px;height:48%;border-radius:14px;background:linear-gradient(180deg, rgba(240,214,150,.78), rgba(186,118,48,.36));"></div>
                    <div style="position:absolute;left:50%;top:50%;width:2px;height:46px;transform:translate(-50%,-50%);background:rgba(240,214,150,.62);opacity:.75;"></div>
                    <div id="hgBottom" style="position:absolute;left:10px;right:10px;bottom:10px;height:0%;border-radius:14px;background:linear-gradient(180deg, rgba(240,214,150,.78), rgba(186,118,48,.36));"></div>
                  </div>
                </div>

                <div id="waitTimer" style="font-family:'Cinzel',serif;font-size:32px;letter-spacing:.14em;font-weight:900;margin:8px 0 6px;">
                  —:—
                </div>

                <div class="sub" id="waitHint" style="font-size:13px;opacity:.75;">
                  Время начнётся, когда кухня подтвердит.
                </div>

                <button class="btn primary" id="btnWaitCab" style="margin-top:12px;">В кабинет</button>
              </div>
            </div>
          </div>

          <!-- CABINET -->
          <div class="screen" id="scr_cabinet">
            <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:10px;">
              <div>
                <div class="brand" style="margin-bottom:10px;">
                  <span class="dot"></span><span>THE MENU</span>
                </div>
                <div style="font-family:'Cinzel',serif;font-size:20px;font-weight:900;" id="cabName">Гость</div>
                <div style="font-size:14px;color:rgba(255,255,255,.62);margin-top:4px;" id="cabMeta">Моментов: 0 · Оценок: 0</div>
              </div>
              <button class="iconBtn" id="musicBtn2" title="Музыка" style="margin-top:6px;">♫</button>
            </div>

            <div style="display:none;" id="cabNowCard">
              <div style="padding:12px;border-radius:18px;border:1px solid rgba(240,214,150,.12);background:rgba(0,0,0,.18);">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                  <div>
                    <div style="font-family:'Cinzel',serif;font-weight:900;font-size:16px;">Сейчас</div>
                    <div style="font-size:12px;color:rgba(255,255,255,.56);line-height:1.45;" id="cabNowText">Процесс уже начался. Не вмешивайтесь.</div>
                  </div>
                  <span style="font-size:11px;padding:7px 12px;border-radius:999px;border:1px solid rgba(240,214,150,.26);background:rgba(0,0,0,.18);letter-spacing:.18em;font-family:'Cinzel',serif;" id="cabNowState">…</span>
                </div>

                <div style="display:flex;gap:10px;margin-top:10px;">
                  <button class="btn primary" id="btnCabToWait">Вернуться</button>
                  <button class="btn" id="btnCabOpenNow">Открыть</button>
                </div>
              </div>
            </div>

            <div style="font-family:'Cinzel',serif;font-size:12px;letter-spacing:.22em;text-transform:uppercase;color:rgba(255,255,255,.58);margin:12px 0 8px;">
              Последние моменты
            </div>
            <div id="cabLast"></div>

            <div style="display:flex;gap:10px;margin-top:10px;">
              <button class="btn" id="btnOpenArchive">Архив</button>
              <button class="btn primary" id="btnNewMoment">Создать</button>
            </div>

            <div style="font-family:'Cinzel',serif;font-size:12px;letter-spacing:.22em;text-transform:uppercase;color:rgba(255,255,255,.58);margin:12px 0 8px;">
              Знаки
            </div>
            <div id="cabAch" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"></div>

            <div class="sub" style="font-size:12px;opacity:.7;margin-top:10px;text-align:center;">
              Оценка — это не вкус. Это след.
            </div>
          </div>

          <!-- ARCHIVE -->
          <div class="screen" id="scr_archive">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
              <div class="h1" style="margin:0;">Архив</div>
              <span class="btn" style="width:auto;padding:7px 12px;border-radius:999px;font-size:12px;" id="archCount">0</span>
            </div>
            <div class="sub">Здесь лежат моменты, которые уже случились.</div>
            <div id="archList"></div>
            <button class="btn" id="btnArchBack">Назад</button>
          </div>

          <!-- MOMENT -->
          <div class="screen" id="scr_moment">
            <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;">
              <div>
                <div class="h1" id="mTitle" style="margin:0;">Момент</div>
                <div class="sub" id="mDate" style="font-size:12px;opacity:.7;margin-top:6px;">—</div>
              </div>
              <span class="btn primary" style="width:auto;padding:7px 12px;border-radius:999px;font-size:12px;" id="mStatus">…</span>
            </div>

            <div style="height:1px;background:linear-gradient(90deg,transparent,rgba(240,214,150,.22),transparent);margin:12px 0;"></div>

            <div id="mBody"></div>

            <div style="margin-top:10px;padding:12px;border-radius:18px;border:1px solid rgba(240,214,150,.12);background:rgba(0,0,0,.18);">
              <div style="font-family:'Cinzel',serif;font-weight:900;font-size:14px;margin-bottom:6px;">Жест</div>
              <div class="sub" style="font-size:12px;opacity:.7;margin-bottom:10px;">Не вкус. Не табак. Результат момента.</div>

              <div style="display:flex;gap:10px;">
                <button class="btn" id="rateBad">Слабо</button>
                <button class="btn" id="rateOk">Честно</button>
                <button class="btn primary" id="ratePerfect">Идеально</button>
              </div>

              <button class="btn" id="btnTip" style="margin-top:10px;background:rgba(0,0,0,.16);">Оставить жест</button>
            </div>

            <button class="btn" id="btnMomentBack" style="margin-top:10px;">Назад</button>
          </div>

          <!-- MASTER -->
          <div class="screen" id="scr_master">
            <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;">
              <div>
                <div style="font-family:'Cinzel',serif;font-size:18px;font-weight:900;">Кухня</div>
                <div class="sub" style="font-size:13px;opacity:.75;margin-top:4px;">Здесь не “заказы”. Здесь — моменты.</div>
              </div>
              <span class="btn" style="width:auto;padding:7px 12px;border-radius:999px;font-size:12px;" id="kCount">…</span>
            </div>

            <div id="kList" style="margin-top:10px;"></div>

            <button class="btn" id="btnKRefresh">Обновить</button>
            <div class="sub" style="font-size:12px;opacity:.7;margin-top:8px;">
              Песок у гостя начнётся, когда вы нажмёте “Кухня услышала”.
            </div>
          </div>

        </div><!-- /content -->

      </div><!-- /panel -->
    </div><!-- /book -->
  </div><!-- /app -->

  <audio id="bgMusic" src="./7441574b62bac5e.mp3" loop preload="auto"></audio>
  <script>
/* =========================
   CONFIG
   ========================= */
const BACKEND_BASE = "https://hookah-mix-bot-56x5.onrender.com";
const MASTER_ID = 1292778768;

const TIP_URL = "https://netmonet.co/qr/192937/tip?o=6";
const DURATION_MS = 25 * 60 * 1000;
const MUSIC_VOLUME = 0.30;

// гео (оставил как было)
const GEOFENCE = { lat: 56.482707, lon: 84.952464, radiusM: 40 };
const GEO_TTL_MS = 2 * 60 * 60 * 1000;

const tg = window.Telegram?.WebApp;
const tgUser = tg?.initDataUnsafe?.user || null;
const isMaster = !!(tgUser && tgUser.id === MASTER_ID);

const guest = {
  id: tgUser?.id,
  name: tgUser?.first_name || "Гость",
  username: tgUser?.username || ""
};

const LS_MOMENT_IDS = "hm_moment_ids";
const LS_GEO_UNTIL = "hm_geo_until";
const LS_MUSIC_ON = "hm_music_on";

const $ = (id)=>document.getElementById(id);

function escapeHtml(str=""){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* Screens */
const screens = [
  "scr_gate","scr_door","scr_outside","scr_noPerm","scr_geoErr",
  "scr_welcome","scr_course","scr_wait",
  "scr_cabinet","scr_archive","scr_moment",
  "scr_master"
];

function go(id){
  screens.forEach(s=>{
    const el = $(s);
    if(!el) return;
    el.classList.remove("active");
  });
  $(id)?.classList.add("active");
}

/* Haptics */
function tap(){
  try{ tg?.HapticFeedback?.impactOccurred("light"); }catch{}
}

/* MUSIC */
const audioEl = $("bgMusic");
const musicBtn = $("musicBtn");
const musicBtn2 = $("musicBtn2");

function setMusicBtn(on){
  musicBtn?.classList.toggle("on", !!on);
  musicBtn2?.classList.toggle("on", !!on);
}

async function playMusic(){
  try{
    audioEl.volume = MUSIC_VOLUME;
    await audioEl.play();
    localStorage.setItem(LS_MUSIC_ON,"1");
    setMusicBtn(true);
    tap();
  }catch(e){
    localStorage.setItem(LS_MUSIC_ON,"0");
    setMusicBtn(false);
  }
}

function pauseMusic(){
  try{ audioEl.pause(); }catch{}
  localStorage.setItem(LS_MUSIC_ON,"0");
  setMusicBtn(false);
  tap();
}

function toggleMusic(){
  if(!audioEl) return;
  if(audioEl.paused) playMusic();
  else pauseMusic();
}

musicBtn?.addEventListener("click", toggleMusic);
musicBtn2?.addEventListener("click", toggleMusic);

/* GEO */
function distanceMeters(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const toRad = v => v * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

function isInsideFence(lat, lon){
  return distanceMeters(lat, lon, GEOFENCE.lat, GEOFENCE.lon) <= GEOFENCE.radiusM;
}

function requestLocation(){
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation) return reject(new Error("no_geolocation"));
    navigator.geolocation.getCurrentPosition(
      (pos)=>resolve({lat:pos.coords.latitude, lon:pos.coords.longitude, accuracy:pos.coords.accuracy}),
      (err)=>reject(err),
      { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
    );
  });
}

function setGeoAccessUntil(ts){ localStorage.setItem(LS_GEO_UNTIL, String(ts)); }
function hasGeoAccessNow(){ return Date.now() < Number(localStorage.getItem(LS_GEO_UNTIL)||0); }

/* STORAGE */
function getMomentIds(){
  try{ return JSON.parse(localStorage.getItem(LS_MOMENT_IDS)||"[]"); }catch{ return []; }
}

function addMomentId(id){
  const ids = getMomentIds();
  if(!ids.includes(id)) ids.push(id);
  localStorage.setItem(LS_MOMENT_IDS, JSON.stringify(ids));
  return ids;
}

/* API */
async function safeJson(r){
  const t = await r.text();
  try{ return JSON.parse(t); }catch{ return { ok:false, raw:t }; }
}

async function apiGetMoments(limit=200){
  const r = await fetch(`${BACKEND_BASE}/moments?limit=${limit}`);
  const data = await safeJson(r);
  if(!r.ok) throw new Error("getMoments failed");
  return data;
}

async function apiCreateMoment(m){
  const r = await fetch(`${BACKEND_BASE}/moment`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(m)
  });
  const data = await safeJson(r);
  if(!r.ok) throw new Error("createMoment failed");
  return data;
}

async function apiSetStatus(id,status){
  const r = await fetch(`${BACKEND_BASE}/moment/${id}/status`,{
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({status})
  });
  const data = await safeJson(r);
  if(!r.ok) throw new Error("setStatus failed");
  return data;
}

async function apiSetRating(id,rating){
  const r = await fetch(`${BACKEND_BASE}/moment/${id}/rating`,{
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({rating})
  });
  const data = await safeJson(r);
  if(!r.ok) throw new Error("setRating failed");
  return data;
}

/* QUESTIONS */
const QUESTIONS = [
  { title:"THE MENU", text:"К какому цвету тянется рука сейчас?", options:["Тень","Свет","Пепел","Медь","Холод"] },
  { title:"Касание.", text:"Ощущение в пространстве —", options:["Почти вплотную","На расстоянии","Воздушно","Тяжело"] },
  { title:"Пауза.", text:"Если сделать паузу —", options:["Орех","Фрукт","Хлеб","Ничего"] },
  { title:"Скорость.", text:"Это время хочется прожить —", options:["Медленно","Рывками","Ровно","Не чувствуя времени"] },
  { title:"Материал.", text:"Ближе к чему?", options:["Бархат","Металл","Дерево","Стекло"] },
  { title:"Температура.", text:"Это должно быть —", options:["Холод","Тепло","Контраст","Без температуры"] },
  { title:"Запрет.", text:"Что сегодня нельзя впускать?", options:["Цитрус","Ягоды","Десерт","Тяжёлые специи","Мята"] },
  { title:"Вес.", text:"Финальное ощущение —", options:["Легко","Ровно","Плотно","Тяжело"] },
];

const EPITHETS = ["Холод Тень","Строгая Сцена","Тёмная Линия","Тяжёлая Привычка","Сухая Тишина","Нервная Комната","Белый Шум","Медный Пепел"];
function randomEpithet(){ return EPITHETS[Math.floor(Math.random()*EPITHETS.length)]; }

/* COURSE STATE */
let qIndex = 0;
let answers = {};
let openMomentId = null;
let waitPoll = null;

function renderQuestion(){
  const q = QUESTIONS[qIndex];
  $("qTitle").textContent = q.title;
  $("qText").textContent = q.text;

  const box = $("qOptions");
  box.innerHTML = "";

  q.options.forEach(opt=>{
    const div = document.createElement("div");
    div.className = "btn";
    div.style.marginTop = "10px";
    div.style.background = "rgba(0,0,0,.16)";
    div.style.border = "1px solid rgba(240,214,150,.12)";
    div.textContent = opt;
    div.onclick = ()=>{ tap(); pickAnswer(opt); };
    box.appendChild(div);
  });
}

async function pickAnswer(v){
  answers[String(qIndex+1)] = v;
  qIndex++;

  if(qIndex < QUESTIONS.length){
    renderQuestion();
    return;
  }
  await createMoment();
}

async function createMoment(){
  const id = Date.now()+"_"+Math.random().toString(36).slice(2,6);
  const m = {
    id,
    createdAt: Date.now(),
    status: "new",
    acceptedAt: null,
    rating: null,
    epithet: randomEpithet(),
    guest,
    answers
  };

  addMomentId(id);
  go("scr_wait");
  startWaitingLoop();

  try{ await apiCreateMoment(m); }catch(e){}
}

/* WAITING */
function fmt(ms){
  if(ms == null) return "—:—";
  const t = Math.max(0, Math.floor(ms/1000));
  const m = Math.floor(t/60);
  const s = t%60;
  return `${m}:${String(s).padStart(2,"0")}`;
}

function setHourglassProgress(p01){
  const p = Math.max(0, Math.min(1, p01));
  const top = $("hgTop");
  const bot = $("hgBottom");
  if(!top || !bot) return;

  const topH = 48 - (44*p);
  const botH = 48 * p;

  top.style.height = `${topH}%`;
  bot.style.height = `${botH}%`;
}

async function startWaitingLoop(){
  if(waitPoll) clearInterval(waitPoll);

  async function tick(){
    try{
      const ids = getMomentIds();
      const data = await apiGetMoments(250);

      const mine = (data.moments||[])
        .filter(m=>ids.includes(m.id))
        .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

      const active = mine.find(m=>m.status !== "finished") || null;

      if(!active){
        await renderCabinet();
        go("scr_cabinet");
        return;
      }

      if(!active.acceptedAt){
        $("waitTitle").textContent = "Процесс идёт.";
        $("waitSub").textContent = "Не вмешивайтесь.";
        $("waitTimer").textContent = "—:—";
        $("waitHint").textContent = "Время начнётся, когда кухня подтвердит.";
        setHourglassProgress(0);
        openMomentId = active.id;
        return;
      }

      const left = (active.acceptedAt + DURATION_MS) - Date.now();
      const progress = 1 - (left / DURATION_MS);

      if(left <= 0 || active.status === "finished"){
        $("waitTitle").textContent = "Момент случился.";
        $("waitSub").textContent = "Дальше — без интерфейса.";
        $("waitTimer").textContent = "Готово";
        $("waitHint").textContent = "Откройте момент в кабинете.";
        setHourglassProgress(1);
        openMomentId = active.id;
        return;
      }

      $("waitTitle").textContent = "Процесс идёт.";
      $("waitSub").textContent = "Не вмешивайтесь.";
      $("waitTimer").textContent = fmt(left);
      $("waitHint").textContent = "Песок идёт.";
      setHourglassProgress(progress);
      openMomentId = active.id;

    }catch(e){
      $("waitHint").textContent = "Нет связи.";
    }
  }

  await tick();
  waitPoll = setInterval(tick, 2000);
}

function calcAchievements(moments){
  const sessions = moments.length;
  const rated = moments.filter(m=>!!m.rating).length;

  return [
    { key:"first", t:"Первый момент", d:"Вы вошли.", ok:sessions>=1 },
    { key:"return", t:"Возвращение", d:"Вы вернулись.", ok:sessions>=2 },
    { key:"honest", t:"Честность", d:"Вы оценили три.", ok:rated>=3 }
  ];
}

/* CABINET */
async function renderCabinet(){
  $("cabName").textContent = guest.name;

  const ids = getMomentIds();
  const lastBox = $("cabLast");
  const achBox = $("cabAch");
  lastBox.innerHTML = "";
  achBox.innerHTML = "";

  try{
    const data = await apiGetMoments(250);
    const mine = (data.moments||[])
      .filter(m=>ids.includes(m.id))
      .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

    const rated = mine.filter(m=>!!m.rating).length;
    $("cabMeta").textContent = `Моментов: ${mine.length} · Оценок: ${rated}`;

    const active = mine.find(m=>m.status !== "finished") || null;
    if(active){
      $("cabNowCard").style.display = "block";
      $("cabNowState").textContent = active.acceptedAt ? "В ПРОЦЕССЕ" : "НОВЫЙ";
      $("cabNowText").textContent = active.acceptedAt
        ? "Процесс уже начался. Не вмешивайтесь."
        : "Песок ещё не запущен.";
      openMomentId = active.id;
    }else{
      $("cabNowCard").style.display = "none";
    }

    const last = mine.slice(0,3);
    if(!last.length){
      lastBox.innerHTML = `<div class="sub" style="font-size:12px;opacity:.7;">Пока пусто. Но зал уже здесь.</div>`;
    }else{
      last.forEach(m=>{
        const badge = (m.status==="finished")
          ? "СЛУЧИЛСЯ"
          : (m.acceptedAt ? "В ПРОЦЕССЕ" : "НОВЫЙ");

        lastBox.innerHTML += `
          <div style="padding:12px;border-radius:18px;border:1px solid rgba(240,214,150,.12);background:rgba(0,0,0,.18);margin-top:10px;">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
              <div>
                <div style="font-family:'Cinzel',serif;font-weight:900;font-size:16px;">${escapeHtml(m.epithet||"Момент")}</div>
                <div style="font-size:12px;color:rgba(255,255,255,.56);margin-top:4px;">${new Date(m.createdAt||Date.now()).toLocaleString("ru-RU")}</div>
              </div>
              <span style="font-size:11px;padding:7px 12px;border-radius:999px;border:1px solid rgba(240,214,150,.26);background:rgba(0,0,0,.18);letter-spacing:.18em;font-family:'Cinzel',serif;">
                ${escapeHtml(badge)}
              </span>
            </div>
            <button class="btn primary" style="margin-top:10px;" onclick="tap(); openMoment('${escapeHtml(m.id)}')">Открыть</button>
          </div>
        `;
      });
    }

    const ach = calcAchievements(mine);
    ach.forEach(a=>{
      achBox.innerHTML += `
        <div style="padding:12px;border-radius:18px;border:1px solid rgba(240,214,150,.12);background:rgba(0,0,0,.18);opacity:${a.ok?1:.35};">
          <div style="font-family:'Cinzel',serif;font-weight:900;font-size:13px;">${escapeHtml(a.t)}</div>
          <div style="font-size:12px;color:rgba(255,255,255,.56);margin-top:4px;">${escapeHtml(a.d)}</div>
        </div>
      `;
    });

  }catch(e){
    $("cabMeta").textContent = "Нет связи.";
    lastBox.innerHTML = `<div class="sub" style="font-size:12px;opacity:.7;">Нет связи.</div>`;
  }
}

/* ARCHIVE */
async function renderArchive(){
  const ids = getMomentIds();
  const box = $("archList");
  box.innerHTML = "";

  try{
    const data = await apiGetMoments(250);
    const mine = (data.moments||[])
      .filter(m=>ids.includes(m.id))
      .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

    $("archCount").textContent = String(mine.length);

    if(!mine.length){
      box.innerHTML = `<div class="sub" style="font-size:12px;opacity:.7;">Архив пуст.</div>`;
      return;
    }

    mine.forEach(m=>{
      const mark = m.rating ? "ОЦЕНЕНО" : "БЕЗ ОЦЕНКИ";
      box.innerHTML += `
        <div style="padding:12px;border-radius:18px;border:1px solid rgba(240,214,150,.12);background:rgba(0,0,0,.18);margin-top:10px;">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <div>
              <div style="font-family:'Cinzel',serif;font-weight:900;font-size:16px;">${escapeHtml(m.epithet||"Момент")}</div>
              <div style="font-size:12px;color:rgba(255,255,255,.56);margin-top:4px;">${new Date(m.createdAt||Date.now()).toLocaleString("ru-RU")}</div>
            </div>
            <span style="font-size:11px;padding:7px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);letter-spacing:.18em;font-family:'Cinzel',serif;">
              ${escapeHtml(mark)}
            </span>
          </div>
          <button class="btn primary" style="margin-top:10px;" onclick="tap(); openMoment('${escapeHtml(m.id)}')">Открыть</button>
        </div>
      `;
    });

  }catch(e){
    box.innerHTML = `<div class="sub" style="font-size:12px;opacity:.7;">Нет связи.</div>`;
  }
}

/* MOMENT OPEN */
window.openMoment = async function(id){
  openMomentId = id;
  go("scr_moment");
  await renderMoment();
};

async function renderMoment(){
  const id = openMomentId;
  if(!id){
    $("mTitle").textContent = "Недоступно";
    $("mDate").textContent = "—";
    $("mStatus").textContent = "—";
    $("mBody").innerHTML = "";
    return;
  }

  try{
    const data = await apiGetMoments(250);
    const m = (data.moments||[]).find(x=>String(x.id)===String(id));
    if(!m) return;

    $("mTitle").textContent = m.epithet || "Момент";
    $("mDate").textContent = new Date(m.createdAt||Date.now()).toLocaleString("ru-RU");
    $("mStatus").textContent = (m.status==="finished") ? "СЛУЧИЛСЯ" : (m.acceptedAt ? "В ПРОЦЕССЕ" : "НОВЫЙ");

    const ans = m.answers || {};
    const lines = Object.keys(ans)
      .sort((a,b)=>Number(a)-Number(b))
      .map(k=>`<div style="font-size:12px;color:rgba(255,255,255,.70);line-height:1.45;margin-top:6px;"><b>q${escapeHtml(k)}:</b> ${escapeHtml(ans[k])}</div>`)
      .join("");

    $("mBody").innerHTML = `
      <div style="padding:12px;border-radius:18px;border:1px solid rgba(240,214,150,.12);background:rgba(0,0,0,.18);">
        <div style="font-family:'Cinzel',serif;font-weight:900;font-size:14px;margin-bottom:6px;">Условия</div>
        ${lines || `<div style="font-size:12px;color:rgba(255,255,255,.56);">—</div>`}
      </div>
    `;
  }catch(e){
    $("mBody").innerHTML = `<div class="sub" style="font-size:12px;opacity:.7;">Нет связи.</div>`;
  }
}

/* MASTER */
async function renderKitchen(){
  const list = $("kList");
  list.innerHTML = "";

  try{
    const data = await apiGetMoments(250);
    const arr = (data.moments||[]).slice().sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    $("kCount").textContent = String(arr.length);

    if(!arr.length){
      list.innerHTML = `<div class="sub" style="font-size:12px;opacity:.7;">Нет активных моментов.</div>`;
      return;
    }

    arr.forEach(m=>{
      const badge = (m.status==="finished") ? "СЛУЧИЛСЯ" : (m.acceptedAt ? "В ПРОЦЕССЕ" : "НОВЫЙ");
      list.innerHTML += `
        <div style="padding:12px;border-radius:18px;border:1px solid rgba(240,214,150,.12);background:rgba(0,0,0,.18);margin-top:10px;">
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;">
            <div>
              <div style="font-family:'Cinzel',serif;font-weight:900;font-size:16px;">${escapeHtml(m.guest?.name || "Гость")}</div>
              <div style="font-size:12px;color:rgba(255,255,255,.56);margin-top:4px;">${new Date(m.createdAt||Date.now()).toLocaleString("ru-RU")}</div>
              <div style="font-size:12px;color:rgba(255,255,255,.56);margin-top:6px;">Песок: ${m.acceptedAt ? "идёт" : "ещё не запущен"}</div>
            </div>
            <span style="font-size:11px;padding:7px 12px;border-radius:999px;border:1px solid rgba(240,214,150,.26);background:rgba(0,0,0,.18);letter-spacing:.18em;font-family:'Cinzel',serif;">
              ${escapeHtml(badge)}
            </span>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
            <button class="btn primary" onclick="tap(); kSet('${escapeHtml(m.id)}','accepted')">Кухня услышала</button>
            <button class="btn" onclick="tap(); kSet('${escapeHtml(m.id)}','in_progress')">Печь работает</button>
            <button class="btn" onclick="tap(); kSet('${escapeHtml(m.id)}','serving')">Подача</button>
            <button class="btn" onclick="tap(); kSet('${escapeHtml(m.id)}','finished')">Момент случился</button>
          </div>
        </div>
      `;
    });

  }catch(e){
    $("kCount").textContent = "нет связи";
    list.innerHTML = `<div class="sub" style="font-size:12px;opacity:.7;">Нет связи.</div>`;
  }
}

window.kSet = async function(id,status){
  try{
    await apiSetStatus(id,status);
    await renderKitchen();
  }catch(e){}
};

/* DOOR FLOW */
async function openDoor(){
  tap();
  try{
    const pos = await requestLocation();
    const ok = isInsideFence(pos.lat, pos.lon);

    if(!ok){
      go("scr_outside");
      return;
    }

    setGeoAccessUntil(Date.now()+GEO_TTL_MS);
    go("scr_gate");
  }catch(e){
    if(e && e.code === 1){
      go("scr_noPerm");
    }else{
      go("scr_geoErr");
    }
  }
}

/* BUTTONS */
$("sealBtn")?.addEventListener("click", async ()=>{
  await playMusic();
  go("scr_welcome");
});

$("btnDoor")?.addEventListener("click", openDoor);
$("btnDoorHelp")?.addEventListener("click", ()=>{
  tap();
  alert("Если гео не отдаётся: попробуйте открыть мини-апп в Telegram и дать доступ к геолокации в настройках iOS. Если устройство молчит — сегодня без этого.");
});

$("btnOutsideRetry")?.addEventListener("click", openDoor);
$("btnOutsideBack")?.addEventListener("click", ()=>{ tap(); go("scr_door"); });

$("btnNoPermRetry")?.addEventListener("click", openDoor);
$("btnNoPermBack")?.addEventListener("click", ()=>{ tap(); go("scr_door"); });

$("btnGeoErrRetry")?.addEventListener("click", openDoor);
$("btnGeoErrBack")?.addEventListener("click", ()=>{ tap(); go("scr_door"); });

$("btnStartCourse")?.addEventListener("click", ()=>{
  tap();
  qIndex = 0;
  answers = {};
  go("scr_course");
  renderQuestion();
});

$("btnGoCabinet")?.addEventListener("click", async ()=>{
  tap();
  await renderCabinet();
  go("scr_cabinet");
});

$("btnQBack")?.addEventListener("click", ()=>{
  tap();
  if(qIndex<=0){ go("scr_welcome"); return; }
  qIndex = Math.max(0, qIndex-1);
  delete answers[String(qIndex+1)];
  renderQuestion();
});

$("btnQAbort")?.addEventListener("click", async ()=>{
  tap();
  await renderCabinet();
  go("scr_cabinet");
});

$("btnWaitCab")?.addEventListener("click", async ()=>{
  tap();
  await renderCabinet();
  go("scr_cabinet");
});

$("btnCabToWait")?.addEventListener("click", ()=>{
  tap();
  go("scr_wait");
  startWaitingLoop();
});

$("btnCabOpenNow")?.addEventListener("click", async ()=>{
  tap();
  if(!openMomentId){ return; }
  await window.openMoment(openMomentId);
});

$("btnOpenArchive")?.addEventListener("click", async ()=>{
  tap();
  await renderArchive();
  go("scr_archive");
});

$("btnNewMoment")?.addEventListener("click", ()=>{
  tap();
  qIndex = 0;
  answers = {};
  go("scr_course");
  renderQuestion();
});

$("btnArchBack")?.addEventListener("click", async ()=>{
  tap();
  await renderCabinet();
  go("scr_cabinet");
});

$("btnMomentBack")?.addEventListener("click", async ()=>{
  tap();
  await renderCabinet();
  go("scr_cabinet");
});

$("btnTip")?.addEventListener("click", ()=>{ tap(); window.open(TIP_URL, "_blank"); });

$("rateBad")?.addEventListener("click", async ()=>{
  tap();
  if(!openMomentId) return;
  try{ await apiSetRating(openMomentId,"bad"); }catch{}
  alert("Запомнил.");
});

$("rateOk")?.addEventListener("click", async ()=>{
  tap();
  if(!openMomentId) return;
  try{ await apiSetRating(openMomentId,"ok"); }catch{}
  alert("Запомнил.");
});

$("ratePerfect")?.addEventListener("click", async ()=>{
  tap();
  if(!openMomentId) return;
  try{ await apiSetRating(openMomentId,"perfect"); }catch{}
  alert("Запомнил.");
});

$("btnKRefresh")?.addEventListener("click", ()=>{ tap(); renderKitchen(); });

/* START */
document.addEventListener("DOMContentLoaded", async ()=>{
  try{ tg?.ready(); tg?.expand(); }catch{}

  const on = localStorage.getItem(LS_MUSIC_ON)==="1";
  setMusicBtn(on);

  if(isMaster){
    go("scr_master");
    await renderKitchen();
    setInterval(renderKitchen, 3000);
    return;
  }

  const ids = getMomentIds();
  const geoOk = hasGeoAccessNow();

  if(ids.length){
    await renderCabinet();
    go("scr_cabinet");
    return;
  }

  if(!geoOk){
    go("scr_door");
    return;
  }

  go("scr_gate");
});
</script>
</body>
</html>
