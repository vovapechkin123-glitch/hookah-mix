<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>THE MENU</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700;800&family=Cormorant+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  color-scheme: dark;

  --ink: rgba(255,255,255,.94);
  --muted: rgba(255,255,255,.70);
  --soft: rgba(255,255,255,.56);

  --brass1: rgba(231,194,122,1);
  --brass2: rgba(183,122,51,1);

  --stroke: rgba(255,230,190,.12);
  --stroke2: rgba(255,255,255,.08);

  --ease: cubic-bezier(.2,.9,.2,1);
  --r14: 14px;
  --r18: 18px;
  --r22: 22px;
  --r26: 26px;

  --safeTop: env(safe-area-inset-top, 0px);
  --safeBottom: env(safe-area-inset-bottom, 0px);
}

*{ box-sizing:border-box; }
html,body{ height:100%; }

body{
  margin:0;
  color:var(--ink);
  overflow:hidden;
  font-family: "Cormorant Garamond", ui-serif, Georgia, "Times New Roman", serif;

  /* üî• –≥–ª–∞–≤–Ω—ã–π —Ñ–æ–Ω ‚Äî bgg.jpg */
  background:
    radial-gradient(1400px 900px at 20% 10%, rgba(231,194,122,.10), transparent 60%),
    radial-gradient(1100px 800px at 85% 35%, rgba(183,122,51,.10), transparent 62%),
    radial-gradient(900px 700px at 40% 90%, rgba(0,0,0,.40), transparent 65%),
    url("./bgg.jpg") center/cover no-repeat fixed;
}

body::before{
  content:"";
  position:fixed;
  inset:0;
  z-index:0;
  pointer-events:none;
  background:
    radial-gradient(1200px 900px at 50% 42%, rgba(0,0,0,.15), rgba(0,0,0,.70) 72%, rgba(0,0,0,.92) 100%),
    linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,.28) 40%, rgba(0,0,0,.72));
}

/* –ª—ë–≥–∫–∏–π —à—É–º */
body::after{
  content:"";
  position:fixed;
  inset:0;
  z-index:0;
  pointer-events:none;
  opacity:.06;
  mix-blend-mode: overlay;
  background-image:
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.7' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.9'/%3E%3C/svg%3E");
}

#app{
  position:relative;
  z-index:1;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  padding: calc(16px + var(--safeTop)) 14px calc(16px + var(--safeBottom));
}

/* =========================
   BOOK FRAME (LEATHER)
   ========================= */
.frame{
  width:min(460px, 100%);
  border-radius: var(--r26);
  padding: 16px;

  /* üî• –æ–±–ª–æ–∂–∫–∞-–∫–æ–∂–∞ */
  background:
    radial-gradient(900px 500px at 30% 10%, rgba(231,194,122,.10), transparent 62%),
    radial-gradient(900px 600px at 70% 90%, rgba(183,122,51,.10), transparent 60%),
    url("./leather.jpg") center/cover no-repeat;

  border: 1px solid rgba(255,255,255,.10);

  box-shadow:
    0 34px 120px rgba(0,0,0,.72),
    0 10px 40px rgba(0,0,0,.55);

  overflow:hidden;
  animation: frameBreath 6.2s ease-in-out infinite;
}

@keyframes frameBreath{
  0%,100%{ transform: translateY(0); filter: brightness(1); }
  50%{ transform: translateY(-2px); filter: brightness(1.06); }
}

/* =========================
   PANEL (PAPER)
   ========================= */
.panel{
  border-radius: var(--r22);
  position:relative;
  overflow:hidden;

  /* üî• –±—É–º–∞–≥–∞ –≤–Ω—É—Ç—Ä–∏ */
  background:
    radial-gradient(900px 520px at 30% 10%, rgba(231,194,122,.12), transparent 62%),
    radial-gradient(860px 600px at 74% 92%, rgba(183,122,51,.10), transparent 60%),
    url("./paper.jpg") center/cover no-repeat;

  border: 1px solid rgba(255,230,190,.16);

  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.10),
    inset 0 -22px 50px rgba(0,0,0,.55),
    0 18px 70px rgba(0,0,0,.55);
}

/* –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±–æ—Ä–¥–µ—Ä */
.panel::before{
  content:"";
  position:absolute;
  inset: 12px;
  border-radius: var(--r18);
  border: 1px solid rgba(255,255,255,.10);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.08),
    inset 0 -18px 35px rgba(0,0,0,.42),
    0 0 0 1px rgba(231,194,122,.06);
  pointer-events:none;
  opacity:.98;
}

/* üî• –æ—Ä–Ω–∞–º–µ–Ω—Ç –ø–æ–≤–µ—Ä—Ö */
.panel::after{
  content:"";
  position:absolute;
  inset: 6px;
  pointer-events:none;
  background: url("./ornament.png") center/contain no-repeat;
  opacity:.88;
  filter: drop-shadow(0 10px 24px rgba(0,0,0,.55));
}

/* üî• –≤–∏–Ω—å–µ—Ç–∫–∞ + –ø—ã–ª—å */
.vignette{
  position:absolute;
  inset:0;
  pointer-events:none;
  background: url("./vignette.png") center/cover no-repeat;
  opacity:.75;
  mix-blend-mode: overlay;
  z-index:1;
}

/* üî• –∑–æ–ª–æ—Ç–æ–µ –∑–µ—Ä–Ω–æ –¥–ª—è –º–µ—Ç–∞–ª–ª–∞ */
.goldNoise{
  position:absolute;
  inset:0;
  pointer-events:none;
  background: url("./gold_noise.png") center/cover no-repeat;
  opacity:.12;
  mix-blend-mode: overlay;
  z-index:1;
}

.glow{
  position:absolute;
  inset:-120px;
  z-index:1;
  pointer-events:none;
  background:
    radial-gradient(560px 420px at 18% 12%, rgba(231,194,122,.16), transparent 62%),
    radial-gradient(560px 420px at 82% 88%, rgba(183,122,51,.14), transparent 62%),
    radial-gradient(900px 700px at 50% 50%, rgba(0,0,0,.18), transparent 62%);
  opacity:.55;
  filter: blur(18px);
  animation: glow 7.5s ease-in-out infinite;
}

@keyframes glow{
  0%,100%{ transform: translate3d(0,0,0); opacity:.48; }
  50%{ transform: translate3d(0,-8px,0); opacity:.76; }
}

/* =========================
   UI ELEMENTS
   ========================= */
.topbar{
  position:relative;
  z-index:3;
  padding: 14px 14px 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.brand{
  display:flex;
  align-items:center;
  gap:10px;
  letter-spacing:.22em;
  text-transform:uppercase;
  font-weight:700;
  font-size:12px;
  font-family: "Cinzel", serif;
  color: rgba(255,255,255,.78);
}

.brand .dot{
  width:7px;height:7px;border-radius:999px;
  background: rgba(231,194,122,.78);
  box-shadow: 0 0 0 4px rgba(231,194,122,.10);
}

.iconBtn{
  width:38px;height:38px;
  border-radius:999px;
  border: 1px solid rgba(255,255,255,.12);
  background:
    radial-gradient(120px 120px at 30% 20%, rgba(231,194,122,.14), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.22));
  color: rgba(255,255,255,.88);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
  transition: transform .14s var(--ease), border-color .14s var(--ease), box-shadow .14s var(--ease), opacity .14s var(--ease);
  user-select:none;
  position:relative;
  overflow:hidden;
}

.iconBtn::after{
  content:"";
  position:absolute;
  inset:0;
  background: url("./gold_noise.png") center/cover no-repeat;
  opacity:.12;
  mix-blend-mode: overlay;
  pointer-events:none;
}

.iconBtn:hover{ border-color: rgba(231,194,122,.26); }
.iconBtn:active{ transform: translateY(1px) scale(.98); }
.iconBtn.on{
  border-color: rgba(231,194,122,.30);
  box-shadow: 0 0 0 4px rgba(231,194,122,.12);
}

.content{
  position:relative;
  z-index:3;
  padding: 10px 14px 12px;
  max-height: calc(100vh - 160px);
  overflow:auto;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
}

.content::-webkit-scrollbar{ width:8px; }
.content::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.10); border-radius: 999px; }
.content::-webkit-scrollbar-track{ background: transparent; }

.bottombar{
  position:relative;
  z-index:3;
  padding: 10px 14px calc(12px + var(--safeBottom));
  display:flex;
  justify-content:space-between;
  gap:12px;
}

.tab{
  width:100%;
  padding: 14px 12px;
  border-radius: 18px;
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(520px 260px at 30% 10%, rgba(231,194,122,.08), transparent 58%),
    linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.22));
  color: rgba(255,255,255,.72);
  font-weight:800;
  font-size:12px;
  letter-spacing:.22em;
  text-transform:uppercase;
  font-family: "Cinzel", serif;
  cursor:pointer;
  transition: transform .14s var(--ease), background .14s var(--ease), border-color .14s var(--ease), color .14s var(--ease);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.06),
    inset 0 -18px 28px rgba(0,0,0,.34);
  position:relative;
  overflow:hidden;
}

.tab::after{
  content:"";
  position:absolute;
  inset:0;
  background: url("./gold_noise.png") center/cover no-repeat;
  opacity:.10;
  mix-blend-mode: overlay;
  pointer-events:none;
}

.tab:active{ transform: translateY(1px) scale(.99); }

.tab.active{
  background:
    radial-gradient(520px 260px at 30% 10%, rgba(231,194,122,.20), transparent 56%),
    linear-gradient(180deg, rgba(231,194,122,.12), rgba(0,0,0,.22));
  border-color: rgba(231,194,122,.22);
  color: rgba(255,255,255,.92);
}

.h1{
  font-family:"Cinzel", serif;
  font-size: 22px;
  margin:0 0 6px;
  letter-spacing:.03em;
  font-weight:800;
}

.sub{
  color: var(--muted);
  font-size: 14px;
  line-height:1.55;
  margin:0 0 10px;
}

.hr{
  height:1px;
  background: linear-gradient(90deg, transparent, rgba(231,194,122,.22), transparent);
  margin: 12px 0;
}

.card{
  background:
    radial-gradient(700px 320px at 20% 10%, rgba(231,194,122,.08), transparent 58%),
    linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.20));
  border:1px solid rgba(255,230,190,.10);
  border-radius: var(--r18);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.06),
    inset 0 -18px 34px rgba(0,0,0,.36);
  padding: 12px;
  position:relative;
  overflow:hidden;
}

.card::after{
  content:"";
  position:absolute;
  inset:0;
  background: url("./gold_noise.png") center/cover no-repeat;
  opacity:.06;
  mix-blend-mode: overlay;
  pointer-events:none;
}

.card + .card{ margin-top: 10px; }

.row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.badge{
  font-size:11px;
  padding: 7px 12px;
  border-radius: 999px;
  border:1px solid rgba(255,255,255,.10);
  background:
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
  color: rgba(255,255,255,.74);
  letter-spacing:.18em;
  text-transform:uppercase;
  font-family:"Cinzel", serif;
  position:relative;
  overflow:hidden;
}

.badge.brass{
  border-color: rgba(231,194,122,.26);
  background:
    radial-gradient(260px 160px at 30% 10%, rgba(231,194,122,.22), transparent 60%),
    linear-gradient(180deg, rgba(231,194,122,.12), rgba(0,0,0,.20));
  color: rgba(255,255,255,.92);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.08),
    inset 0 -18px 26px rgba(0,0,0,.26),
    0 10px 26px rgba(183,122,51,.10);
}

.badge.pulse{ animation: badgePulse 2.4s ease-in-out infinite; }
@keyframes badgePulse{ 0%,100%{ filter: brightness(1); } 50%{ filter: brightness(1.18); } }

.btn{
  width:100%;
  padding: 12px 12px;
  border-radius: 16px;
  border:1px solid rgba(255,255,255,.10);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.22));
  color: rgba(255,255,255,.88);
  cursor:pointer;
  font-weight:800;
  font-family:"Cinzel", serif;
  letter-spacing:.08em;
  transition: transform .14s var(--ease), border-color .14s var(--ease), box-shadow .14s var(--ease), filter .14s var(--ease);
  user-select:none;
  position:relative;
  overflow:hidden;
}

.btn::after{
  content:"";
  position:absolute;
  inset:0;
  background: url("./gold_noise.png") center/cover no-repeat;
  opacity:.10;
  mix-blend-mode: overlay;
  pointer-events:none;
}

.btn:hover{ border-color: rgba(231,194,122,.16); }
.btn:active{ transform: translateY(1px) scale(.99); }

.btn.primary{
  border-color: rgba(231,194,122,.22);
  background:
    radial-gradient(520px 260px at 30% 10%, rgba(231,194,122,.18), transparent 56%),
    linear-gradient(180deg, rgba(231,194,122,.12), rgba(0,0,0,.22));
  box-shadow: inset 0 1px 0 rgba(255,255,255,.06), 0 10px 26px rgba(183,122,51,.10);
}

.btn.ghost{ background: rgba(0,0,0,.14); }

.btnRow{ display:flex; gap:10px; margin-top:10px; }
.btnRow .btn{ width:100%; }

.option{
  padding: 12px 12px;
  border-radius: 16px;
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(480px 220px at 20% 20%, rgba(231,194,122,.10), transparent 58%),
    rgba(0,0,0,.18);
  cursor:pointer;
  transition: transform .14s var(--ease), border-color .14s var(--ease), filter .14s var(--ease);
  user-select:none;
  font-size: 16px;
  position:relative;
  overflow:hidden;
}

.option::after{
  content:"";
  position:absolute;
  inset:0;
  background: url("./gold_noise.png") center/cover no-repeat;
  opacity:.06;
  mix-blend-mode: overlay;
  pointer-events:none;
}

.option:hover{ border-color: rgba(231,194,122,.18); }
.option:active{ transform: translateY(1px) scale(.99); }
.option + .option{ margin-top: 10px; }

.small{ font-size:12px; color: var(--soft); line-height:1.45; }

.screen{ display:none; }
.screen.active{ display:block; }

.fadeIn{ animation: fadeIn .28s var(--ease) both; }
@keyframes fadeIn{
  from{ opacity:0; transform: translateY(10px); filter: blur(2px); }
  to{ opacity:1; transform: translateY(0); filter: blur(0); }
}

.gate{
  display:flex;
  align-items:center;
  justify-content:center;
  min-height: 420px;
  padding: 12px 6px 6px;
  text-align:center;
}

.seal{
  width: 98px;
  height: 98px;
  border-radius: 999px;
  display:flex;
  align-items:center;
  justify-content:center;
  margin: 10px auto 14px;
  cursor:pointer;
  user-select:none;

  background:
    radial-gradient(circle at 30% 30%, rgba(231,194,122,.96), rgba(183,122,51,.84));

  box-shadow:
    0 22px 70px rgba(183,122,51,.22),
    inset 0 1px 0 rgba(255,255,255,.14),
    inset 0 -18px 30px rgba(0,0,0,.28);

  border:1px solid rgba(255,255,255,.10);
  position:relative;
  transform: translateZ(0);
}

.seal::after{
  content:"";
  position:absolute;
  inset:-18px;
  border-radius:999px;
  background: radial-gradient(circle, rgba(231,194,122,.16), transparent 60%);
  opacity:.72;
  animation: pulse 2.8s ease-in-out infinite;
}

@keyframes pulse{
  0%,100%{ transform: scale(1); opacity:.62; }
  50%{ transform: scale(1.08); opacity:.92; }
}

.seal .note{
  font-size: 34px;
  font-weight: 900;
  transform: translateY(-1px);
  filter: drop-shadow(0 10px 22px rgba(0,0,0,.38));
  position:relative;
  z-index:1;
}

.profile{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 10px;
}

.name{
  font-family:"Cinzel", serif;
  font-size:20px;
  font-weight:800;
  letter-spacing:.02em;
}

.meta{
  font-size:14px;
  color: rgba(255,255,255,.62);
  margin-top:4px;
}

.sectionTitle{
  font-family:"Cinzel", serif;
  font-size:12px;
  letter-spacing:.22em;
  text-transform:uppercase;
  color: rgba(255,255,255,.58);
  margin: 12px 0 8px;
}

.momentTitle{
  font-family:"Cinzel", serif;
  font-weight:800;
  font-size:18px;
}

.momentDate{
  color: rgba(255,255,255,.56);
  font-size:13px;
  margin-top:4px;
}

.grid2{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}

.medal{
  position:relative;
  border-radius: 18px;
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(420px 240px at 20% 20%, rgba(231,194,122,.10), transparent 60%),
    radial-gradient(380px 260px at 80% 90%, rgba(183,122,51,.08), transparent 60%),
    rgba(0,0,0,.16);
  padding: 12px;
  min-height: 96px;
  overflow:hidden;
  transition: transform .16s var(--ease), border-color .16s var(--ease), filter .16s var(--ease);
  user-select:none;
  cursor:pointer;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.06),
    inset 0 -22px 38px rgba(0,0,0,.36);
}

.medal:active{ transform: translateY(1px) scale(.99); }
.medal:hover{ border-color: rgba(231,194,122,.18); }

.medal.lock{
  opacity:.36;
  filter: grayscale(.55) brightness(.82);
  cursor:default;
}

.medal .head{
  display:flex;
  align-items:center;
  gap:12px;
}

.medal .sealCoin{
  width:46px;
  height:46px;
  border-radius:999px;
  position:relative;
  flex:0 0 auto;
  border:1px solid rgba(255,255,255,.12);
  background:
    radial-gradient(circle at 30% 28%, rgba(231,194,122,.96), rgba(183,122,51,.58));
  box-shadow:
    0 14px 34px rgba(183,122,51,.18),
    inset 0 1px 0 rgba(255,255,255,.12),
    inset 0 -16px 18px rgba(0,0,0,.40);
}

.medal .t{
  font-family:"Cinzel", serif;
  font-weight:800;
  font-size:13px;
  margin-bottom:2px;
  letter-spacing:.06em;
}

.medal .d{
  font-size:13px;
  color: rgba(255,255,255,.60);
  line-height:1.35;
}

.tabsHint{
  font-size:12px;
  color: rgba(255,255,255,.52);
  margin-top:10px;
  text-align:center;
}

.waitCenter{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding: 8px 6px 2px;
  min-height: 420px;
}

.hourIcon{
  width: 92px;
  height: 120px;
  position:relative;
  margin: 12px auto 12px;
  filter: drop-shadow(0 16px 42px rgba(0,0,0,.48));
}

.hgFrame{
  position:absolute;
  inset:0;
  border-radius: 26px;
  border: 1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(300px 220px at 30% 20%, rgba(231,194,122,.10), transparent 60%),
    rgba(0,0,0,.20);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.06),
    inset 0 -22px 44px rgba(0,0,0,.38);
}

.hgGlass{
  position:absolute;
  left:16px; right:16px;
  top:14px; bottom:14px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.08);
  overflow:hidden;
  background: rgba(0,0,0,.10);
}

.hgTop, .hgBottom{
  position:absolute;
  left:10px; right:10px;
  border-radius: 14px;
  background: linear-gradient(180deg, rgba(231,194,122,.78), rgba(183,122,51,.36));
  box-shadow: 0 12px 36px rgba(183,122,51,.12);
}

.hgTop{ top: 10px; height: 48%; }
.hgBottom{ bottom: 10px; height: 0%; }

.hgStream{
  position:absolute;
  left:50%;
  top:50%;
  width:2px;
  height:46px;
  transform: translate(-50%,-50%);
  background: rgba(231,194,122,.62);
  opacity:.75;
  animation: stream 1.2s ease-in-out infinite;
}

@keyframes stream{
  0%,100%{ opacity:.50; }
  50%{ opacity:.94; }
}

.timer{
  font-family:"Cinzel", serif;
  font-size: 32px;
  letter-spacing:.14em;
  font-weight: 800;
  margin: 8px 0 6px;
  color: rgba(255,255,255,.92);
}

.lockLine{
  font-size:13px;
  color: rgba(255,255,255,.64);
  margin-top:6px;
}

.kitchenTitle{
  font-family:"Cinzel", serif;
  font-size:18px;
  font-weight:800;
}

.kitchenSub{
  color: rgba(255,255,255,.64);
  font-size:13px;
  margin-top:4px;
}

.kBtns{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  margin-top: 10px;
}

.kBtns .btn{
  padding: 11px 10px;
  font-size:12px;
  letter-spacing:.14em;
  text-transform:uppercase;
}

.miniNote{
  color: rgba(255,255,255,.55);
  font-size:12px;
  margin-top:8px;
}

a{ color: inherit; text-decoration:none; }

@media (min-width: 900px){
  #app{ padding: 40px 20px; }
  .frame{ transform: scale(1.08); transform-origin: center; }
}
</style>
</head>

<body>
<div id="app">
  <div class="frame">
    <div class="panel">
      <div class="glow"></div>
      <div class="goldNoise"></div>
      <div class="vignette"></div>

      <div class="topbar">
        <div class="brand">
          <span class="dot"></span>
          <span>THE MENU</span>
        </div>
        <button class="iconBtn" id="musicBtn" title="–ú—É–∑—ã–∫–∞">‚ô´</button>
      </div>

      <div class="content">
                <div class="screen active fadeIn" id="scr_gate">
          <div class="gate">
            <div>
              <div class="seal" id="sealBtn"><div class="note">‚ô´</div></div>
              <div class="h1">–í–∫–ª—é—á–∏—Ç–µ –∑–∞–ª.</div>
              <div class="sub">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–Ω–∞–∫.<br>–î–∞–ª—å—à–µ ‚Äî –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤.</div>
              <div class="small">–ì—Ä–æ–º–∫–æ—Å—Ç—å —É–∂–µ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∞: 30%.</div>
            </div>
          </div>
        </div>

        <div class="screen fadeIn" id="scr_door">
          <div class="h1">–û—Ç–∫—Ä—ã—Ç—å –¥–≤–µ—Ä—å.</div>
          <div class="sub">–≠—Ç–æ –≤—Ö–æ–¥ –Ω–µ –≤ –∑–∞–∫–∞–∑.<br>–≠—Ç–æ –≤—Ö–æ–¥ –≤ –ø—Ä–æ—Ü–µ—Å—Å.</div>
          <div class="hr"></div>
          <button class="btn primary" id="btnDoor">–û—Ç–∫—Ä—ã—Ç—å</button>
          <button class="btn ghost" id="btnDoorHelp">–Ø –Ω–µ –º–æ–≥—É –¥–∞—Ç—å –≥–µ–æ</button>
          <div class="tabsHint">–ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–ª—á–∏—Ç ‚Äî —Å–µ–≥–æ–¥–Ω—è –±–µ–∑ —ç—Ç–æ–≥–æ.</div>
        </div>

        <div class="screen fadeIn" id="scr_outside">
          <div class="h1">–°–Ω–∞—Ä—É–∂–∏.</div>
          <div class="sub">–°–µ–π—á–∞—Å —ç—Ç–æ –º–µ—Å—Ç–æ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∑–∞–ª–æ–º.<br>–í–µ—Ä–Ω–∏—Ç–µ—Å—å ‚Äî –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ.</div>
          <div class="btnRow">
            <button class="btn primary" id="btnOutsideRetry">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–Ω–æ–≤–∞</button>
            <button class="btn" id="btnOutsideBack">–ù–∞–∑–∞–¥</button>
          </div>
        </div>

        <div class="screen fadeIn" id="scr_noPerm">
          <div class="h1">–î–≤–µ—Ä—å –∑–∞–∫—Ä—ã—Ç–∞.</div>
          <div class="sub">–ë–µ–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é<br>–∑–∞–ª –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è.</div>
          <div class="btnRow">
            <button class="btn primary" id="btnNoPermRetry">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
            <button class="btn" id="btnNoPermBack">–ù–∞–∑–∞–¥</button>
          </div>
        </div>

        <div class="screen fadeIn" id="scr_geoErr">
          <div class="h1">–¢–∏—à–∏–Ω–∞.</div>
          <div class="sub">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–ª—á–∏—Ç.<br>–°–µ–≥–æ–¥–Ω—è ‚Äî –±–µ–∑ —ç—Ç–æ–≥–æ.</div>
          <button class="btn primary" id="btnGeoErrRetry">–ï—â—ë —Ä–∞–∑</button>
          <button class="btn" id="btnGeoErrBack">–ù–∞–∑–∞–¥</button>
        </div>

        <div class="screen fadeIn" id="scr_welcome">
          <div class="h1">–ü—Ä–µ–∂–¥–µ —á–µ–º –º—ã –Ω–∞—á–Ω—ë–º.</div>
          <div class="sub">
            –ó–¥–µ—Å—å –Ω–µ –ø–æ–¥–±–∏—Ä–∞—é—Ç –≤–∫—É—Å.<br><br>
            –ó–¥–µ—Å—å —Ñ–∏–∫—Å–∏—Ä—É—é—Ç –º–æ–º–µ–Ω—Ç.<br><br>
            –¢–æ, —á—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ,<br>–Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∑–∞—Ä–∞–Ω–µ–µ.
          </div>
          <div class="hr"></div>
          <button class="btn primary" id="btnStartCourse">–°–æ–∑–¥–∞—Ç—å –º–æ–º–µ–Ω—Ç</button>
          <button class="btn ghost" id="btnGoCabinet">–í –∫–∞–±–∏–Ω–µ—Ç</button>
        </div>

        <div class="screen fadeIn" id="scr_course">
          <div class="h1" id="qTitle">THE MENU</div>
          <div class="sub" id="qText">–ö –∫–∞–∫–æ–º—É —Ü–≤–µ—Ç—É —Ç—è–Ω–µ—Ç—Å—è —Ä—É–∫–∞ —Å–µ–π—á–∞—Å?</div>
          <div id="qOptions"></div>
          <div class="btnRow">
            <button class="btn ghost" id="btnQBack">–ù–∞–∑–∞–¥</button>
            <button class="btn" id="btnQAbort">–í –∫–∞–±–∏–Ω–µ—Ç</button>
          </div>
        </div>

        <div class="screen fadeIn" id="scr_wait">
          <div class="waitCenter">
            <div class="h1" id="waitTitle">–ü—Ä–æ—Ü–µ—Å—Å –∏–¥—ë—Ç.</div>
            <div class="sub" id="waitSub">–ù–µ –≤–º–µ—à–∏–≤–∞–π—Ç–µ—Å—å.</div>

            <div class="hourIcon" aria-hidden="true">
              <div class="hgFrame"></div>
              <div class="hgGlass">
                <div class="hgTop" id="hgTop"></div>
                <div class="hgStream"></div>
                <div class="hgBottom" id="hgBottom"></div>
              </div>
            </div>

            <div class="timer" id="waitTimer">‚Äî:‚Äî</div>
            <div class="lockLine" id="waitHint">–í—Ä–µ–º—è –Ω–∞—á–Ω—ë—Ç—Å—è, –∫–æ–≥–¥–∞ –∫—É—Ö–Ω—è –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç.</div>

            <button class="btn primary" id="btnWaitCab">–í –∫–∞–±–∏–Ω–µ—Ç</button>
          </div>
        </div>

        <div class="screen fadeIn" id="scr_cabinet">
          <div class="profile">
            <div>
              <div class="brand" style="margin-bottom:10px;">
                <span class="dot"></span><span>THE MENU</span>
              </div>
              <div class="name" id="cabName">–ì–æ—Å—Ç—å</div>
              <div class="meta" id="cabMeta">–ú–æ–º–µ–Ω—Ç–æ–≤: 0 ¬∑ –û—Ü–µ–Ω–æ–∫: 0</div>
            </div>
            <button class="iconBtn" id="musicBtn2" title="–ú—É–∑—ã–∫–∞" style="margin-top:6px;">‚ô´</button>
          </div>

          <div class="card" id="cabNowCard" style="display:none;">
            <div class="row">
              <div>
                <div class="momentTitle" style="font-size:16px;">–°–µ–π—á–∞—Å</div>
                <div class="small" id="cabNowText">–ü—Ä–æ—Ü–µ—Å—Å —É–∂–µ –Ω–∞—á–∞–ª—Å—è. –ù–µ –≤–º–µ—à–∏–≤–∞–π—Ç–µ—Å—å.</div>
              </div>
              <span class="badge brass pulse" id="cabNowState">‚Ä¶</span>
            </div>
            <div class="btnRow">
              <button class="btn primary" id="btnCabToWait">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–æ—Ü–µ—Å—Å—É</button>
              <button class="btn" id="btnCabOpenNow">–û—Ç–∫—Ä—ã—Ç—å</button>
            </div>
          </div>

          <div class="sectionTitle">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –º–æ–º–µ–Ω—Ç—ã</div>
          <div id="cabLast"></div>

          <div class="btnRow">
            <button class="btn" id="btnOpenArchive">–ê—Ä—Ö–∏–≤</button>
            <button class="btn primary" id="btnNewMoment">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –º–æ–º–µ–Ω—Ç</button>
          </div>

          <div class="sectionTitle">–ó–Ω–∞–∫–∏</div>
          <div class="grid2" id="cabAch"></div>

          <div class="tabsHint">–û—Ü–µ–Ω–∫–∞ ‚Äî —ç—Ç–æ –Ω–µ –≤–∫—É—Å. –≠—Ç–æ —Å–ª–µ–¥.</div>
        </div>

        <div class="screen fadeIn" id="scr_archive">
          <div class="row">
            <div class="h1" style="margin:0;">–ê—Ä—Ö–∏–≤</div>
            <span class="badge" id="archCount">0</span>
          </div>
          <div class="sub">–ó–¥–µ—Å—å –ª–µ–∂–∞—Ç –º–æ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ —Å–ª—É—á–∏–ª–∏—Å—å.</div>
          <div id="archList"></div>
          <button class="btn" id="btnArchBack">–ù–∞–∑–∞–¥</button>
        </div>

        <div class="screen fadeIn" id="scr_moment">
          <div class="row">
            <div>
              <div class="h1" id="mTitle" style="margin:0;">–ú–æ–º–µ–Ω—Ç</div>
              <div class="small" id="mDate">‚Äî</div>
            </div>
            <span class="badge brass" id="mStatus">‚Ä¶</span>
          </div>

          <div class="hr"></div>

          <div class="card" id="mBody"></div>

          <div class="card" style="margin-top:10px;">
            <div class="momentTitle" style="font-size:14px;margin-bottom:6px;">–ñ–µ—Å—Ç</div>
            <div class="small" style="margin-bottom:10px;">–ù–µ –≤–∫—É—Å. –ù–µ —Ç–∞–±–∞–∫. –†–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–º–µ–Ω—Ç–∞.</div>

            <div class="btnRow">
              <button class="btn" id="rateBad">–°–ª–∞–±–æ</button>
              <button class="btn" id="rateOk">–ß–µ—Å—Ç–Ω–æ</button>
              <button class="btn primary" id="ratePerfect">–ò–¥–µ–∞–ª—å–Ω–æ</button>
            </div>

            <button class="btn ghost" id="btnTip" style="margin-top:10px;">–û—Å—Ç–∞–≤–∏—Ç—å –∂–µ—Å—Ç</button>
          </div>

          <button class="btn" id="btnMomentBack">–ù–∞–∑–∞–¥</button>
        </div>

        <div class="screen fadeIn" id="scr_master">
          <div class="row">
            <div>
              <div class="kitchenTitle">–ö—É—Ö–Ω—è</div>
              <div class="kitchenSub">–ó–¥–µ—Å—å –Ω–µ ‚Äú–∑–∞–∫–∞–∑—ã‚Äù. –ó–¥–µ—Å—å ‚Äî –º–æ–º–µ–Ω—Ç—ã.</div>
            </div>
            <span class="badge" id="kCount">‚Ä¶</span>
          </div>

          <div id="kList" style="margin-top:10px;"></div>

          <button class="btn" id="btnKRefresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
          <div class="miniNote">–ü–µ—Å–æ–∫ —É –≥–æ—Å—Ç—è –Ω–∞—á–Ω—ë—Ç—Å—è, –∫–æ–≥–¥–∞ –≤—ã –Ω–∞–∂–º—ë—Ç–µ ‚Äú–ö—É—Ö–Ω—è —É—Å–ª—ã—à–∞–ª–∞‚Äù.</div>
        </div>

      </div><!-- /content -->

      <div class="bottombar" id="bottomTabs" style="display:none;">
        <button class="tab" id="tabArchive">–ê—Ä—Ö–∏–≤</button>
        <button class="tab active" id="tabMoments">–ú–æ–º–µ–Ω—Ç—ã</button>
      </div>

    </div><!-- /panel -->
  </div><!-- /frame -->
</div><!-- /app -->

<audio id="bgMusic" src="./7441574b62bac5e.mp3" loop preload="auto"></audio>
<script>
/* =========================
   CONFIG
   ========================= */
const BACKEND_BASE = "https://hookah-mix-bot-56x5.onrender.com";
const MASTER_ID = 1292778768;

const TIP_URL = "https://netmonet.co/qr/192937/tip?o=6";
const DURATION_MS = 25 * 60 * 1000;
const MUSIC_VOLUME = 0.30;

/* –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã */
const GEOFENCE = { lat: 56.482707, lon: 84.952464, radiusM: 40 };
const GEO_TTL_MS = 2 * 60 * 60 * 1000;

const tg = window.Telegram?.WebApp;
const tgUser = tg?.initDataUnsafe?.user || null;
const isMaster = !!(tgUser && tgUser.id === MASTER_ID);

const guest = {
  id: tgUser?.id,
  name: tgUser?.first_name || "–ì–æ—Å—Ç—å",
  username: tgUser?.username || ""
};

const LS_MOMENT_IDS = "hm_moment_ids";
const LS_GEO_UNTIL = "hm_geo_until";
const LS_MUSIC_ON = "hm_music_on";

const $ = (id)=>document.getElementById(id);

function escapeHtml(str=""){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

const screens = [
  "scr_gate","scr_door","scr_outside","scr_noPerm","scr_geoErr",
  "scr_welcome","scr_course","scr_wait",
  "scr_cabinet","scr_archive","scr_moment",
  "scr_master"
];

function go(id){
  screens.forEach(s=>$(s).classList.remove("active"));
  $(id).classList.add("active");
}

function showBottomTabs(on){
  $("bottomTabs").style.display = on ? "flex" : "none";
}

function setActiveTab(tab){
  $("tabArchive").classList.toggle("active", tab==="archive");
  $("tabMoments").classList.toggle("active", tab==="moments");
}

/* Micro haptics */
function tap(){
  try{ tg?.HapticFeedback?.impactOccurred("light"); }catch{}
}

/* MUSIC */
const audioEl = $("bgMusic");
const musicBtn = $("musicBtn");
const musicBtn2 = $("musicBtn2");

function setMusicBtn(on){
  musicBtn?.classList.toggle("on", !!on);
  musicBtn2?.classList.toggle("on", !!on);
}

async function playMusic(){
  try{
    audioEl.volume = MUSIC_VOLUME;
    await audioEl.play();
    localStorage.setItem(LS_MUSIC_ON,"1");
    setMusicBtn(true);
    tap();
  }catch(e){
    localStorage.setItem(LS_MUSIC_ON,"0");
    setMusicBtn(false);
  }
}

function pauseMusic(){
  audioEl.pause();
  localStorage.setItem(LS_MUSIC_ON,"0");
  setMusicBtn(false);
  tap();
}

function toggleMusic(){
  if(audioEl.paused) playMusic();
  else pauseMusic();
}

musicBtn.addEventListener("click", toggleMusic);
musicBtn2.addEventListener("click", toggleMusic);

/* GEO */
function distanceMeters(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const toRad = v => v * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

function isInsideFence(lat, lon){
  return distanceMeters(lat, lon, GEOFENCE.lat, GEOFENCE.lon) <= GEOFENCE.radiusM;
}

function requestLocation(){
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation) return reject(new Error("no_geolocation"));
    navigator.geolocation.getCurrentPosition(
      (pos)=>resolve({lat:pos.coords.latitude, lon:pos.coords.longitude, accuracy:pos.coords.accuracy}),
      (err)=>reject(err),
      { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
    );
  });
}

function setGeoAccessUntil(ts){ localStorage.setItem(LS_GEO_UNTIL, String(ts)); }
function hasGeoAccessNow(){ return Date.now() < Number(localStorage.getItem(LS_GEO_UNTIL)||0); }

/* STORAGE */
function getMomentIds(){
  try{ return JSON.parse(localStorage.getItem(LS_MOMENT_IDS)||"[]"); }catch{ return []; }
}
function addMomentId(id){
  const ids = getMomentIds();
  if(!ids.includes(id)) ids.push(id);
  localStorage.setItem(LS_MOMENT_IDS, JSON.stringify(ids));
  return ids;
}

/* API */
async function safeJson(r){
  const t = await r.text();
  try{ return JSON.parse(t); }catch{ return { ok:false, raw:t }; }
}

async function apiGetMoments(limit=200){
  const r = await fetch(`${BACKEND_BASE}/moments?limit=${limit}`);
  const data = await safeJson(r);
  if(!r.ok) throw new Error("getMoments failed");
  return data;
}

async function apiCreateMoment(m){
  const r = await fetch(`${BACKEND_BASE}/moment`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(m)
  });
  const data = await safeJson(r);
  if(!r.ok) throw new Error("createMoment failed");
  return data;
}

async function apiSetStatus(id,status){
  const r = await fetch(`${BACKEND_BASE}/moment/${id}/status`,{
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({status})
  });
  const data = await safeJson(r);
  if(!r.ok) throw new Error("setStatus failed");
  return data;
}

async function apiSetRating(id,rating){
  const r = await fetch(`${BACKEND_BASE}/moment/${id}/rating`,{
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({rating})
  });
  const data = await safeJson(r);
  if(!r.ok) throw new Error("setRating failed");
  return data;
}

/* QUESTIONS */
const QUESTIONS = [
  { title:"THE MENU", text:"–ö –∫–∞–∫–æ–º—É —Ü–≤–µ—Ç—É —Ç—è–Ω–µ—Ç—Å—è —Ä—É–∫–∞ —Å–µ–π—á–∞—Å?", options:["–¢–µ–Ω—å","–°–≤–µ—Ç","–ü–µ–ø–µ–ª","–ú–µ–¥—å","–•–æ–ª–æ–¥"] },
  { title:"–ö–∞—Å–∞–Ω–∏–µ.", text:"–û—â—É—â–µ–Ω–∏–µ –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ ‚Äî", options:["–ü–æ—á—Ç–∏ –≤–ø–ª–æ—Ç–Ω—É—é","–ù–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏","–í–æ–∑–¥—É—à–Ω–æ","–¢—è–∂–µ–ª–æ"] },
  { title:"–ü–∞—É–∑–∞.", text:"–ï—Å–ª–∏ —Å–¥–µ–ª–∞—Ç—å –ø–∞—É–∑—É ‚Äî", options:["–û—Ä–µ—Ö","–§—Ä—É–∫—Ç","–•–ª–µ–±","–ù–∏—á–µ–≥–æ"] },
  { title:"–°–∫–æ—Ä–æ—Å—Ç—å.", text:"–≠—Ç–æ –≤—Ä–µ–º—è —Ö–æ—á–µ—Ç—Å—è –ø—Ä–æ–∂–∏—Ç—å ‚Äî", options:["–ú–µ–¥–ª–µ–Ω–Ω–æ","–†—ã–≤–∫–∞–º–∏","–†–æ–≤–Ω–æ","–ù–µ —á—É–≤—Å—Ç–≤—É—è –≤—Ä–µ–º–µ–Ω–∏"] },
  { title:"–ú–∞—Ç–µ—Ä–∏–∞–ª.", text:"–ë–ª–∏–∂–µ –∫ —á–µ–º—É?", options:["–ë–∞—Ä—Ö–∞—Ç","–ú–µ—Ç–∞–ª–ª","–î–µ—Ä–µ–≤–æ","–°—Ç–µ–∫–ª–æ"] },
  { title:"–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞.", text:"–≠—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ‚Äî", options:["–•–æ–ª–æ–¥","–¢–µ–ø–ª–æ","–ö–æ–Ω—Ç—Ä–∞—Å—Ç","–ë–µ–∑ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã"] },
  { title:"–ó–∞–ø—Ä–µ—Ç.", text:"–ß—Ç–æ —Å–µ–≥–æ–¥–Ω—è –Ω–µ–ª—å–∑—è –≤–ø—É—Å–∫–∞—Ç—å?", options:["–¶–∏—Ç—Ä—É—Å","–Ø–≥–æ–¥—ã","–î–µ—Å–µ—Ä—Ç","–¢—è–∂—ë–ª—ã–µ —Å–ø–µ—Ü–∏–∏","–ú—è—Ç–∞"] },
  { title:"–í–µ—Å.", text:"–§–∏–Ω–∞–ª—å–Ω–æ–µ –æ—â—É—â–µ–Ω–∏–µ ‚Äî", options:["–õ–µ–≥–∫–æ","–†–æ–≤–Ω–æ","–ü–ª–æ—Ç–Ω–æ","–¢—è–∂–µ–ª–æ"] },
];

const EPITHETS = ["–•–æ–ª–æ–¥ –¢–µ–Ω—å","–°—Ç—Ä–æ–≥–∞—è –°—Ü–µ–Ω–∞","–¢—ë–º–Ω–∞—è –õ–∏–Ω–∏—è","–¢—è–∂—ë–ª–∞—è –ü—Ä–∏–≤—ã—á–∫–∞","–°—É—Ö–∞—è –¢–∏—à–∏–Ω–∞","–ù–µ—Ä–≤–Ω–∞—è –ö–æ–º–Ω–∞—Ç–∞","–ë–µ–ª—ã–π –®—É–º","–ú–µ–¥–Ω—ã–π –ü–µ–ø–µ–ª"];
function randomEpithet(){ return EPITHETS[Math.floor(Math.random()*EPITHETS.length)]; }

/* COURSE STATE */
let qIndex = 0;
let answers = {};
let openMomentId = null;
let waitPoll = null;

function renderQuestion(){
  const q = QUESTIONS[qIndex];
  $("qTitle").textContent = q.title;
  $("qText").textContent = q.text;

  const box = $("qOptions");
  box.innerHTML = "";
  q.options.forEach(opt=>{
    const div = document.createElement("div");
    div.className = "option";
    div.textContent = opt;
    div.onclick = ()=>{ tap(); pickAnswer(opt); };
    box.appendChild(div);
  });
}

async function pickAnswer(v){
  answers[String(qIndex+1)] = v;
  qIndex++;

  if(qIndex < QUESTIONS.length){
    renderQuestion();
    return;
  }
  await createMoment();
}

async function createMoment(){
  const id = Date.now()+"_"+Math.random().toString(36).slice(2,6);
  const m = {
    id,
    createdAt: Date.now(),
    status: "new",
    acceptedAt: null,
    rating: null,
    epithet: randomEpithet(),
    guest,
    answers
  };

  addMomentId(id);
  go("scr_wait");
  startWaitingLoop();

  try{ await apiCreateMoment(m); }catch(e){}
}

/* WAITING */
function fmt(ms){
  if(ms == null) return "‚Äî:‚Äî";
  const t = Math.max(0, Math.floor(ms/1000));
  const m = Math.floor(t/60);
  const s = t%60;
  return `${m}:${String(s).padStart(2,"0")}`;
}

function setHourglassProgress(p01){
  const p = Math.max(0, Math.min(1, p01));
  const top = $("hgTop");
  const bot = $("hgBottom");
  const topH = 48 - (44*p);
  const botH = 48 * p;
  top.style.height = `${topH}%`;
  bot.style.height = `${botH}%`;
}

async function startWaitingLoop(){
  if(waitPoll) clearInterval(waitPoll);

  async function tick(){
    try{
      const ids = getMomentIds();
      const data = await apiGetMoments(250);
      const mine = (data.moments||[]).filter(m=>ids.includes(m.id)).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      const active = mine.find(m=>m.status !== "finished") || null;

      if(!active){
        await renderCabinet();
        go("scr_cabinet");
        showBottomTabs(true);
        setActiveTab("moments");
        return;
      }

      if(!active.acceptedAt){
        $("waitTitle").textContent = "–ü—Ä–æ—Ü–µ—Å—Å –∏–¥—ë—Ç.";
        $("waitSub").textContent = "–ù–µ –≤–º–µ—à–∏–≤–∞–π—Ç–µ—Å—å.";
        $("waitTimer").textContent = "‚Äî:‚Äî";
        $("waitHint").textContent = "–í—Ä–µ–º—è –Ω–∞—á–Ω—ë—Ç—Å—è, –∫–æ–≥–¥–∞ –∫—É—Ö–Ω—è –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç.";
        setHourglassProgress(0);
        openMomentId = active.id;
        return;
      }

      const left = (active.acceptedAt + DURATION_MS) - Date.now();
      const progress = 1 - (left / DURATION_MS);

      if(left <= 0 || active.status === "finished"){
        $("waitTitle").textContent = "–ú–æ–º–µ–Ω—Ç —Å–ª—É—á–∏–ª—Å—è.";
        $("waitSub").textContent = "–î–∞–ª—å—à–µ ‚Äî –±–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.";
        $("waitTimer").textContent = "–ì–æ—Ç–æ–≤–æ";
        $("waitHint").textContent = "–û—Ç–∫—Ä–æ–π—Ç–µ –º–æ–º–µ–Ω—Ç –≤ –∫–∞–±–∏–Ω–µ—Ç–µ.";
        setHourglassProgress(1);
        openMomentId = active.id;
        return;
      }

      $("waitTitle").textContent = "–ü—Ä–æ—Ü–µ—Å—Å –∏–¥—ë—Ç.";
      $("waitSub").textContent = "–ù–µ –≤–º–µ—à–∏–≤–∞–π—Ç–µ—Å—å.";
      $("waitTimer").textContent = fmt(left);
      $("waitHint").textContent = "–ü–µ—Å–æ–∫ –∏–¥—ë—Ç.";
      setHourglassProgress(progress);
      openMomentId = active.id;

    }catch(e){
      $("waitHint").textContent = "–ù–µ—Ç —Å–≤—è–∑–∏.";
    }
  }

  await tick();
  waitPoll = setInterval(tick, 2000);
}

function calcAchievements(moments){
  const sessions = moments.length;
  const rated = moments.filter(m=>!!m.rating).length;

  return [
    { key:"first", t:"–ü–µ—Ä–≤—ã–π –º–æ–º–µ–Ω—Ç", d:"–í—ã –≤–æ—à–ª–∏.", ok:sessions>=1 },
    { key:"return", t:"–í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ", d:"–í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å.", ok:sessions>=2 },
    { key:"honest", t:"–ß–µ—Å—Ç–Ω–æ—Å—Ç—å", d:"–í—ã –æ—Ü–µ–Ω–∏–ª–∏ —Ç—Ä–∏.", ok:rated>=3 }
  ];
}

async function renderCabinet(){
  $("cabName").textContent = guest.name;

  const ids = getMomentIds();
  const lastBox = $("cabLast");
  const achBox = $("cabAch");
  lastBox.innerHTML = "";
  achBox.innerHTML = "";

  try{
    const data = await apiGetMoments(250);
    const mine = (data.moments||[]).filter(m=>ids.includes(m.id)).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    const rated = mine.filter(m=>!!m.rating).length;

    $("cabMeta").textContent = `–ú–æ–º–µ–Ω—Ç–æ–≤: ${mine.length} ¬∑ –û—Ü–µ–Ω–æ–∫: ${rated}`;

    const active = mine.find(m=>m.status !== "finished") || null;
    if(active){
      $("cabNowCard").style.display = "block";
      $("cabNowState").textContent = active.acceptedAt ? "–í –ü–†–û–¶–ï–°–°–ï" : "–ù–û–í–´–ô";
      $("cabNowText").textContent = active.acceptedAt
        ? "–ü—Ä–æ—Ü–µ—Å—Å —É–∂–µ –Ω–∞—á–∞–ª—Å—è. –ù–µ –≤–º–µ—à–∏–≤–∞–π—Ç–µ—Å—å."
        : "–ü–µ—Å–æ–∫ –µ—â—ë –Ω–µ –∑–∞–ø—É—â–µ–Ω.";
      openMomentId = active.id;
    }else{
      $("cabNowCard").style.display = "none";
    }

    const last = mine.slice(0,3);
    if(!last.length){
      lastBox.innerHTML = `<div class="small">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–æ –∑–∞–ª —É–∂–µ –∑–¥–µ—Å—å.</div>`;
    }else{
      last.forEach(m=>{
        const badge = (m.status==="finished")
          ? "–°–õ–£–ß–ò–õ–°–Ø"
          : (m.acceptedAt ? "–í –ü–†–û–¶–ï–°–°–ï" : "–ù–û–í–´–ô");

        lastBox.innerHTML += `
          <div class="card">
            <div class="row">
              <div>
                <div class="momentTitle">${escapeHtml(m.epithet||"–ú–æ–º–µ–Ω—Ç")}</div>
                <div class="momentDate">${new Date(m.createdAt||Date.now()).toLocaleString("ru-RU")}</div>
              </div>
              <span class="badge brass">${escapeHtml(badge)}</span>
            </div>
            <div class="btnRow">
              <button class="btn" onclick="tap(); openMoment('${escapeHtml(m.id)}')">–û—Ç–∫—Ä—ã—Ç—å</button>
            </div>
          </div>
        `;
      });
    }

    const ach = calcAchievements(mine);
    ach.forEach(a=>{
      achBox.innerHTML += `
        <div class="medal ${a.ok ? "" : "lock"}">
          <div class="head">
            <div class="sealCoin"></div>
            <div>
              <div class="t">${escapeHtml(a.t)}</div>
              <div class="d">${escapeHtml(a.d)}</div>
            </div>
          </div>
        </div>
      `;
    });

  }catch(e){
    $("cabMeta").textContent = "–ù–µ—Ç —Å–≤—è–∑–∏.";
    lastBox.innerHTML = `<div class="small">–ù–µ—Ç —Å–≤—è–∑–∏.</div>`;
  }
}

async function renderArchive(){
  const ids = getMomentIds();
  const box = $("archList");
  box.innerHTML = "";

  try{
    const data = await apiGetMoments(250);
    const mine = (data.moments||[]).filter(m=>ids.includes(m.id)).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

    $("archCount").textContent = String(mine.length);

    if(!mine.length){
      box.innerHTML = `<div class="small">–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç.</div>`;
      return;
    }

    mine.forEach(m=>{
      const mark = m.rating ? "–û–¶–ï–ù–ï–ù–û" : "–ë–ï–ó –û–¶–ï–ù–ö–ò";
      box.innerHTML += `
        <div class="card">
          <div class="row">
            <div>
              <div class="momentTitle">${escapeHtml(m.epithet||"–ú–æ–º–µ–Ω—Ç")}</div>
              <div class="momentDate">${new Date(m.createdAt||Date.now()).toLocaleString("ru-RU")}</div>
            </div>
            <span class="badge">${escapeHtml(mark)}</span>
          </div>
          <div class="btnRow">
            <button class="btn" onclick="tap(); openMoment('${escapeHtml(m.id)}')">–û—Ç–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
      `;
    });

  }catch(e){
    box.innerHTML = `<div class="small">–ù–µ—Ç —Å–≤—è–∑–∏.</div>`;
  }
}

window.openMoment = async function(id){
  openMomentId = id;
  go("scr_moment");
  showBottomTabs(false);
  await renderMoment();
};

async function renderMoment(){
  const id = openMomentId;
  if(!id){
    $("mTitle").textContent = "–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ";
    $("mBody").innerHTML = "";
    return;
  }

  try{
    const data = await apiGetMoments(250);
    const m = (data.moments||[]).find(x=>String(x.id)===String(id));
    if(!m) return;

    $("mTitle").textContent = m.epithet || "–ú–æ–º–µ–Ω—Ç";
    $("mDate").textContent = new Date(m.createdAt||Date.now()).toLocaleString("ru-RU");
    $("mStatus").textContent = (m.status==="finished") ? "–°–õ–£–ß–ò–õ–°–Ø" : (m.acceptedAt ? "–í –ü–†–û–¶–ï–°–°–ï" : "–ù–û–í–´–ô");

    const ans = m.answers || {};
    const lines = Object.keys(ans)
      .sort((a,b)=>Number(a)-Number(b))
      .map(k=>`<div class="small"><b>q${escapeHtml(k)}:</b> ${escapeHtml(ans[k])}</div>`)
      .join("");

    $("mBody").innerHTML = `
      <div class="momentTitle" style="font-size:14px;margin-bottom:6px;">–£—Å–ª–æ–≤–∏—è</div>
      ${lines || `<div class="small">‚Äî</div>`}
    `;
  }catch(e){
    $("mBody").innerHTML = `<div class="small">–ù–µ—Ç —Å–≤—è–∑–∏.</div>`;
  }
}

/* MASTER */
async function renderKitchen(){
  const list = $("kList");
  list.innerHTML = "";

  try{
    const data = await apiGetMoments(250);
    const arr = (data.moments||[]).slice().sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    $("kCount").textContent = String(arr.length);

    if(!arr.length){
      list.innerHTML = `<div class="small">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤.</div>`;
      return;
    }

    arr.forEach(m=>{
      const badge = (m.status==="finished") ? "–°–õ–£–ß–ò–õ–°–Ø" : (m.acceptedAt ? "–í –ü–†–û–¶–ï–°–°–ï" : "–ù–û–í–´–ô");
      list.innerHTML += `
        <div class="card">
          <div class="row">
            <div>
              <div class="momentTitle">${escapeHtml(m.guest?.name || "–ì–æ—Å—Ç—å")}</div>
              <div class="momentDate">${new Date(m.createdAt||Date.now()).toLocaleString("ru-RU")}</div>
              <div class="small">–ü–µ—Å–æ–∫: ${m.acceptedAt ? "–∏–¥—ë—Ç" : "–µ—â—ë –Ω–µ –∑–∞–ø—É—â–µ–Ω"}</div>
            </div>
            <span class="badge brass">${escapeHtml(badge)}</span>
          </div>

          <div class="kBtns">
            <button class="btn primary" onclick="tap(); kSet('${escapeHtml(m.id)}','accepted')">–ö—É—Ö–Ω—è —É—Å–ª—ã—à–∞–ª–∞</button>
            <button class="btn" onclick="tap(); kSet('${escapeHtml(m.id)}','in_progress')">–ü–µ—á—å —Ä–∞–±–æ—Ç–∞–µ—Ç</button>
            <button class="btn" onclick="tap(); kSet('${escapeHtml(m.id)}','serving')">–ü–æ–¥–∞—á–∞</button>
            <button class="btn" onclick="tap(); kSet('${escapeHtml(m.id)}','finished')">–ú–æ–º–µ–Ω—Ç —Å–ª—É—á–∏–ª—Å—è</button>
          </div>
        `;
    });

  }catch(e){
    $("kCount").textContent = "–Ω–µ—Ç —Å–≤—è–∑–∏";
    list.innerHTML = `<div class="small">–ù–µ—Ç —Å–≤—è–∑–∏.</div>`;
  }
}

window.kSet = async function(id,status){
  try{
    await apiSetStatus(id,status);
    await renderKitchen();
  }catch(e){}
};

/* DOOR FLOW */
async function openDoor(){
  tap();
  try{
    const pos = await requestLocation();
    const ok = isInsideFence(pos.lat, pos.lon);

    if(!ok){
      go("scr_outside");
      showBottomTabs(false);
      return;
    }

    setGeoAccessUntil(Date.now()+GEO_TTL_MS);
    go("scr_gate");
    showBottomTabs(false);
  }catch(e){
    if(e && e.code === 1){
      go("scr_noPerm");
    }else{
      go("scr_geoErr");
    }
    showBottomTabs(false);
  }
}

/* BUTTONS */
$("sealBtn").addEventListener("click", async ()=>{
  await playMusic();
  go("scr_welcome");
  showBottomTabs(false);
});

$("btnDoor").addEventListener("click", openDoor);
$("btnDoorHelp").addEventListener("click", ()=>{
  tap();
  alert("–ï—Å–ª–∏ –≥–µ–æ –Ω–µ –æ—Ç–¥–∞—ë—Ç—Å—è: –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å –º–∏–Ω–∏-–∞–ø–ø –≤ Telegram –∏ –¥–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö iOS. –ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–ª—á–∏—Ç ‚Äî —Å–µ–≥–æ–¥–Ω—è –±–µ–∑ —ç—Ç–æ–≥–æ.");
});
$("btnOutsideRetry").addEventListener("click", openDoor);
$("btnOutsideBack").addEventListener("click", ()=>{ tap(); go("scr_door"); });
$("btnNoPermRetry").addEventListener("click", openDoor);
$("btnNoPermBack").addEventListener("click", ()=>{ tap(); go("scr_door"); });
$("btnGeoErrRetry").addEventListener("click", openDoor);
$("btnGeoErrBack").addEventListener("click", ()=>{ tap(); go("scr_door"); });

$("btnStartCourse").addEventListener("click", ()=>{
  tap();
  qIndex = 0;
  answers = {};
  go("scr_course");
  showBottomTabs(false);
  renderQuestion();
});

$("btnGoCabinet").addEventListener("click", async ()=>{
  tap();
  await renderCabinet();
  go("scr_cabinet");
  showBottomTabs(true);
  setActiveTab("moments");
});

$("btnQBack").addEventListener("click", ()=>{
  tap();
  if(qIndex<=0){ go("scr_welcome"); return; }
  qIndex = Math.max(0, qIndex-1);
  delete answers[String(qIndex+1)];
  renderQuestion();
});

$("btnQAbort").addEventListener("click", async ()=>{
  tap();
  await renderCabinet();
  go("scr_cabinet");
  showBottomTabs(true);
  setActiveTab("moments");
});

$("btnWaitCab").addEventListener("click", async ()=>{
  tap();
  await renderCabinet();
  go("scr_cabinet");
  showBottomTabs(true);
  setActiveTab("moments");
});

$("btnCabToWait").addEventListener("click", ()=>{
  tap();
  go("scr_wait");
  showBottomTabs(false);
  startWaitingLoop();
});

$("btnCabOpenNow").addEventListener("click", async ()=>{
  tap();
  if(!openMomentId){ return; }
  await window.openMoment(openMomentId);
});

$("btnOpenArchive").addEventListener("click", async ()=>{
  tap();
  await renderArchive();
  go("scr_archive");
  showBottomTabs(true);
  setActiveTab("archive");
});

$("btnNewMoment").addEventListener("click", ()=>{
  tap();
  qIndex = 0;
  answers = {};
  go("scr_course");
  showBottomTabs(false);
  renderQuestion();
});

$("btnArchBack").addEventListener("click", async ()=>{
  tap();
  await renderCabinet();
  go("scr_cabinet");
  showBottomTabs(true);
  setActiveTab("moments");
});

$("btnMomentBack").addEventListener("click", async ()=>{
  tap();
  await renderCabinet();
  go("scr_cabinet");
  showBottomTabs(true);
  setActiveTab("moments");
});

$("btnTip").addEventListener("click", ()=>{ tap(); window.open(TIP_URL, "_blank"); });

$("rateBad").addEventListener("click", async ()=>{
  tap();
  if(!openMomentId) return;
  try{ await apiSetRating(openMomentId,"bad"); }catch{}
  alert("–ó–∞–ø–æ–º–Ω–∏–ª.");
});

$("rateOk").addEventListener("click", async ()=>{
  tap();
  if(!openMomentId) return;
  try{ await apiSetRating(openMomentId,"ok"); }catch{}
  alert("–ó–∞–ø–æ–º–Ω–∏–ª.");
});

$("ratePerfect").addEventListener("click", async ()=>{
  tap();
  if(!openMomentId) return;
  try{ await apiSetRating(openMomentId,"perfect"); }catch{}
  alert("–ó–∞–ø–æ–º–Ω–∏–ª.");
});

$("tabArchive").addEventListener("click", async ()=>{
  tap();
  await renderArchive();
  go("scr_archive");
  showBottomTabs(true);
  setActiveTab("archive");
});

$("tabMoments").addEventListener("click", async ()=>{
  tap();
  await renderCabinet();
  go("scr_cabinet");
  showBottomTabs(true);
  setActiveTab("moments");
});

$("btnKRefresh").addEventListener("click", ()=>{ tap(); renderKitchen(); });

/* START */
document.addEventListener("DOMContentLoaded", async ()=>{
  try{ tg?.ready(); tg?.expand(); }catch{}

  const on = localStorage.getItem(LS_MUSIC_ON)==="1";
  setMusicBtn(on);

  if(isMaster){
    go("scr_master");
    showBottomTabs(false);
    await renderKitchen();
    setInterval(renderKitchen, 3000);
    return;
  }

  const ids = getMomentIds();
  const geoOk = hasGeoAccessNow();

  if(ids.length){
    await renderCabinet();
    go("scr_cabinet");
    showBottomTabs(true);
    setActiveTab("moments");
    return;
  }

  if(!geoOk){
    go("scr_door");
    showBottomTabs(false);
    return;
  }

  go("scr_gate");
  showBottomTabs(false);
});
</script>

</body>
</html>
