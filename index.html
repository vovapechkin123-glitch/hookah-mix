<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>THE MENU</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root{
  color-scheme: dark;

  --bg0:#05050a;
  --bg1:#0a0a12;
  --bg2:#141422;

  --card: rgba(255,255,255,.055);
  --card2: rgba(255,255,255,.075);
  --stroke: rgba(255,255,255,.10);

  --text:#ffffff;
  --muted: rgba(255,255,255,.70);
  --soft: rgba(255,255,255,.55);

  /* –º–µ–¥–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç */
  --accent1:#d7b26a;
  --accent2:#b9813a;
  --danger:#ff3d77;

  --radius:18px;
  --radius2:22px;
  --shadow: 0 20px 60px rgba(0,0,0,.55);
}

*{ box-sizing:border-box; }

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  color:var(--text);
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:24px;

  background:
    radial-gradient(1200px 900px at 30% 20%, rgba(215,178,106,.08) 0%, rgba(20,20,34,.0) 55%),
    radial-gradient(900px 700px at 80% 30%, rgba(185,129,58,.10) 0%, rgba(10,10,18,.0) 60%),
    radial-gradient(1200px 800px at 40% 90%, rgba(215,178,106,.05) 0%, rgba(5,5,10,0) 60%),
    linear-gradient(180deg, var(--bg2), var(--bg0));
}

.card{
  width:min(760px,100%);
  background: var(--card);
  border:1px solid var(--stroke);
  border-radius: var(--radius2);
  padding:22px;
  backdrop-filter: blur(12px);
  box-shadow: var(--shadow);
  position:relative;
}

.screen{ display:none; }
.screen.active{ display:block; }

h1{
  margin:0 0 10px;
  font-size:24px;
  letter-spacing:.2px;
}

p{
  margin:0 0 10px;
  opacity:.88;
  line-height:1.55;
}

.small{
  font-size:13px;
  color:var(--soft);
}

hr{
  border:0;
  border-top:1px solid rgba(255,255,255,.10);
  margin:14px 0;
}

.btn{
  width:100%;
  margin-top:14px;
  padding:14px 16px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  font-size:16px;
  font-weight:800;
  cursor:pointer;
  color:var(--text);
  background: rgba(255,255,255,.08);
  transition: transform .12s ease, background .12s ease, border-color .12s ease;
}

.btn:hover{
  background: rgba(255,255,255,.11);
  border-color: rgba(255,255,255,.16);
}

.btn:active{
  transform: translateY(1px) scale(.99);
}

.btn.primary{
  border:1px solid rgba(215,178,106,.35);
  background: linear-gradient(180deg, rgba(215,178,106,.22), rgba(185,129,58,.10));
  box-shadow: 0 14px 40px rgba(185,129,58,.10);
}

.btn.primary:hover{
  background: linear-gradient(180deg, rgba(215,178,106,.28), rgba(185,129,58,.14));
}

.btn.danger{
  border:1px solid rgba(255,61,119,.35);
  background: rgba(255,61,119,.10);
}

.btnRow{
  display:flex;
  gap:10px;
  margin-top:12px;
}
.btnRow .btn{ margin-top:0; width:100%; }

.option{
  padding:14px 14px;
  border-radius:16px;
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  margin-top:10px;
  cursor:pointer;
  transition: background .12s ease, transform .12s ease, border-color .12s ease;
  position:relative;
  overflow:hidden;
}
.option::after{
  content:"";
  position:absolute;
  inset:-40px;
  background: radial-gradient(circle at 20% 30%, rgba(215,178,106,.14), transparent 55%);
  opacity:.0;
  transition: opacity .14s ease;
}
.option:hover::after{ opacity:1; }
.option:hover{
  background: rgba(255,255,255,.10);
  border-color: rgba(215,178,106,.22);
}
.option:active{ transform: translateY(1px); }

.row{
  display:flex;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
  align-items:center;
}

.badge{
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  background: rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.12);
  color: rgba(255,255,255,.80);
}
.badge.good{
  background: rgba(215,178,106,.10);
  border-color: rgba(215,178,106,.22);
  color: rgba(255,255,255,.88);
}
.badge.warn{
  background: rgba(215,178,106,.06);
  border-color: rgba(215,178,106,.14);
}

.glowLine{
  height:1px;
  width:100%;
  background: linear-gradient(90deg, transparent, rgba(215,178,106,.35), transparent);
  opacity:.55;
  margin:12px 0;
}

/* Floating sound button */
.soundFloating{
  position:absolute;
  top:14px;
  right:14px;
  width:34px;
  height:34px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.25);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  opacity:.85;
  transition: transform .12s ease, opacity .12s ease, border-color .12s ease;
  z-index:5;
}
.soundFloating:hover{
  opacity:1;
  border-color: rgba(215,178,106,.25);
}
.soundFloating:active{ transform: translateY(1px); }
.soundFloating.on{
  border-color: rgba(215,178,106,.35);
  box-shadow: 0 0 0 4px rgba(215,178,106,.08);
}
.soundFloating.off{ opacity:.55; }

/* Sound Gate */
.gateWrap{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  min-height:420px;
  gap:16px;
  transition: all .55s ease;
}
.gateLogo{
  width:94px;
  height:94px;
  border-radius:999px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  user-select:none;
  background:
    radial-gradient(circle at 30% 30%, rgba(215,178,106,.95), rgba(185,129,58,.80));
  box-shadow:
    0 22px 70px rgba(185,129,58,.18),
    0 0 0 1px rgba(255,255,255,.06) inset;
}
.gateLogo .ic{
  font-size:34px;
  font-weight:900;
  transform: translateY(-1px);
  filter: drop-shadow(0 6px 20px rgba(0,0,0,.35));
}
.gatePulse{ animation: gatePulse 2.8s ease-in-out infinite; }
@keyframes gatePulse{ 0%,100%{ transform: scale(1); } 50%{ transform: scale(1.06); } }
.gateOut{ opacity:0; transform: translateY(10px) scale(.985); }

/* Cabinet */
.sectionTitle{
  margin-top:14px;
  font-size:13px;
  letter-spacing:.12em;
  text-transform:uppercase;
  color: rgba(255,255,255,.55);
}
.panel{
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  padding:14px;
  margin-top:12px;
}
.panel.soft{ background: rgba(255,255,255,.05); }

.profileTop{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.profileName{
  font-size:22px;
  font-weight:900;
  letter-spacing:.2px;
}
.profileMeta{
  color: rgba(255,255,255,.65);
  font-size:13px;
}

.momentCard{
  background: rgba(255,255,255,.055);
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  padding:14px;
  margin-top:12px;
}
.momentTitleRow{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:flex-start;
}
.momentTitle{
  font-size:18px;
  font-weight:900;
}
.momentTime{
  font-size:12px;
  color: rgba(255,255,255,.55);
}
.pill{
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.18);
  color: rgba(255,255,255,.75);
}
.pill.brass{
  border-color: rgba(215,178,106,.28);
  background: rgba(215,178,106,.08);
  color: rgba(255,255,255,.86);
}

.actionsGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:12px;
}
.actionsGrid .btn{ margin-top:0; padding:13px 14px; font-size:15px; }

.achGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:12px;
}
.achCard{
  background: rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.10);
  border-radius:16px;
  padding:12px;
  min-height:72px;
  display:flex;
  flex-direction:column;
  justify-content:center;
}
.achCard.locked{
  opacity:.45;
  filter: grayscale(.4);
}
.achTitle{ font-weight:900; margin-bottom:4px; }
.achDesc{ font-size:12px; color: rgba(255,255,255,.60); }

/* Waiting */
.timer{
  font-size:34px;
  text-align:center;
  letter-spacing:2px;
  margin:14px 0;
}
.hourglass{
  width:110px;
  height:140px;
  margin:12px auto 6px;
  border-radius:26px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.20);
  position:relative;
  overflow:hidden;
  box-shadow: 0 16px 50px rgba(0,0,0,.35);
}
.hourglass::before{
  content:"";
  position:absolute;
  inset:0;
  background:
    radial-gradient(circle at 30% 25%, rgba(215,178,106,.18), transparent 55%),
    radial-gradient(circle at 70% 75%, rgba(185,129,58,.12), transparent 55%);
  opacity:.85;
}
.sandTop, .sandBottom{
  position:absolute;
  left:14px;
  right:14px;
  border-radius:18px;
  background: linear-gradient(180deg, rgba(215,178,106,.75), rgba(185,129,58,.35));
  box-shadow: 0 10px 30px rgba(185,129,58,.12);
}
.sandTop{ top:14px; height:48%; transform-origin: top; }
.sandBottom{ bottom:14px; height:0%; transform-origin: bottom; }
.sandStream{
  position:absolute;
  left:50%;
  top:50%;
  width:2px;
  height:44px;
  transform: translate(-50%,-50%);
  background: rgba(215,178,106,.65);
  opacity:.75;
}

/* Master */
.kitchenTitle{ font-size:22px; font-weight:900; }
.kitchenSub{ color: rgba(255,255,255,.65); font-size:13px; }

.kitchenCard{
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  padding:14px;
  margin-top:12px;
}
.kitchenCard.new{
  border-color: rgba(215,178,106,.22);
  box-shadow: 0 0 0 4px rgba(215,178,106,.06);
}
.kitchenName{ font-size:16px; font-weight:900; }
.kitchenMeta{ font-size:12px; color: rgba(255,255,255,.55); }
.kitchenBtns{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:12px;
}
.kitchenBtns .btn{ margin-top:0; padding:12px 12px; font-size:14px; }
</style>
</head>

<body>
<div class="card">

  <!-- Floating sound button -->
  <button class="soundFloating off" id="soundBtnFloating" title="–ú—É–∑—ã–∫–∞">‚ô™</button>

  <!-- Audio -->
  <audio id="bgMusic" src="./7441574b62bac5e.mp3" loop preload="auto"></audio>

  <!-- ===================== SOUND GATE ===================== -->
  <div class="screen active" id="soundGate">
    <div class="gateWrap" id="gateWrap">
      <div class="gateLogo gatePulse" id="gateLogo">
        <div class="ic">‚ô™</div>
      </div>
      <h1 style="text-align:center;margin:0;">–í–∫–ª—é—á–∏—Ç–µ –∑–∞–ª.</h1>
      <p class="small" style="text-align:center;margin:0;">
        –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–Ω–∞–∫.<br>
        –î–∞–ª—å—à–µ ‚Äî –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤.
      </p>
    </div>
  </div>

  <!-- ===================== WELCOME ===================== -->
  <div class="screen" id="welcome">
    <h1>–ü—Ä–µ–∂–¥–µ —á–µ–º –º—ã –Ω–∞—á–Ω—ë–º.</h1>
    <p>
      –ó–¥–µ—Å—å –Ω–µ –ø–æ–¥–±–∏—Ä–∞—é—Ç –≤–∫—É—Å.<br><br>
      –ó–¥–µ—Å—å —Ñ–∏–∫—Å–∏—Ä—É—é—Ç –º–æ–º–µ–Ω—Ç.<br><br>
      –¢–æ, —á—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ,<br>
      –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∑–∞—Ä–∞–Ω–µ–µ.
    </p>

    <div class="glowLine"></div>

    <button class="btn primary" id="btnWelcomeStart">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
  </div>

  <!-- ===================== DOOR ===================== -->
  <div class="screen" id="door">
    <h1>–û—Ç–∫—Ä—ã—Ç—å –¥–≤–µ—Ä—å.</h1>
    <p class="small">
      –≠—Ç–æ –≤—Ö–æ–¥ –Ω–µ –≤ –∑–∞–∫–∞–∑.<br>
      –≠—Ç–æ –≤—Ö–æ–¥ –≤ –ø—Ä–æ—Ü–µ—Å—Å.
    </p>

    <button class="btn primary" id="btnDoor">–û—Ç–∫—Ä—ã—Ç—å</button>
    <button class="btn" id="btnDoorBot">–Ø –Ω–µ –º–æ–≥—É –¥–∞—Ç—å –≥–µ–æ</button>
  </div>

  <!-- ===================== OUTSIDE ===================== -->
  <div class="screen" id="outside">
    <h1>–°–Ω–∞—Ä—É–∂–∏.</h1>
    <p class="small">
      –°–µ–π—á–∞—Å —ç—Ç–æ –º–µ—Å—Ç–æ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∑–∞–ª–æ–º.<br>
      –í–µ—Ä–Ω–∏—Ç–µ—Å—å ‚Äî –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ.
    </p>

    <div class="btnRow">
      <button class="btn primary" id="btnOutsideRetry">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–Ω–æ–≤–∞</button>
      <button class="btn" id="btnOutsideBack">–ù–∞–∑–∞–¥</button>
    </div>
  </div>

  <!-- ===================== NO PERMISSION ===================== -->
  <div class="screen" id="no-permission">
    <h1>–î–≤–µ—Ä—å –∑–∞–∫—Ä—ã—Ç–∞.</h1>
    <p class="small">
      –ë–µ–∑ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é<br>
      –∑–∞–ª –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è.
    </p>

    <div class="btnRow">
      <button class="btn primary" id="btnNoPermRetry">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
      <button class="btn" id="btnNoPermBack">–ù–∞–∑–∞–¥</button>
    </div>
  </div>

  <!-- ===================== GEO ERROR ===================== -->
  <div class="screen" id="geo-error">
    <h1>–¢–∏—à–∏–Ω–∞.</h1>
    <p class="small">
      –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–ª—á–∏—Ç.<br>
      –°–µ–≥–æ–¥–Ω—è ‚Äî –±–µ–∑ —ç—Ç–æ–≥–æ.
    </p>

    <div class="btnRow">
      <button class="btn primary" id="btnGeoErrRetry">–ï—â—ë —Ä–∞–∑</button>
      <button class="btn" id="btnGeoErrBot">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–µ–æ –≤ Telegram</button>
    </div>

    <button class="btn" id="btnGeoErrBack">–ù–∞–∑–∞–¥</button>
  </div>

  <!-- ===================== CABINET ===================== -->
  <div class="screen" id="cabinet">
    <div class="profileTop">
      <div>
        <div class="profileName" id="cabinetName">–ì–æ—Å—Ç—å</div>
        <div class="profileMeta" id="cabinetMeta">–°–µ–∞–Ω—Å–æ–≤: 0 ¬∑ –û—Ü–µ–Ω–æ–∫: 0</div>
      </div>
    </div>

    <div class="panel soft" id="cabinetNowPanel">
      <div class="row">
        <div>
          <b>–°–µ–π—á–∞—Å</b><br>
          <span class="small">–ü—Ä–æ—Ü–µ—Å—Å —É–∂–µ –Ω–∞—á–∞–ª—Å—è. –ù–µ –≤–º–µ—à–∏–≤–∞–π—Ç–µ—Å—å.</span>
        </div>
        <span class="pill brass" id="cabinetNowStatus">‚Ä¶</span>
      </div>

      <button class="btn" id="btnBackToWaiting">–í–µ—Ä–Ω—É—Ç—å—Å—è</button>
    </div>

    <div class="sectionTitle">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –º–æ–º–µ–Ω—Ç—ã</div>
    <div id="cabinetMoments"></div>

    <div class="btnRow">
      <button class="btn" id="btnArchive">–ê—Ä—Ö–∏–≤</button>
      <button class="btn primary" id="btnNewMoment">–ù–æ–≤—ã–π –º–æ–º–µ–Ω—Ç</button>
    </div>

    <div class="sectionTitle">–ó–Ω–∞–∫–∏</div>
    <div class="achGrid" id="cabinetAchievements"></div>
  </div>

  <!-- ===================== ARCHIVE ===================== -->
  <div class="screen" id="archive">
    <div class="row">
      <h1 style="margin:0">–ê—Ä—Ö–∏–≤</h1>
      <span class="badge" id="archiveCount">‚Ä¶</span>
    </div>

    <p class="small">–ó–¥–µ—Å—å –ª–µ–∂–∞—Ç –º–æ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ —Å–ª—É—á–∏–ª–∏—Å—å.</p>

    <div id="archiveList"></div>

    <button class="btn" id="btnArchiveBack">–ù–∞–∑–∞–¥</button>
  </div>

  <!-- ===================== MOMENT ===================== -->
  <div class="screen" id="moment">
    <h1 id="momentTitle">–ú–æ–º–µ–Ω—Ç</h1>
    <p class="small" id="momentTime"></p>

    <div class="panel" id="momentAnswers"></div>

    <div class="panel soft">
      <b>–û—Ü–µ–Ω–∫–∞</b>
      <p class="small">–ù–µ –≤–∫—É—Å. –ù–µ —Ç–∞–±–∞–∫. –†–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–º–µ–Ω—Ç–∞.</p>

      <div class="btnRow">
        <button class="btn" id="rateBad">–°–ª–∞–±–æ</button>
        <button class="btn" id="rateOk">–•–æ—Ä–æ—à–æ</button>
        <button class="btn primary" id="ratePerfect">–ò–¥–µ–∞–ª—å–Ω–æ</button>
      </div>

      <button class="btn" id="btnTip">–û—Å—Ç–∞–≤–∏—Ç—å –∂–µ—Å—Ç</button>
    </div>

    <button class="btn" id="btnMomentBack">–ù–∞–∑–∞–¥</button>
  </div>

  <!-- ===================== COURSE ===================== -->
  <div class="screen" id="course">
    <h1 id="courseTitle">–ù–µ –¥—É–º–∞–π—Ç–µ –¥–æ–ª–≥–æ.</h1>
    <p class="small" id="courseText">–ö –∫–∞–∫–æ–º—É —Ü–≤–µ—Ç—É —Ç—è–Ω–µ—Ç—Å—è —Ä—É–∫–∞ —Å–µ–π—á–∞—Å?</p>

    <div id="courseOptions"></div>

    <button class="btn" id="btnCourseBack">–ù–∞–∑–∞–¥</button>
  </div>

  <!-- ===================== WAITING ===================== -->
  <div class="screen" id="waiting">
    <h1 id="waitTitle">–ü—Ä–æ—Ü–µ—Å—Å –Ω–∞—á–∞–ª—Å—è.</h1>
    <p class="small" id="waitText">–ù–µ —Ç–æ—Ä–æ–ø–∏—Ç–µ –º–æ–º–µ–Ω—Ç.</p>

    <div class="hourglass">
      <div class="sandTop" id="sandTop"></div>
      <div class="sandStream"></div>
      <div class="sandBottom" id="sandBottom"></div>
    </div>

    <div class="timer" id="guestTimer">25:00</div>
    <p class="small" style="text-align:center" id="guestHint"></p>

    <button class="btn" id="btnWaitingToCabinet">–í –∫–∞–±–∏–Ω–µ—Ç</button>
  </div>

  <!-- ===================== EPILOGUE ===================== -->
  <div class="screen" id="epilogue">
    <h1>–≠—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ</h1>
    <p>
      –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞.<br><br>
      –î–∞–ª—å—à–µ ‚Äî –±–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.
    </p>

    <button class="btn" id="btnEpilogueToCabinet">–í –∫–∞–±–∏–Ω–µ—Ç</button>
  </div>

  <!-- ===================== MASTER ===================== -->
  <div class="screen" id="master">
    <div class="row">
      <div>
        <div class="kitchenTitle">–ö—É—Ö–Ω—è</div>
        <div class="kitchenSub">–ó–¥–µ—Å—å –Ω–µ ‚Äú–∑–∞–∫–∞–∑—ã‚Äù. –ó–¥–µ—Å—å ‚Äî –º–æ–º–µ–Ω—Ç—ã.</div>
      </div>
      <span class="badge" id="masterStatus">‚Ä¶</span>
    </div>

    <div id="masterList"></div>

    <button class="btn" id="btnMasterRefresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
  </div>

</div>

<script>
/* ===================== CONFIG ===================== */
const BACKEND_BASE = "https://hookah-mix-bot-56x5.onrender.com";
const MASTER_ID = 1292778768;

const DURATION_MS = 25 * 60 * 1000;
const TIP_URL = "https://netmonet.co/qr/192937/tip?o=6";

const GEOFENCE = { lat: 56.519963, lon: 84.933527, radiusM: 40 };
const GEO_TTL_MS = 2 * 60 * 60 * 1000;

const MUSIC_VOLUME = 0.3;

const tg = window.Telegram?.WebApp;
const tgUser = tg?.initDataUnsafe?.user || null;
const isMaster = tgUser && tgUser.id === MASTER_ID;

const guest = {
  id: tgUser?.id,
  name: tgUser?.first_name || "–ì–æ—Å—Ç—å",
  username: tgUser?.username || ""
};

const LS_MOMENT_IDS = "hm_moment_ids";
const LS_GEO_UNTIL = "hm_geo_until";
const LS_MUSIC_ON = "hm_music_on";

let guestTimerInt = null;

/* ===================== UI ===================== */
function go(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id)?.classList.add("active");
}

function escapeHtml(str=""){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function getMomentIds(){
  try { return JSON.parse(localStorage.getItem(LS_MOMENT_IDS)||"[]"); }
  catch { return []; }
}
function addMomentId(id){
  const ids = getMomentIds();
  if(!ids.includes(id)) ids.push(id);
  localStorage.setItem(LS_MOMENT_IDS, JSON.stringify(ids));
  return ids;
}

function setGeoAccessUntil(ts){
  localStorage.setItem(LS_GEO_UNTIL, String(ts));
}
function hasGeoAccessNow(){
  const until = Number(localStorage.getItem(LS_GEO_UNTIL)||0);
  return Date.now() < until;
}

/* ===================== MUSIC ===================== */
const audioEl = document.getElementById("bgMusic");
const btnSound = document.getElementById("soundBtnFloating");

function setSoundBtn(on){
  btnSound.classList.toggle("on", !!on);
  btnSound.classList.toggle("off", !on);
}

async function playMusic(){
  try{
    audioEl.volume = MUSIC_VOLUME;
    await audioEl.play();
    localStorage.setItem(LS_MUSIC_ON,"1");
    setSoundBtn(true);
  }catch(e){
    console.warn("Music blocked:", e);
    localStorage.setItem(LS_MUSIC_ON,"0");
    setSoundBtn(false);
  }
}
function pauseMusic(){
  audioEl.pause();
  localStorage.setItem(LS_MUSIC_ON,"0");
  setSoundBtn(false);
}

btnSound.addEventListener("click",()=>{
  if(audioEl.paused) playMusic();
  else pauseMusic();
});

/* ===================== GEO ===================== */
function distanceMeters(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const toRad = v => v*Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function isInsideFence(lat, lon){
  const d = distanceMeters(lat, lon, GEOFENCE.lat, GEOFENCE.lon);
  return d <= GEOFENCE.radiusM;
}
function requestLocation(){
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation) return reject(new Error("no_geolocation"));
    navigator.geolocation.getCurrentPosition(
      (pos)=>resolve({lat:pos.coords.latitude, lon:pos.coords.longitude, accuracy:pos.coords.accuracy}),
      (err)=>reject(err),
      { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
    );
  });
}

/* ===================== API ===================== */
async function safeJson(r){
  const t = await r.text();
  try { return JSON.parse(t); } catch { return {ok:false, raw:t}; }
}

async function apiGetMoments(limit=200){
  const r = await fetch(`${BACKEND_BASE}/moments?limit=${limit}`);
  const data = await safeJson(r);
  if(!r.ok) throw new Error("getMoments failed");
  return data;
}

async function apiCreateMoment(moment){
  const r = await fetch(`${BACKEND_BASE}/moment`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(moment)
  });
  const data = await safeJson(r);
  if(!r.ok) throw new Error("createMoment failed");
  return data;
}

async function apiSetMomentStatus(id,status){
  const r = await fetch(`${BACKEND_BASE}/moment/${id}/status`,{
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({status})
  });
  const data = await safeJson(r);
  if(!r.ok) throw new Error("setStatus failed");
  return data;
}

async function apiSetMomentRating(id,rating){
  const r = await fetch(`${BACKEND_BASE}/moment/${id}/rating`,{
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({rating})
  });
  const data = await safeJson(r);
  if(!r.ok) throw new Error("setRating failed");
  return data;
}

/* ===================== FLOW ===================== */
const EPITHETS = ["–°—É—Ö–∞—è –¢–∏—à–∏–Ω–∞","–¢–∏—Ö–∞—è –ù–æ—á—å","–ß—ë—Ä–Ω–∞—è –¢–µ–Ω—å","–ë–µ–ª—ã–π –®—É–º","–•–æ–ª–æ–¥–Ω—ã–π –°–≤–µ—Ç","–¢—ë–ø–ª—ã–π –ú–µ—Ç–∞–ª–ª","–ú–µ–¥–Ω—ã–π –ü–µ–ø–µ–ª","–ù–µ—Ä–≤–Ω–∞—è –ö–æ–º–Ω–∞—Ç–∞"];
function randomEpithet(){
  return EPITHETS[Math.floor(Math.random()*EPITHETS.length)];
}

const QUESTIONS = [
  { title:"–ù–µ –¥—É–º–∞–π—Ç–µ –¥–æ–ª–≥–æ.", text:"–ö –∫–∞–∫–æ–º—É —Ü–≤–µ—Ç—É —Ç—è–Ω–µ—Ç—Å—è —Ä—É–∫–∞ —Å–µ–π—á–∞—Å?", options:["–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π","–ó–µ–ª—ë–Ω—ã–π","–°–∏–Ω–∏–π","–§–∏–æ–ª–µ—Ç–æ–≤—ã–π","–ë–µ–ª—ã–π"] },
  { title:"–û—â—É—â–µ–Ω–∏–µ.", text:"–ù–µ –≤–∫—É—Å. –ù–µ –∑–∞–ø–∞—Ö. –û—â—É—â–µ–Ω–∏–µ –≤–æ —Ä—Ç—É ‚Äî", options:["–°—É—Ö–æ","–ú—è–≥–∫–æ","–ü–ª–æ—Ç–Ω–æ","–ü—É—Å—Ç–æ"] },
  { title:"–ï—Å–ª–∏ —Å–¥–µ–ª–∞—Ç—å –ø–∞—É–∑—É.", text:"–ù–µ –ø–µ—Ä–µ–∫—É—Å–∏—Ç—å. –ü—Ä–æ—Å—Ç–æ –ø–∞—É–∑—É.", options:["–û—Ä–µ—Ö","–§—Ä—É–∫—Ç","–•–ª–µ–±","–ù–∏—á–µ–≥–æ"] },
  { title:"–°–∫–æ—Ä–æ—Å—Ç—å.", text:"–≠—Ç–æ –≤—Ä–µ–º—è —Ö–æ—á–µ—Ç—Å—è –ø—Ä–æ–∂–∏—Ç—å ‚Äî", options:["–ú–µ–¥–ª–µ–Ω–Ω–æ","–†—ã–≤–∫–∞–º–∏","–†–æ–≤–Ω–æ","–ù–µ —á—É–≤—Å—Ç–≤—É—è –≤—Ä–µ–º–µ–Ω–∏"] },
  { title:"–ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ.", text:"–ï—Å–ª–∏ –∑–∞–∫—Ä—ã—Ç—å –≥–ª–∞–∑–∞, –≤–æ–∫—Ä—É–≥ —Å–µ–π—á–∞—Å ‚Äî", options:["–ü–æ–ª—É–º—Ä–∞–∫","–Ø—Ä–∫–∏–π —Å–≤–µ—Ç","–¢–µ–Ω—å","–ù–∏—á–µ–≥–æ"] },
  { title:"–≠—Ç–æ—Ç –º–æ–º–µ–Ω—Ç ‚Äî", text:"–Ω–µ –ø—Ä–æ –ø–ª–∞–Ω—ã –∏ –Ω–µ –ø—Ä–æ —Ü–µ–ª–∏.", options:["–ù–∞—á–∞–ª–æ","–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ","–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ"] },
  { title:"–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞.", text:"–≠—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ‚Äî", options:["–•–æ–ª–æ–¥","–¢–µ–ø–ª–æ","–ë–µ–∑ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã","–ö–æ–Ω—Ç—Ä–∞—Å—Ç"] },
  { title:"–¢–µ–ª–æ.", text:"–≠—Ç–æ –¥–æ–ª–∂–Ω–æ –æ—â—É—â–∞—Ç—å—Å—è ‚Äî", options:["–ü–æ—á—Ç–∏ –≤–ø–ª–æ—Ç–Ω—É—é","–ù–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏","–í–æ–∑–¥—É—à–Ω–æ","–¢—è–∂–µ–ª–æ"] },
  { title:"–ú–∞—Ç–µ—Ä–∏–∞–ª.", text:"–ë–ª–∏–∂–µ –∫ —á–µ–º—É?", options:["–ë–∞—Ä—Ö–∞—Ç","–ú–µ—Ç–∞–ª–ª","–î–µ—Ä–µ–≤–æ","–°—Ç–µ–∫–ª–æ"] },
  { title:"–ó–∞–ø—Ä–µ—Ç.", text:"–ß—Ç–æ —Å–µ–≥–æ–¥–Ω—è –Ω–µ–ª—å–∑—è –≤–ø—É—Å–∫–∞—Ç—å?", options:["–¶–∏—Ç—Ä—É—Å","–Ø–≥–æ–¥—ã","–î–µ—Å–µ—Ä—Ç","–¢—è–∂—ë–ª—ã–µ —Å–ø–µ—Ü–∏–∏","–ú—è—Ç–∞"] },
  { title:"–í–µ—Å.", text:"–≠—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ‚Äî", options:["–õ–µ–≥–∫–æ","–†–æ–≤–Ω–æ","–ü–ª–æ—Ç–Ω–æ","–¢—è–∂–µ–ª–æ"] },
];

let courseAnswers = {};
let courseIndex = 0;

function renderCourse(){
  const q = QUESTIONS[courseIndex];
  document.getElementById("courseTitle").textContent = q.title;
  document.getElementById("courseText").textContent = q.text;

  const box = document.getElementById("courseOptions");
  box.innerHTML = "";

  q.options.forEach(opt=>{
    const div = document.createElement("div");
    div.className = "option";
    div.textContent = opt;
    div.onclick = ()=>pickCourse(opt);
    box.appendChild(div);
  });
}

async function pickCourse(val){
  courseAnswers[courseIndex+1] = val;
  courseIndex++;

  if(courseIndex < QUESTIONS.length){
    renderCourse();
    return;
  }

  await createMomentFromAnswers();
}

async function createMomentFromAnswers(){
  const id = Date.now()+"_"+Math.random().toString(36).slice(2,6);

  const moment = {
    id,
    createdAt: Date.now(),
    status: "new",
    guest,
    answers: courseAnswers,
    epithet: randomEpithet(),
    rating: null,
    acceptedAt: null
  };

  addMomentId(id);

  try{ await apiCreateMoment(moment); }catch(e){ console.error(e); }

  go("waiting");
  startWaitingLoop();
}

/* ===================== WAITING ===================== */
function formatClock(ms){
  const total = Math.max(0, Math.floor(ms/1000));
  const m = Math.floor(total/60);
  const s = total%60;
  return `${m}:${String(s).padStart(2,"0")}`;
}

function setSand(progress01){
  const p = Math.max(0, Math.min(1, progress01));
  const top = document.getElementById("sandTop");
  const bottom = document.getElementById("sandBottom");

  // –≤–µ—Ä—Ö —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è, –Ω–∏–∑ —Ä–∞—Å—Ç—ë—Ç
  top.style.height = `${Math.max(0, 48 - (48*p))}%`;
  bottom.style.height = `${Math.max(0, 48*p)}%`;
}

async function startWaitingLoop(){
  clearInterval(guestTimerInt);

  const timerEl = document.getElementById("guestTimer");
  const hintEl = document.getElementById("guestHint");

  async function tick(){
    try{
      const ids = getMomentIds();
      const data = await apiGetMoments(200);
      const mine = (data.moments||[]).filter(m=>ids.includes(m.id));
      const active = mine.find(m=>m.status !== "finished") || null;

      if(!active){
        go("cabinet");
        await renderCabinet();
        return;
      }

      if(!active.acceptedAt){
        document.getElementById("waitTitle").textContent = "–¢–∏—à–∏–Ω–∞.";
        document.getElementById("waitText").textContent = "–ö—É—Ö–Ω—è –µ—â—ë –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∞.";
        timerEl.textContent = "‚Äî:‚Äî";
        hintEl.textContent = "–í—Ä–µ–º—è –Ω–∞—á–Ω—ë—Ç—Å—è, –∫–æ–≥–¥–∞ –∫—É—Ö–Ω—è –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç.";
        setSand(0);
        return;
      }

      const left = (active.acceptedAt + DURATION_MS) - Date.now();
      const progress = 1 - (left / DURATION_MS);

      if(left <= 0 || active.status === "finished"){
        go("epilogue");
        return;
      }

      document.getElementById("waitTitle").textContent = "–ü—Ä–æ—Ü–µ—Å—Å –Ω–∞—á–∞–ª—Å—è.";
      document.getElementById("waitText").textContent = "–ù–µ —Ç–æ—Ä–æ–ø–∏—Ç–µ –º–æ–º–µ–Ω—Ç.";
      timerEl.textContent = formatClock(left);
      hintEl.textContent = "–ü–µ—Å–æ–∫ –∏–¥—ë—Ç. –ù–µ –≤–º–µ—à–∏–≤–∞–π—Ç–µ—Å—å.";
      setSand(progress);

    }catch(e){
      hintEl.textContent = "–ù–µ—Ç —Å–≤—è–∑–∏.";
    }
  }

  await tick();
  guestTimerInt = setInterval(tick, 2000);
}

/* ===================== CABINET / ARCHIVE / MOMENT ===================== */
function calcAchievements(moments){
  const sessions = moments.length;
  const rated = moments.filter(m=>!!m.rating).length;

  return [
    { title:"–ü–µ—Ä–≤—ã–π –º–æ–º–µ–Ω—Ç", desc:"–í—ã –≤–æ—à–ª–∏.", unlocked:sessions>=1 },
    { title:"–í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ", desc:"–í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å.", unlocked:sessions>=2 },
    { title:"–ß–µ—Å—Ç–Ω–æ—Å—Ç—å", desc:"–í—ã –æ—Ü–µ–Ω–∏–ª–∏ —Ç—Ä–∏.", unlocked:rated>=3 },
  ];
}

async function renderCabinet(){
  const ids = getMomentIds();

  document.getElementById("cabinetName").textContent = guest.name;

  const momentsBox = document.getElementById("cabinetMoments");
  const achBox = document.getElementById("cabinetAchievements");
  const metaEl = document.getElementById("cabinetMeta");

  const nowPanel = document.getElementById("cabinetNowPanel");
  const nowStatus = document.getElementById("cabinetNowStatus");

  try{
    const data = await apiGetMoments(200);
    const mine = (data.moments||[])
      .filter(m=>ids.includes(m.id))
      .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

    const rated = mine.filter(m=>!!m.rating).length;
    metaEl.textContent = `–°–µ–∞–Ω—Å–æ–≤: ${mine.length} ¬∑ –û—Ü–µ–Ω–æ–∫: ${rated}`;

    const active = mine.find(m=>m.status !== "finished") || null;
    nowPanel.style.display = active ? "block" : "none";
    nowStatus.textContent = active ? "–í –ø—Ä–æ—Ü–µ—Å—Å–µ" : "–ü—É—Å—Ç–æ";

    momentsBox.innerHTML = "";
    const last = mine.slice(0,3);

    if(!last.length){
      momentsBox.innerHTML = `<p class="small">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–æ –∑–∞–ª —É–∂–µ –∑–¥–µ—Å—å.</p>`;
    }else{
      last.forEach(m=>{
        momentsBox.innerHTML += `
          <div class="momentCard">
            <div class="momentTitleRow">
              <div>
                <div class="momentTitle">${escapeHtml(m.epithet||"–ú–æ–º–µ–Ω—Ç")}</div>
                <div class="momentTime">${new Date(m.createdAt||Date.now()).toLocaleString("ru-RU")}</div>
              </div>
              <span class="pill brass">${escapeHtml(m.status||"‚Ä¶")}</span>
            </div>
            <button class="btn" style="margin-top:12px" onclick="openMoment('${escapeHtml(m.id)}')">–û—Ç–∫—Ä—ã—Ç—å</button>
          </div>
        `;
      });
    }

    const ach = calcAchievements(mine);
    achBox.innerHTML = "";
    ach.forEach(a=>{
      achBox.innerHTML += `
        <div class="achCard ${a.unlocked ? "" : "locked"}">
          <div class="achTitle">${escapeHtml(a.title)}</div>
          <div class="achDesc">${escapeHtml(a.desc)}</div>
        </div>
      `;
    });

  }catch(e){
    momentsBox.innerHTML = `<p class="small">–ù–µ—Ç —Å–≤—è–∑–∏.</p>`;
  }
}

let OPEN_MOMENT_ID = null;

window.openMoment = async function(id){
  OPEN_MOMENT_ID = id;
  go("moment");
  await renderMoment();
}

async function renderArchive(){
  const ids = getMomentIds();
  const box = document.getElementById("archiveList");
  const count = document.getElementById("archiveCount");

  try{
    const data = await apiGetMoments(200);
    const mine = (data.moments||[])
      .filter(m=>ids.includes(m.id))
      .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

    count.textContent = String(mine.length);
    box.innerHTML = "";

    if(!mine.length){
      box.innerHTML = `<p class="small">–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç.</p>`;
      return;
    }

    mine.forEach(m=>{
      box.innerHTML += `
        <div class="momentCard">
          <div class="momentTitleRow">
            <div>
              <div class="momentTitle">${escapeHtml(m.epithet||"–ú–æ–º–µ–Ω—Ç")}</div>
              <div class="momentTime">${new Date(m.createdAt||Date.now()).toLocaleString("ru-RU")}</div>
            </div>
            <span class="pill brass">${escapeHtml(m.rating ? "–û—Ü–µ–Ω–µ–Ω–æ" : "–ë–µ–∑ –æ—Ü–µ–Ω–∫–∏")}</span>
          </div>
          <button class="btn" style="margin-top:12px" onclick="openMoment('${escapeHtml(m.id)}')">–û—Ç–∫—Ä—ã—Ç—å</button>
        </div>
      `;
    });

  }catch(e){
    box.innerHTML = `<p class="small">–ù–µ—Ç —Å–≤—è–∑–∏.</p>`;
  }
}

async function renderMoment(){
  const id = OPEN_MOMENT_ID;
  const ids = getMomentIds();

  const titleEl = document.getElementById("momentTitle");
  const timeEl = document.getElementById("momentTime");
  const answersEl = document.getElementById("momentAnswers");

  if(!id || !ids.includes(id)){
    titleEl.textContent = "–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ";
    timeEl.textContent = "";
    answersEl.innerHTML = "";
    return;
  }

  try{
    const data = await apiGetMoments(200);
    const m = (data.moments||[]).find(x=>x.id===id);
    if(!m) return;

    titleEl.textContent = m.epithet || "–ú–æ–º–µ–Ω—Ç";
    timeEl.textContent = new Date(m.createdAt||Date.now()).toLocaleString("ru-RU");

    answersEl.innerHTML = `<b>–£—Å–ª–æ–≤–∏—è</b><br><br>` +
      Object.entries(m.answers||{}).map(([k,v])=>`<div class="small">${escapeHtml(String(v))}</div>`).join("");

  }catch(e){
    console.error(e);
  }
}

/* ===================== MASTER ===================== */
async function renderMaster(){
  const list = document.getElementById("masterList");
  const status = document.getElementById("masterStatus");

  try{
    const data = await apiGetMoments(200);
    const moments = (data.moments||[]).slice().sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

    status.textContent = String(moments.length);
    list.innerHTML = "";

    if(!moments.length){
      list.innerHTML = `<p class="small">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</p>`;
      return;
    }

    moments.forEach(m=>{
      list.innerHTML += `
        <div class="kitchenCard ${m.status==="new" ? "new" : ""}">
          <div class="kitchenName">${escapeHtml(m.guest?.name || "–ì–æ—Å—Ç—å")}</div>
          <div class="kitchenMeta">${new Date(m.createdAt||Date.now()).toLocaleString("ru-RU")}</div>

          <div class="kitchenBtns">
            <button class="btn" onclick="setMasterStatus('${escapeHtml(m.id)}','accepted')">–ö—É—Ö–Ω—è —É—Å–ª—ã—à–∞–ª–∞</button>
            <button class="btn" onclick="setMasterStatus('${escapeHtml(m.id)}','in_progress')">–ü–µ—á—å —Ä–∞–±–æ—Ç–∞–µ—Ç</button>
            <button class="btn" onclick="setMasterStatus('${escapeHtml(m.id)}','serving')">–ü–æ–¥–∞—á–∞</button>
            <button class="btn primary" onclick="setMasterStatus('${escapeHtml(m.id)}','finished')">–ú–æ–º–µ–Ω—Ç —Å–ª—É—á–∏–ª—Å—è</button>
          </div>
        </div>
      `;
    });

  }catch(e){
    status.textContent = "–Ω–µ—Ç —Å–≤—è–∑–∏";
    list.innerHTML = `<p class="small">–ù–µ—Ç —Å–≤—è–∑–∏.</p>`;
  }
}

window.setMasterStatus = async function(id,status){
  try{
    await apiSetMomentStatus(id,status);
    await renderMaster();
  }catch(e){
    console.error(e);
  }
}

/* ===================== EVENTS ===================== */
document.getElementById("gateLogo").addEventListener("click", async ()=>{
  await playMusic();
  document.getElementById("gateWrap").classList.add("gateOut");
  setTimeout(()=>go("welcome"), 520);
});

document.getElementById("btnWelcomeStart").addEventListener("click", ()=>{
  courseAnswers = {};
  courseIndex = 0;
  go("course");
  renderCourse();
});

document.getElementById("btnCourseBack").addEventListener("click", ()=>{
  if(courseIndex<=0){ go("welcome"); return; }
  courseIndex = Math.max(0, courseIndex-1);
  renderCourse();
});

document.getElementById("btnWaitingToCabinet").addEventListener("click", async ()=>{
  go("cabinet");
  await renderCabinet();
});

document.getElementById("btnEpilogueToCabinet").addEventListener("click", async ()=>{
  go("cabinet");
  await renderCabinet();
});

document.getElementById("btnArchive").addEventListener("click", async ()=>{
  go("archive");
  await renderArchive();
});

document.getElementById("btnArchiveBack").addEventListener("click", async ()=>{
  go("cabinet");
  await renderCabinet();
});

document.getElementById("btnMomentBack").addEventListener("click", async ()=>{
  go("archive");
  await renderArchive();
});

document.getElementById("btnTip").addEventListener("click", ()=>{
  window.open(TIP_URL, "_blank");
});

document.getElementById("rateBad").addEventListener("click", async ()=>{
  if(!OPEN_MOMENT_ID) return;
  await apiSetMomentRating(OPEN_MOMENT_ID,"bad");
  alert("–ó–∞–ø–æ–º–Ω–∏–ª.");
});
document.getElementById("rateOk").addEventListener("click", async ()=>{
  if(!OPEN_MOMENT_ID) return;
  await apiSetMomentRating(OPEN_MOMENT_ID,"ok");
  alert("–ó–∞–ø–æ–º–Ω–∏–ª.");
});
document.getElementById("ratePerfect").addEventListener("click", async ()=>{
  if(!OPEN_MOMENT_ID) return;
  await apiSetMomentRating(OPEN_MOMENT_ID,"perfect");
  alert("–ó–∞–ø–æ–º–Ω–∏–ª.");
});

document.getElementById("btnNewMoment").addEventListener("click", ()=>{
  // –Ω–æ–≤—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–Ω–æ–≤–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –¥–≤–µ—Ä—å/–≥–µ–æ ‚Äî —Ç–æ–ª—å–∫–æ –∫—É—Ä—Å
  courseAnswers = {};
  courseIndex = 0;
  go("course");
  renderCourse();
});

document.getElementById("btnBackToWaiting").addEventListener("click", ()=>{
  go("waiting");
  startWaitingLoop();
});

document.getElementById("btnMasterRefresh").addEventListener("click", renderMaster);

/* ===================== DOOR FLOW EVENTS ===================== */
async function openDoorFlow(){
  try{
    const pos = await requestLocation();
    const ok = isInsideFence(pos.lat, pos.lon);

    if(!ok){
      go("outside");
      return;
    }

    setGeoAccessUntil(Date.now()+GEO_TTL_MS);
    go("soundGate");

  }catch(e){
    if(e?.code===1) go("no-permission");
    else go("geo-error");
  }
}

document.getElementById("btnDoor").addEventListener("click", openDoorFlow);
document.getElementById("btnDoorBot").addEventListener("click", ()=>{
  alert("–û—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é –≤ —á–∞—Ç –±–æ—Ç–∞ –∫–Ω–æ–ø–∫–æ–π Telegram ¬´üìç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é¬ª.");
});

document.getElementById("btnOutsideRetry").addEventListener("click", openDoorFlow);
document.getElementById("btnOutsideBack").addEventListener("click", ()=>go("door"));

document.getElementById("btnNoPermRetry").addEventListener("click", openDoorFlow);
document.getElementById("btnNoPermBack").addEventListener("click", ()=>go("door"));

document.getElementById("btnGeoErrRetry").addEventListener("click", openDoorFlow);
document.getElementById("btnGeoErrBot").addEventListener("click", ()=>{
  alert("–û—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é –≤ —á–∞—Ç –±–æ—Ç–∞ –∫–Ω–æ–ø–∫–æ–π Telegram ¬´üìç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é¬ª.");
});
document.getElementById("btnGeoErrBack").addEventListener("click", ()=>go("door"));

/* ===================== START ===================== */
document.addEventListener("DOMContentLoaded", async ()=>{
  try{
    tg?.ready();
    tg?.expand();
  }catch{}

  // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –∫–Ω–æ–ø–∫—É –∑–≤—É–∫–∞
  const musicOn = localStorage.getItem(LS_MUSIC_ON)==="1";
  setSoundBtn(musicOn);

  // –µ—Å–ª–∏ –º–∞—Å—Ç–µ—Ä ‚Äî —Å—Ä–∞–∑—É –∫—É—Ö–Ω—è
  if(isMaster){
    go("master");
    renderMaster();
    setInterval(renderMaster, 3000);
    return;
  }

  
  // –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –º–æ–º–µ–Ω—Ç—ã ‚Äî —Å—Ä–∞–∑—É –∫–∞–±–∏–Ω–µ—Ç
  const ids = getMomentIds();
  if(ids.length){
    go("cabinet");
    await renderCabinet();
    return;
  }

  // –µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ –≥–µ–æ ‚Äî —Å—Ä–∞–∑—É –∑–∞–ª
  if(hasGeoAccessNow()){
    go("soundGate");
    return;
  }

  // –∏–Ω–∞—á–µ –¥–≤–µ—Ä—å
  go("door");
});
</script>

</body>
</html>
