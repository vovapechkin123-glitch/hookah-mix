<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>THE MENU</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root { color-scheme: dark; }

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  background: radial-gradient(1200px 800px at 30% 20%, #2b2b38 0%, #0b0b12 55%, #05050a 100%);
  color:#fff;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:24px;
}

.card{
  width:min(600px,100%);
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  padding:22px;
  backdrop-filter: blur(10px);
  box-shadow:0 20px 60px rgba(0,0,0,.45);
}

.screen{display:none}
.screen.active{display:block}

h1{margin:0 0 12px;font-size:24px}
p{opacity:.85;line-height:1.5;margin:0 0 10px}

.btn{
  width:100%;
  margin-top:16px;
  padding:14px;
  border-radius:14px;
  border:0;
  font-size:16px;
  font-weight:700;
  cursor:pointer;
  background:linear-gradient(90deg,#ff7a18,#ff3d77);
  color:#fff;
}

.btn.secondary{
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.14);
}

.btnRow{
  display:flex;
  gap:10px;
  margin-top:12px;
}
.btnRow .btn{margin-top:0;width:100%}

.option{
  padding:14px;
  border-radius:14px;
  background:rgba(255,255,255,.08);
  margin-top:10px;
  cursor:pointer;
}
.option:hover{background:rgba(255,255,255,.14)}

.small{font-size:13px;opacity:.7}

.timer{
  font-size:30px;
  text-align:center;
  letter-spacing:2px;
  margin:14px 0
}

.order{
  background:rgba(255,255,255,.08);
  border-radius:14px;
  padding:14px;
  margin-top:12px;
}

.row{
  display:flex;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
  align-items:center
}

.badge{
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.12);
}
.badge.warn{background:rgba(255,140,0,.15)}
.badge.good{background:rgba(0,255,140,.15)}
.badge.done{background:rgba(255,255,255,.15)}

hr{
  border:0;
  border-top:1px solid rgba(255,255,255,.12);
  margin:12px 0
}
</style>
</head>

<body>
<div class="card">

  <!-- ===== –ì–û–°–¢ ===== -->

  <div class="screen" id="s0">
    <h1>–ü—Ä–µ–∂–¥–µ —á–µ–º –º—ã –Ω–∞—á–Ω—ë–º.</h1>
    <p>
      –ó–¥–µ—Å—å –Ω–µ –ø–æ–¥–±–∏—Ä–∞—é—Ç –≤–∫—É—Å.<br><br>
      –ó–¥–µ—Å—å —Ñ–∏–∫—Å–∏—Ä—É—é—Ç –º–æ–º–µ–Ω—Ç.<br><br>
      –¢–æ, —á—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ,<br>
      –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∑–∞—Ä–∞–Ω–µ–µ.
    </p>
    <button class="btn" onclick="go('q1')">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
  </div>

  <div class="screen" id="q1">
    <h1>–ù–µ –¥—É–º–∞–π—Ç–µ –¥–æ–ª–≥–æ.</h1>
    <p>–ö –∫–∞–∫–æ–º—É —Ü–≤–µ—Ç—É —Ç—è–Ω–µ—Ç—Å—è —Ä—É–∫–∞ —Å–µ–π—á–∞—Å?</p>
    <div class="option" onclick="pick(1,'–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π')">üü§ –ö–æ—Ä–∏—á–Ω–µ–≤—ã–π</div>
    <div class="option" onclick="pick(1,'–ó–µ–ª—ë–Ω—ã–π')">üü¢ –ó–µ–ª—ë–Ω—ã–π</div>
    <div class="option" onclick="pick(1,'–°–∏–Ω–∏–π')">üîµ –°–∏–Ω–∏–π</div>
    <div class="option" onclick="pick(1,'–§–∏–æ–ª–µ—Ç–æ–≤—ã–π')">üü£ –§–∏–æ–ª–µ—Ç–æ–≤—ã–π</div>
    <div class="option" onclick="pick(1,'–ë–µ–ª—ã–π')">‚ö™ –ë–µ–ª—ã–π</div>
  </div>

  <div class="screen" id="q2">
    <h1>–û—â—É—â–µ–Ω–∏–µ.</h1>
    <p>–ù–µ –≤–∫—É—Å. –ù–µ –∑–∞–ø–∞—Ö. –û—â—É—â–µ–Ω–∏–µ –≤–æ —Ä—Ç—É ‚Äî</p>
    <div class="option" onclick="pick(2,'–°—É—Ö–æ')">–°—É—Ö–æ</div>
    <div class="option" onclick="pick(2,'–ú—è–≥–∫–æ')">–ú—è–≥–∫–æ</div>
    <div class="option" onclick="pick(2,'–ü–ª–æ—Ç–Ω–æ')">–ü–ª–æ—Ç–Ω–æ</div>
    <div class="option" onclick="pick(2,'–ü—É—Å—Ç–æ')">–ü—É—Å—Ç–æ</div>
  </div>

  <div class="screen" id="q3">
    <h1>–ï—Å–ª–∏ —Å–¥–µ–ª–∞—Ç—å –ø–∞—É–∑—É.</h1>
    <p>–ù–µ –ø–µ—Ä–µ–∫—É—Å–∏—Ç—å. –ü—Ä–æ—Å—Ç–æ –ø–∞—É–∑—É.</p>
    <div class="option" onclick="pick(3,'–û—Ä–µ—Ö')">–û—Ä–µ—Ö</div>
    <div class="option" onclick="pick(3,'–§—Ä—É–∫—Ç')">–§—Ä—É–∫—Ç</div>
    <div class="option" onclick="pick(3,'–•–ª–µ–±')">–•–ª–µ–±</div>
    <div class="option" onclick="pick(3,'–ù–∏—á–µ–≥–æ')">–ù–∏—á–µ–≥–æ</div>
  </div>

  <div class="screen" id="q4">
    <h1>–°–∫–æ—Ä–æ—Å—Ç—å.</h1>
    <p>–≠—Ç–æ –≤—Ä–µ–º—è —Ö–æ—á–µ—Ç—Å—è –ø—Ä–æ–∂–∏—Ç—å ‚Äî</p>
    <div class="option" onclick="pick(4,'–ú–µ–¥–ª–µ–Ω–Ω–æ')">–ú–µ–¥–ª–µ–Ω–Ω–æ</div>
    <div class="option" onclick="pick(4,'–†—ã–≤–∫–∞–º–∏')">–†—ã–≤–∫–∞–º–∏</div>
    <div class="option" onclick="pick(4,'–†–æ–≤–Ω–æ')">–†–æ–≤–Ω–æ</div>
    <div class="option" onclick="pick(4,'–ù–µ —á—É–≤—Å—Ç–≤—É—è –≤—Ä–µ–º–µ–Ω–∏')">–ù–µ —á—É–≤—Å—Ç–≤—É—è –≤—Ä–µ–º–µ–Ω–∏</div>
  </div>

  <div class="screen" id="q5">
    <h1>–ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ.</h1>
    <p>–ï—Å–ª–∏ –∑–∞–∫—Ä—ã—Ç—å –≥–ª–∞–∑–∞, –≤–æ–∫—Ä—É–≥ —Å–µ–π—á–∞—Å ‚Äî</p>
    <div class="option" onclick="pick(5,'–ü–æ–ª—É–º—Ä–∞–∫')">–ü–æ–ª—É–º—Ä–∞–∫</div>
    <div class="option" onclick="pick(5,'–Ø—Ä–∫–∏–π —Å–≤–µ—Ç')">–Ø—Ä–∫–∏–π —Å–≤–µ—Ç</div>
    <div class="option" onclick="pick(5,'–¢–µ–Ω—å')">–¢–µ–Ω—å</div>
    <div class="option" onclick="pick(5,'–ù–∏—á–µ–≥–æ')">–ù–∏—á–µ–≥–æ</div>
  </div>

  <div class="screen" id="q6">
    <h1>–≠—Ç–æ—Ç –º–æ–º–µ–Ω—Ç ‚Äî</h1>
    <p>–Ω–µ –ø—Ä–æ –ø–ª–∞–Ω—ã –∏ –Ω–µ –ø—Ä–æ —Ü–µ–ª–∏.</p>
    <div class="option" onclick="pick(6,'–ù–∞—á–∞–ª–æ')">–ù–∞—á–∞–ª–æ</div>
    <div class="option" onclick="pick(6,'–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ')">–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ</div>
    <div class="option" onclick="pick(6,'–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ')">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</div>
  </div>

  <div class="screen" id="waiting">
    <h1 id="waitTitle">–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç.</h1>
    <p id="waitText">–ö–∞–ª—å—è–Ω —É–∂–µ –≥–æ—Ç–æ–≤–∏—Ç—Å—è. –≠—Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ–ª—å–∑—è —É—Å–∫–æ—Ä–∏—Ç—å.</p>
    <div class="timer" id="guestTimer">25:00</div>
    <p class="small" id="guestHint"></p>
  </div>

  <div class="screen" id="epilogue">
    <h1>–≠—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ</h1>
    <p>
      –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞.<br><br>
      –î–∞–ª—å—à–µ ‚Äî –±–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.
    </p>
  </div>

  <!-- ===== –ú–ê–°–¢–ï–† ===== -->

  <div class="screen" id="master">
    <div class="row">
      <h1 style="margin:0">–ó–∞–∫–∞–∑—ã</h1>
      <span class="badge" id="masterStatus">‚Ä¶</span>
    </div>
    <div id="orders"></div>
    <hr>
    <button class="btn" onclick="refreshOrders(true)">–û–±–Ω–æ–≤–∏—Ç—å</button>
  </div>

</div>

<script>
/* ====== –ù–ê–°–¢–†–û–ô–ö–ò ====== */
const MASTER_ID = 1292778768;
const DURATION_MS = 25 * 60 * 1000;
const BACKEND_BASE = "https://hookah-mix-bot-56x5.onrender.com"; // Render
/* ======================= */

const tg = window.Telegram?.WebApp;
const tgUser = tg?.initDataUnsafe?.user;
const isMaster = !!(tgUser && tgUser.id === MASTER_ID);

const guest = {
  id: tgUser?.id ?? null,
  name: tgUser?.first_name ?? "–ì–æ—Å—Ç—å",
  username: tgUser?.username ?? null
};

const answers = {};
let guestOrderStart = null;
let guestOrderId = null;
let guestTimerInt = null;
let masterPollInt = null;
let guestStatusPollInt = null;

const LS_ORDER_ID = "hm_last_order_id";
const LS_ORDER_START = "hm_last_order_start";

function haptic(){ try{ tg?.HapticFeedback?.impactOccurred("light"); }catch{} }

function go(id){
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  const el = document.getElementById(id);
  if (el) el.classList.add("active");
  haptic();
  try{ tg?.expand(); }catch{}
}

function hasActiveScreen(){
  return !!document.querySelector(".screen.active");
}

function resetGuestState(){
  Object.keys(answers).forEach(k => delete answers[k]);

  if (guestTimerInt){ clearInterval(guestTimerInt); guestTimerInt = null; }
  if (guestStatusPollInt){ clearInterval(guestStatusPollInt); guestStatusPollInt = null; }

  guestOrderStart = null;
  guestOrderId = null;

  localStorage.removeItem(LS_ORDER_ID);
  localStorage.removeItem(LS_ORDER_START);

  const hint = document.getElementById("guestHint");
  if (hint) hint.textContent = "";

  const t = document.getElementById("guestTimer");
  if (t) t.textContent = "25:00";

  const wt = document.getElementById("waitTitle");
  const wp = document.getElementById("waitText");
  if (wt) wt.textContent = "–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç.";
  if (wp) wp.textContent = "–ö–∞–ª—å—è–Ω —É–∂–µ –≥–æ—Ç–æ–≤–∏—Ç—Å—è. –≠—Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ–ª—å–∑—è —É—Å–∫–æ—Ä–∏—Ç—å.";
}

/* ====== –ì–æ—Å—Ç—å: –æ—Ç–≤–µ—Ç—ã ====== */
function pick(step, value){
  answers[step] = value;
  if (step === 1) return go("q2");
  if (step === 2) return go("q3");
  if (step === 3) return go("q4");
  if (step === 4) return go("q5");
  if (step === 5) return go("q6");
  if (step === 6) return placeOrder();
}

/* ====== –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ ====== */
async function placeOrder(){
  const now = Date.now();
  const uid = `${now}_${Math.random().toString(36).slice(2,8)}`;

  guestOrderStart = now;
  guestOrderId = uid;

  // —Å–æ—Ö—Ä–∞–Ω—è–µ–º, —á—Ç–æ–±—ã polling –Ω–µ —Ç–µ—Ä—è–ª—Å—è
  localStorage.setItem(LS_ORDER_ID, guestOrderId);
  localStorage.setItem(LS_ORDER_START, String(guestOrderStart));

  const order = {
    id: uid,
    start: now,
    duration_ms: DURATION_MS,
    status: "accepted",
    guest,
    answers: {
      color: answers[1],
      mouthfeel: answers[2],
      pause: answers[3],
      speed: answers[4],
      space: answers[5],
      moment: answers[6]
    }
  };

  go("waiting");
  startGuestTimer();

  try{
    const r = await fetch(`${BACKEND_BASE}/order`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(order)
    });
    if(!r.ok) throw new Error("bad_status");
    document.getElementById("guestHint").textContent = "–ü—Ä–∏–Ω—è—Ç–æ.";
  }catch(e){
    document.getElementById("guestHint").textContent =
      "–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç –ª–æ–∫–∞–ª—å–Ω–æ. –°–≤—è–∑—å —Å –∑–∞–ª–æ–º –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.";
  }

  startGuestPolling();
}

/* ====== –¢–∞–π–º–µ—Ä –≥–æ—Å—Ç—è ====== */
function startGuestTimer(){
  if (guestTimerInt) clearInterval(guestTimerInt);
  const el = document.getElementById("guestTimer");

  guestTimerInt = setInterval(() => {
    if (!guestOrderStart) return;
    const diff = (guestOrderStart + DURATION_MS) - Date.now();
    if (diff <= 0){ el.textContent = "–ì–æ—Ç–æ–≤–æ"; return; }
    const m = Math.floor(diff / 60000);
    const s = Math.floor((diff % 60000) / 1000);
    el.textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }, 1000);
}

/* ====== Polling –≥–æ—Å—Ç—è ====== */
function startGuestPolling(){
  if (guestStatusPollInt) clearInterval(guestStatusPollInt);
  guestStatusPollInt = setInterval(pollMyOrderStatus, 2500);
  pollMyOrderStatus();
}

async function pollMyOrderStatus(){
  if (!guestOrderId) return;

  try{
    const r = await fetch(`${BACKEND_BASE}/orders?limit=200`);
    if (!r.ok) return;
    const data = await r.json();
    const list = Array.isArray(data.orders) ? data.orders : [];
    const mine = list.find(o => String(o.id) === String(guestOrderId));
    if (!mine) return;

    if (mine.status === "in_progress"){
      const wt = document.getElementById("waitTitle");
      const wp = document.getElementById("waitText");
      if (wt) wt.textContent = "–ü—Ä–æ—Ü–µ—Å—Å –Ω–∞—á–∞–ª—Å—è.";
      if (wp) wp.textContent = "–§–∏–Ω–∞–ª —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è. –ù–µ –≤–º–µ—à–∏–≤–∞–π—Ç–µ—Å—å.";
    }

    if (mine.status === "finished"){
      if (guestTimerInt){ clearInterval(guestTimerInt); guestTimerInt = null; }
      if (guestStatusPollInt){ clearInterval(guestStatusPollInt); guestStatusPollInt = null; }
      localStorage.removeItem(LS_ORDER_ID);
      localStorage.removeItem(LS_ORDER_START);
      go("epilogue");
    }
  }catch(e){}
}

/* ====== –ú–∞—Å—Ç–µ—Ä ====== */
function fmtRemaining(start){
  const diff = (Number(start) + DURATION_MS) - Date.now();
  if (diff <= 0) return { text:"–ì–æ—Ç–æ–≤–æ", done:true };
  const m = Math.floor(diff / 60000);
  const s = Math.floor((diff % 60000) / 1000);
  return { text:`${m}:${String(s).padStart(2,"0")}`, done:false };
}

function statusLabel(status){
  if (status === "finished") return { text:"–ó–∞–≤–µ—Ä—à–µ–Ω–æ", cls:"done" };
  if (status === "in_progress") return { text:"–ü—Ä–æ—Ü–µ—Å—Å", cls:"good" };
  return { text:"–ì–æ—Ç–æ–≤–∏—Ç—Å—è", cls:"warn" };
}

async function setOrderStatus(id, status){
  try{
    await fetch(`${BACKEND_BASE}/order/${encodeURIComponent(id)}/status`, {
      method:"PATCH",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ status })
    });
  }catch(e){}
  refreshOrders();
}

function renderOrders(list){
  const box = document.getElementById("orders");
  box.innerHTML = "";

  if (!list.length){
    box.innerHTML = `<p class="small">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤.</p>`;
    return;
  }

  list.sort((a,b) => Number(b.start) - Number(a.start));

  for (const o of list){
    const rem = fmtRemaining(o.start);
    const a = o.answers || {};
    const who = o.guest?.name || "–ì–æ—Å—Ç—å";
    const uname = o.guest?.username ? `@${o.guest.username}` : "";
    const st = statusLabel(o.status);

    let buttonsHTML = "";
    if (o.status !== "finished"){
      buttonsHTML = `
        <div class="btnRow">
          <button class="btn secondary" onclick="setOrderStatus('${String(o.id).replace(/'/g,"\\'")}', 'in_progress')">
            –ù–∞—á–∞—Ç—å
          </button>
          <button class="btn" onclick="setOrderStatus('${String(o.id).replace(/'/g,"\\'")}', 'finished')">
            –ó–∞–≤–µ—Ä—à–∏—Ç—å
          </button>
        </div>
      `;
    } else {
      buttonsHTML = `<div class="small">–°—Ç–∞—Ç—É—Å –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω.</div>`;
    }

    box.innerHTML += `
      <div class="order">
        <div class="row">
          <div><b>${who}</b> <span class="small">${uname}</span></div>
          <span class="badge ${st.cls}">${st.text}</span>
        </div>

        <div class="small">–û—Å—Ç–∞–ª–æ—Å—å: ${rem.text}</div>
        <hr>

        <div class="small">
          –¶–≤–µ—Ç: <b>${a.color ?? "‚Äî"}</b><br>
          –û—â—É—â–µ–Ω–∏–µ: <b>${a.mouthfeel ?? "‚Äî"}</b><br>
          –ü–∞—É–∑–∞: <b>${a.pause ?? "‚Äî"}</b><br>
          –°–∫–æ—Ä–æ—Å—Ç—å: <b>${a.speed ?? "‚Äî"}</b><br>
          –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ: <b>${a.space ?? "‚Äî"}</b><br>
          –ú–æ–º–µ–Ω—Ç: <b>${a.moment ?? "‚Äî"}</b>
        </div>

        ${buttonsHTML}
      </div>
    `;
  }
}

async function refreshOrders(forceToast=false){
  const badge = document.getElementById("masterStatus");
  badge.textContent = "–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶";

  try{
    const r = await fetch(`${BACKEND_BASE}/orders?limit=200`);
    if (!r.ok) throw new Error("bad_status");
    const data = await r.json();
    renderOrders(Array.isArray(data.orders) ? data.orders : []);
    badge.textContent = "–æ–Ω–ª–∞–π–Ω";
    if (forceToast) haptic();
  }catch(e){
    badge.textContent = "–Ω–µ—Ç —Å–≤—è–∑–∏";
    renderOrders([]);
  }
}

/* ====== –ï–î–ò–ù–´–ô –°–¢–ê–†–¢ ====== */
function startApp(){
  if (isMaster){
    go("master");
    refreshOrders();
    if (masterPollInt) clearInterval(masterPollInt);
    masterPollInt = setInterval(refreshOrders, 3000);
    return;
  }

  // –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π –∑–∞–∫–∞–∑ –≤ localStorage ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–æ—Å—Ç—è –≤ –æ–∂–∏–¥–∞–Ω–∏–µ
  const savedId = localStorage.getItem(LS_ORDER_ID);
  const savedStart = Number(localStorage.getItem(LS_ORDER_START) || 0);

  if (savedId && savedStart){
    guestOrderId = savedId;
    guestOrderStart = savedStart;
    go("waiting");
    startGuestTimer();
    startGuestPolling();
    return;
  }

  // –æ–±—ã—á–Ω—ã–π —Å—Ç–∞—Ä—Ç –≥–æ—Å—Ç—è
  if (!hasActiveScreen()){
    resetGuestState();
    go("s0");
  } else {
    const activeId = document.querySelector(".screen.active")?.id;
    if (activeId === "master"){
      resetGuestState();
      go("s0");
    }
  }
}

document.addEventListener("DOMContentLoaded", () => {
  try{ tg?.ready(); tg?.expand(); }catch{}
  startApp();

  try{
    tg?.onEvent("viewportChanged", () => startApp());
    tg?.onEvent("visibilityChanged", () => startApp());
    tg?.onEvent("backButtonClicked", () => {
      if (!isMaster){
        resetGuestState();
        go("s0");
      }
    });
  }catch{}
});
</script>

</body>
</html>
