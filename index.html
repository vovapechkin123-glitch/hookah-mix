<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>THE MENU</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
/* =========================
   THE MENU — 1 FILE UI
   ========================= */

:root{
  color-scheme: dark;

  /* palette (warm / brass / parchment) */
  --ink: rgba(255,255,255,.92);
  --muted: rgba(255,255,255,.68);
  --soft: rgba(255,255,255,.52);

  --brassA: #e7c27a;
  --brassB: #b77a33;
  --brassC: rgba(231,194,122,.18);
  --brassD: rgba(183,122,51,.14);

  --paperA: rgba(30,18,12,.78);
  --paperB: rgba(20,12,8,.72);
  --paperC: rgba(255,255,255,.06);

  --stroke: rgba(255,230,190,.10);
  --stroke2: rgba(255,255,255,.10);

  --shadow: 0 28px 80px rgba(0,0,0,.55);
  --shadow2: 0 18px 50px rgba(0,0,0,.45);

  --r16: 16px;
  --r18: 18px;
  --r22: 22px;
  --r26: 26px;

  --ease: cubic-bezier(.2,.9,.2,1);

  --safeTop: env(safe-area-inset-top, 0px);
  --safeBottom: env(safe-area-inset-bottom, 0px);
}

*{ box-sizing:border-box; }
html,body{ height:100%; }

body{
  margin:0;
  font-family: ui-serif, Georgia, "Times New Roman", serif;
  color:var(--ink);
  overflow-x:hidden;

  /* background texture image */
  background:
    radial-gradient(1200px 900px at 25% 10%, rgba(231,194,122,.12), transparent 60%),
    radial-gradient(900px 700px at 80% 30%, rgba(183,122,51,.12), transparent 60%),
    url("./bg.jpg") center/cover no-repeat fixed;
}

/* vignette + film */
body::before{
  content:"";
  position:fixed;
  inset:0;
  background:
    radial-gradient(1200px 900px at 50% 40%, rgba(0,0,0,.10), rgba(0,0,0,.58) 70%, rgba(0,0,0,.80) 100%),
    linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35) 30%, rgba(0,0,0,.52));
  pointer-events:none;
  z-index:0;
}

/* subtle noise layer (CSS-only) */
body::after{
  content:"";
  position:fixed;
  inset:0;
  opacity:.13;
  mix-blend-mode: overlay;
  background-image:
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.9'/%3E%3C/svg%3E");
  pointer-events:none;
  z-index:0;
}

#app{
  position:relative;
  z-index:1;
  min-height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  padding: calc(18px + var(--safeTop)) 18px calc(18px + var(--safeBottom));
}

/* main phone frame */
.frame{
  width:min(420px, 100%);
  border-radius: 26px;
  padding: 14px;
  background: rgba(0,0,0,.18);
  border: 1px solid rgba(255,255,255,.08);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  position:relative;
  overflow:hidden;
}

/* inner parchment panel */
.panel{
  border-radius: 22px;
  background:
    radial-gradient(800px 500px at 30% 10%, rgba(231,194,122,.08), transparent 60%),
    radial-gradient(700px 600px at 70% 90%, rgba(183,122,51,.08), transparent 60%),
    linear-gradient(180deg, rgba(30,18,12,.86), rgba(18,10,7,.82));
  border: 1px solid rgba(255,230,190,.10);
  box-shadow: var(--shadow2);
  overflow:hidden;
  position:relative;
}

/* inner bevel */
.panel::before{
  content:"";
  position:absolute;
  inset: 10px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.07);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.06),
    inset 0 -16px 30px rgba(0,0,0,.35);
  pointer-events:none;
  opacity:.95;
}

/* =========================
   TOP BAR + BOTTOM TABS
   ========================= */

.topbar{
  padding: 14px 14px 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  position:relative;
  z-index:2;
}

.brand{
  display:flex;
  align-items:center;
  gap:10px;
  letter-spacing:.18em;
  text-transform:uppercase;
  font-weight:700;
  font-size:12px;
  color: rgba(255,255,255,.78);
}
.brand .dot{
  width:6px;height:6px;border-radius:999px;
  background: rgba(231,194,122,.75);
  box-shadow: 0 0 0 4px rgba(231,194,122,.12);
}

.iconBtn{
  width:34px;height:34px;
  border-radius:999px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.22);
  color: rgba(255,255,255,.82);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
  transition: transform .14s var(--ease), border-color .14s var(--ease), opacity .14s var(--ease);
  user-select:none;
}
.iconBtn:hover{ border-color: rgba(231,194,122,.24); opacity:1; }
.iconBtn:active{ transform: translateY(1px) scale(.98); }
.iconBtn.on{
  border-color: rgba(231,194,122,.28);
  box-shadow: 0 0 0 4px rgba(231,194,122,.10);
}

.content{
  padding: 10px 14px 14px;
  position:relative;
  z-index:2;
  min-height: 520px;
}

.bottombar{
  padding: 10px 14px calc(12px + var(--safeBottom));
  display:flex;
  justify-content:space-between;
  gap:10px;
  position:relative;
  z-index:2;
}

.tab{
  width:100%;
  padding: 11px 12px;
  border-radius: 14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.20);
  color: rgba(255,255,255,.75);
  font-weight:700;
  font-size:13px;
  letter-spacing:.06em;
  text-transform:uppercase;
  cursor:pointer;
  transition: transform .14s var(--ease), background .14s var(--ease), border-color .14s var(--ease), color .14s var(--ease);
}
.tab:hover{ border-color: rgba(231,194,122,.20); }
.tab:active{ transform: translateY(1px) scale(.99); }
.tab.active{
  background: linear-gradient(180deg, rgba(231,194,122,.14), rgba(0,0,0,.20));
  border-color: rgba(231,194,122,.24);
  color: rgba(255,255,255,.88);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
}

/* =========================
   COMMON UI COMPONENTS
   ========================= */

.h1{
  font-size: 22px;
  margin:0 0 6px;
  letter-spacing:.02em;
  font-weight:800;
}
.sub{
  color: var(--muted);
  font-size: 13px;
  line-height:1.55;
  margin:0 0 10px;
}

.hr{
  height:1px;
  background: linear-gradient(90deg, transparent, rgba(231,194,122,.22), transparent);
  margin: 12px 0;
  opacity:.85;
}

.card{
  background:
    radial-gradient(600px 280px at 25% 10%, rgba(231,194,122,.10), transparent 55%),
    linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.18));
  border:1px solid rgba(255,230,190,.10);
  border-radius: var(--r18);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.06),
    inset 0 -20px 40px rgba(0,0,0,.34);
  padding: 12px;
}

.card + .card{ margin-top: 10px; }

.row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.badge{
  font-size:11px;
  padding: 6px 10px;
  border-radius: 999px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.20);
  color: rgba(255,255,255,.72);
  letter-spacing:.06em;
  text-transform:uppercase;
}
.badge.brass{
  border-color: rgba(231,194,122,.22);
  background: rgba(231,194,122,.10);
  color: rgba(255,255,255,.84);
}

.btn{
  width:100%;
  padding: 12px 12px;
  border-radius: 14px;
  border:1px solid rgba(255,255,255,.10);
  background:
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
  color: rgba(255,255,255,.86);
  cursor:pointer;
  font-weight:800;
  letter-spacing:.03em;
  transition: transform .14s var(--ease), border-color .14s var(--ease), background .14s var(--ease), opacity .14s var(--ease);
  user-select:none;
}
.btn:hover{ border-color: rgba(231,194,122,.18); }
.btn:active{ transform: translateY(1px) scale(.99); }

.btn.primary{
  border-color: rgba(231,194,122,.22);
  background:
    radial-gradient(380px 240px at 30% 10%, rgba(231,194,122,.18), transparent 55%),
    linear-gradient(180deg, rgba(231,194,122,.12), rgba(0,0,0,.18));
}
.btn.ghost{
  background: rgba(0,0,0,.14);
}
.btnRow{
  display:flex;
  gap:10px;
  margin-top:10px;
}
.btnRow .btn{ width:100%; }

.option{
  padding: 12px 12px;
  border-radius: 14px;
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(400px 220px at 20% 20%, rgba(231,194,122,.10), transparent 55%),
    rgba(0,0,0,.18);
  cursor:pointer;
  transition: transform .14s var(--ease), border-color .14s var(--ease), background .14s var(--ease);
  user-select:none;
}
.option:hover{ border-color: rgba(231,194,122,.18); }
.option:active{ transform: translateY(1px) scale(.99); }
.option + .option{ margin-top: 10px; }

.small{ font-size:12px; color: var(--soft); line-height:1.45; }

.fadeIn{
  animation: fadeIn .28s var(--ease) both;
}
@keyframes fadeIn{
  from{ opacity:0; transform: translateY(6px); }
  to{ opacity:1; transform: translateY(0); }
}

/* =========================
   SCREENS
   ========================= */

.screen{ display:none; }
.screen.active{ display:block; }

/* =========================
   GATE (sound gate)
   ========================= */

.gate{
  display:flex;
  align-items:center;
  justify-content:center;
  min-height: 420px;
  padding: 12px 6px 6px;
  text-align:center;
}

.seal{
  width: 96px;
  height: 96px;
  border-radius: 999px;
  display:flex;
  align-items:center;
  justify-content:center;
  margin: 6px auto 14px;
  cursor:pointer;
  user-select:none;

  background:
    radial-gradient(circle at 30% 30%, rgba(231,194,122,.95), rgba(183,122,51,.82));
  box-shadow:
    0 20px 70px rgba(183,122,51,.22),
    inset 0 1px 0 rgba(255,255,255,.14),
    inset 0 -18px 30px rgba(0,0,0,.28);
  border:1px solid rgba(255,255,255,.10);
  position:relative;
}

.seal::after{
  content:"";
  position:absolute;
  inset:-18px;
  border-radius:999px;
  background: radial-gradient(circle, rgba(231,194,122,.16), transparent 60%);
  opacity:.75;
  animation: pulse 2.8s ease-in-out infinite;
}

@keyframes pulse{
  0%,100%{ transform: scale(1); opacity:.65; }
  50%{ transform: scale(1.08); opacity:.95; }
}

.seal .note{
  font-size: 34px;
  font-weight: 900;
  transform: translateY(-1px);
  filter: drop-shadow(0 10px 22px rgba(0,0,0,.38));
  position:relative;
  z-index:1;
}

.gateOut{
  animation: gateOut .55s var(--ease) both;
}
@keyframes gateOut{
  from{ opacity:1; transform: translateY(0) scale(1); }
  to{ opacity:0; transform: translateY(10px) scale(.985); }
}

/* =========================
   CABINET (moments list)
   ========================= */
.profile{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 10px;
}
.name{
  font-size:18px;
  font-weight:900;
  letter-spacing:.02em;
}
.meta{
  font-size:12px;
  color: rgba(255,255,255,.62);
  margin-top:4px;
}

.sectionTitle{
  font-size:12px;
  letter-spacing:.18em;
  text-transform:uppercase;
  color: rgba(255,255,255,.60);
  margin: 12px 0 8px;
}

.momentTitle{
  font-weight:900;
  font-size:16px;
}
.momentDate{
  color: rgba(255,255,255,.55);
  font-size:12px;
  margin-top:4px;
}

.grid2{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}

.ach{
  border-radius: 14px;
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(280px 180px at 20% 20%, rgba(231,194,122,.10), transparent 55%),
    rgba(0,0,0,.16);
  padding: 10px;
  min-height: 70px;
}
.ach.lock{
  opacity:.40;
  filter: grayscale(.35);
}
.ach .t{ font-weight:900; font-size:13px; margin-bottom:4px; }
.ach .d{ font-size:11px; color: rgba(255,255,255,.60); line-height:1.35; }

.tabsHint{
  font-size:11px;
  color: rgba(255,255,255,.52);
  margin-top:10px;
  text-align:center;
}

/* =========================
   WAITING (hourglass symbol)
   ========================= */
.waitCenter{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding: 8px 6px 2px;
  min-height: 420px;
}

.hourIcon{
  width: 88px;
  height: 116px;
  position:relative;
  margin: 10px auto 12px;
  filter: drop-shadow(0 16px 40px rgba(0,0,0,.45));
}

.hgFrame{
  position:absolute;
  inset:0;
  border-radius: 24px;
  border: 1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(260px 200px at 30% 20%, rgba(231,194,122,.10), transparent 60%),
    rgba(0,0,0,.20);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.06),
    inset 0 -20px 40px rgba(0,0,0,.35);
}

.hgGlass{
  position:absolute;
  left:16px; right:16px;
  top:14px; bottom:14px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.08);
  overflow:hidden;
  background: rgba(0,0,0,.10);
}

.hgTop, .hgBottom{
  position:absolute;
  left:10px; right:10px;
  border-radius: 14px;
  background: linear-gradient(180deg, rgba(231,194,122,.75), rgba(183,122,51,.35));
  box-shadow: 0 10px 30px rgba(183,122,51,.12);
}
.hgTop{ top: 10px; height: 48%; }
.hgBottom{ bottom: 10px; height: 0%; }

.hgStream{
  position:absolute;
  left:50%;
  top:50%;
  width:2px;
  height:46px;
  transform: translate(-50%,-50%);
  background: rgba(231,194,122,.62);
  opacity:.75;
  animation: stream 1.2s ease-in-out infinite;
}
@keyframes stream{
  0%,100%{ opacity:.55; }
  50%{ opacity:.92; }
}

.timer{
  font-size: 32px;
  letter-spacing:.10em;
  font-weight: 900;
  margin: 8px 0 6px;
  color: rgba(255,255,255,.92);
}

.lockLine{
  font-size:12px;
  color: rgba(255,255,255,.62);
  margin-top:6px;
}

/* =========================
   MASTER (kitchen)
   ========================= */
.kitchenTitle{
  font-size:18px;
  font-weight:900;
}
.kitchenSub{ color: rgba(255,255,255,.64); font-size:12px; margin-top:4px; }

.kBtns{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  margin-top: 10px;
}
.kBtns .btn{ padding: 11px 10px; font-size:12px; letter-spacing:.06em; text-transform:uppercase; }

.miniNote{
  color: rgba(255,255,255,.55);
  font-size:11px;
  margin-top:8px;
}

/* =========================
   ACCESSIBILITY
   ========================= */
a{ color: inherit; text-decoration:none; }
</style>
</head>

<body>
<div id="app">
  <div class="frame">
    <div class="panel">

      <div class="topbar">
        <div class="brand">
          <span class="dot"></span>
          <span>THE MENU</span>
        </div>

        <button class="iconBtn" id="musicBtn" title="Музыка">♫</button>
      </div>

      <div class="content">

        <!-- ===================== GATE ===================== -->
        <div class="screen active fadeIn" id="scr_gate">
          <div class="gate">
            <div>
              <div class="seal" id="sealBtn">
                <div class="note">♫</div>
              </div>
              <div class="h1">Включите зал.</div>
              <div class="sub">Нажмите на знак.<br>Дальше — без лишних слов.</div>
              <div class="small">Громкость уже выставлена: 30%.</div>
            </div>
          </div>
        </div>

        <!-- ===================== DOOR ===================== -->
        <div class="screen fadeIn" id="scr_door">
          <div class="h1">Открыть дверь.</div>
          <div class="sub">Это вход не в заказ.<br>Это вход в процесс.</div>

          <div class="hr"></div>

          <button class="btn primary" id="btnDoor">Открыть</button>
          <button class="btn ghost" id="btnDoorHelp">Я не могу дать гео</button>

          <div class="tabsHint">Если устройство молчит — сегодня без этого.</div>
        </div>

        <div class="screen fadeIn" id="scr_outside">
          <div class="h1">Снаружи.</div>
          <div class="sub">Сейчас это место не совпадает с залом.<br>Вернитесь — и повторите.</div>
          <div class="btnRow">
            <button class="btn primary" id="btnOutsideRetry">Проверить снова</button>
            <button class="btn" id="btnOutsideBack">Назад</button>
          </div>
        </div>

        <div class="screen fadeIn" id="scr_noPerm">
          <div class="h1">Дверь закрыта.</div>
          <div class="sub">Без разрешения на геолокацию<br>зал не открывается.</div>
          <div class="btnRow">
            <button class="btn primary" id="btnNoPermRetry">Попробовать снова</button>
            <button class="btn" id="btnNoPermBack">Назад</button>
          </div>
        </div>

        <div class="screen fadeIn" id="scr_geoErr">
          <div class="h1">Тишина.</div>
          <div class="sub">Устройство молчит.<br>Сегодня — без этого.</div>
          <button class="btn primary" id="btnGeoErrRetry">Ещё раз</button>
          <button class="btn" id="btnGeoErrBack">Назад</button>
        </div>

        <!-- ===================== WELCOME ===================== -->
        <div class="screen fadeIn" id="scr_welcome">
          <div class="h1">Прежде чем мы начнём.</div>
          <div class="sub">
            Здесь не подбирают вкус.<br><br>
            Здесь фиксируют момент.<br><br>
            То, что вы получите,<br>
            не существует заранее.
          </div>

          <div class="hr"></div>

          <button class="btn primary" id="btnStartCourse">Создать момент</button>
          <button class="btn ghost" id="btnGoCabinet">В кабинет</button>
        </div>

        <!-- ===================== COURSE ===================== -->
        <div class="screen fadeIn" id="scr_course">
          <div class="h1" id="qTitle">Не думайте долго.</div>
          <div class="sub" id="qText">К какому цвету тянется рука сейчас?</div>

          <div id="qOptions"></div>

          <div class="btnRow">
            <button class="btn ghost" id="btnQBack">Назад</button>
            <button class="btn" id="btnQAbort">В кабинет</button>
          </div>
        </div>

        <!-- ===================== WAITING ===================== -->
        <div class="screen fadeIn" id="scr_wait">
          <div class="waitCenter">
            <div class="h1" id="waitTitle">Процесс идёт.</div>
            <div class="sub" id="waitSub">Не вмешивайтесь.</div>

            <div class="hourIcon" aria-hidden="true">
              <div class="hgFrame"></div>
              <div class="hgGlass">
                <div class="hgTop" id="hgTop"></div>
                <div class="hgStream"></div>
                <div class="hgBottom" id="hgBottom"></div>
              </div>
            </div>

            <div class="timer" id="waitTimer">—:—</div>
            <div class="lockLine" id="waitHint">Время начнётся, когда кухня подтвердит.</div>

            <button class="btn primary" id="btnWaitCab">В кабинет</button>
          </div>
        </div>

        <!-- ===================== CABINET (Moments) ===================== -->
        <div class="screen fadeIn" id="scr_cabinet">
          <div class="profile">
            <div>
              <div class="name" id="cabName">Гость</div>
              <div class="meta" id="cabMeta">Моментов: 0 · Оценок: 0</div>
            </div>
            <span class="badge brass" id="cabNowBadge" style="display:none;">В процессе</span>
          </div>

          <div class="card" id="cabNowCard" style="display:none;">
            <div class="row">
              <div>
                <div style="font-weight:900;">Сейчас</div>
                <div class="small" id="cabNowText">Процесс уже начался. Не вмешивайтесь.</div>
              </div>
              <span class="badge brass" id="cabNowState">…</span>
            </div>
            <div class="btnRow">
              <button class="btn primary" id="btnCabToWait">Вернуться к процессу</button>
              <button class="btn" id="btnCabOpenNow">Открыть</button>
            </div>
          </div>

          <div class="sectionTitle">Последние моменты</div>
          <div id="cabLast"></div>

          <div class="btnRow">
            <button class="btn" id="btnOpenArchive">Архив</button>
            <button class="btn primary" id="btnNewMoment">Создать новый момент</button>
          </div>

          <div class="sectionTitle">Знаки</div>
          <div class="grid2" id="cabAch"></div>

          <div class="tabsHint">Оценка — это не вкус. Это след.</div>
        </div>

        <!-- ===================== ARCHIVE ===================== -->
        <div class="screen fadeIn" id="scr_archive">
          <div class="row">
            <div class="h1" style="margin:0;">Архив</div>
            <span class="badge" id="archCount">0</span>
          </div>
          <div class="sub">Здесь лежат моменты, которые уже случились.</div>

          <div id="archList"></div>

          <button class="btn" id="btnArchBack">Назад</button>
        </div>

        <!-- ===================== MOMENT DETAIL ===================== -->
        <div class="screen fadeIn" id="scr_moment">
          <div class="row">
            <div>
              <div class="h1" id="mTitle" style="margin:0;">Момент</div>
              <div class="small" id="mDate">—</div>
            </div>
            <span class="badge brass" id="mStatus">…</span>
          </div>

          <div class="hr"></div>

          <div class="card" id="mBody"></div>

          <div class="card" style="margin-top:10px;">
            <div style="font-weight:900;margin-bottom:6px;">Жест</div>
            <div class="small" style="margin-bottom:10px;">Не вкус. Не табак. Результат момента.</div>

            <div class="btnRow">
              <button class="btn" id="rateBad">Слабо</button>
              <button class="btn" id="rateOk">Честно</button>
              <button class="btn primary" id="ratePerfect">Идеально</button>
            </div>

            <button class="btn ghost" id="btnTip" style="margin-top:10px;">Оставить жест</button>
          </div>

          <button class="btn" id="btnMomentBack">Назад</button>
        </div>

        <!-- ===================== MASTER (Kitchen) ===================== -->
        <div class="screen fadeIn" id="scr_master">
          <div class="row">
            <div>
              <div class="kitchenTitle">Кухня</div>
              <div class="kitchenSub">Здесь не “заказы”. Здесь — моменты.</div>
            </div>
            <span class="badge" id="kCount">…</span>
          </div>

          <div id="kList" style="margin-top:10px;"></div>

          <button class="btn" id="btnKRefresh">Обновить</button>
          <div class="miniNote">Песок у гостя начнётся, когда вы нажмёте “Кухня услышала”.</div>
        </div>

      </div>

      <div class="bottombar" id="bottomTabs" style="display:none;">
        <button class="tab" id="tabArchive">Архив</button>
        <button class="tab active" id="tabMoments">Моменты</button>
      </div>

    </div>
  </div>
</div>

<audio id="bgMusic" src="./7441574b62bac5e.mp3" loop preload="auto"></audio>

<script>
/* =========================
   CONFIG
   ========================= */
const BACKEND_BASE = "https://hookah-mix-bot-56x5.onrender.com";
const MASTER_ID = 1292778768;

const TIP_URL = "https://netmonet.co/qr/192937/tip?o=6";

const DURATION_MS = 25 * 60 * 1000; // 25 минут
const MUSIC_VOLUME = 0.30;

const GEOFENCE = { lat: 56.519963, lon: 84.933527, radiusM: 40 };
const GEO_TTL_MS = 2 * 60 * 60 * 1000; // 2 часа

/* =========================
   TELEGRAM
   ========================= */
const tg = window.Telegram?.WebApp;
const tgUser = tg?.initDataUnsafe?.user || null;
const isMaster = !!(tgUser && tgUser.id === MASTER_ID);

const guest = {
  id: tgUser?.id,
  name: tgUser?.first_name || "Гость",
  username: tgUser?.username || ""
};

/* =========================
   STORAGE KEYS
   ========================= */
const LS_MOMENT_IDS = "hm_moment_ids";
const LS_GEO_UNTIL = "hm_geo_until";
const LS_MUSIC_ON = "hm_music_on";

/* =========================
   DOM HELPERS
   ========================= */
const $ = (id)=>document.getElementById(id);
function escapeHtml(str=""){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function showBottomTabs(on){
  $("bottomTabs").style.display = on ? "flex" : "none";
}
function setActiveTab(tab){
  $("tabArchive").classList.toggle("active", tab==="archive");
  $("tabMoments").classList.toggle("active", tab==="moments");
}

/* =========================
   SCREEN ROUTER
   ========================= */
const screens = [
  "scr_gate","scr_door","scr_outside","scr_noPerm","scr_geoErr",
  "scr_welcome","scr_course","scr_wait",
  "scr_cabinet","scr_archive","scr_moment",
  "scr_master"
];
function go(id){
  screens.forEach(s=>$(s).classList.remove("active"));
  $(id).classList.add("active");
}

/* =========================
   MUSIC
   ========================= */
const audioEl = $("bgMusic");
const musicBtn = $("musicBtn");

function setMusicBtn(on){
  musicBtn.classList.toggle("on", !!on);
}
async function playMusic(){
  try{
    audioEl.volume = MUSIC_VOLUME;
    await audioEl.play();
    localStorage.setItem(LS_MUSIC_ON,"1");
    setMusicBtn(true);
  }catch(e){
    localStorage.setItem(LS_MUSIC_ON,"0");
    setMusicBtn(false);
  }
}
function pauseMusic(){
  audioEl.pause();
  localStorage.setItem(LS_MUSIC_ON,"0");
  setMusicBtn(false);
}
musicBtn.addEventListener("click",()=>{
  if(audioEl.paused) playMusic();
  else pauseMusic();
});

/* =========================
   GEO
   ========================= */
function distanceMeters(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const toRad = v => v * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function isInsideFence(lat, lon){
  return distanceMeters(lat, lon, GEOFENCE.lat, GEOFENCE.lon) <= GEOFENCE.radiusM;
}
function requestLocation(){
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation) return reject(new Error("no_geolocation"));
    navigator.geolocation.getCurrentPosition(
      (pos)=>resolve({lat:pos.coords.latitude, lon:pos.coords.longitude, accuracy:pos.coords.accuracy}),
      (err)=>reject(err),
      { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
    );
  });
}
function setGeoAccessUntil(ts){ localStorage.setItem(LS_GEO_UNTIL, String(ts)); }
function hasGeoAccessNow(){ return Date.now() < Number(localStorage.getItem(LS_GEO_UNTIL)||0); }

/* =========================
   MOMENTS STORAGE
   ========================= */
function getMomentIds(){
  try{ return JSON.parse(localStorage.getItem(LS_MOMENT_IDS)||"[]"); }catch{ return []; }
}
function addMomentId(id){
  const ids = getMomentIds();
  if(!ids.includes(id)) ids.push(id);
  localStorage.setItem(LS_MOMENT_IDS, JSON.stringify(ids));
  return ids;
}

/* =========================
   API
   ========================= */
async function safeJson(r){
  const t = await r.text();
  try{ return JSON.parse(t); }catch{ return { ok:false, raw:t }; }
}
async function apiGetMoments(limit=200){
  const r = await fetch(`${BACKEND_BASE}/moments?limit=${limit}`);
  const data = await safeJson(r);
  if(!r.ok) throw new Error("getMoments failed");
  return data;
}
async function apiCreateMoment(m){
  const r = await fetch(`${BACKEND_BASE}/moment`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(m)
  });
  const data = await safeJson(r);
  if(!r.ok) throw new Error("createMoment failed");
  return data;
}
async function apiSetStatus(id,status){
  const r = await fetch(`${BACKEND_BASE}/moment/${id}/status`,{
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({status})
  });
  const data = await safeJson(r);
  if(!r.ok) throw new Error("setStatus failed");
  return data;
}
async function apiSetRating(id,rating){
  const r = await fetch(`${BACKEND_BASE}/moment/${id}/rating`,{
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({rating})
  });
  const data = await safeJson(r);
  if(!r.ok) throw new Error("setRating failed");
  return data;
}

/* =========================
   QUESTIONS (в стиле “не про кальян”)
   ========================= */
const QUESTIONS = [
  { title:"THE MENU", text:"К какому цвету тянется рука сейчас?", options:["Тень","Свет","Пепел","Медь","Холод"] },
  { title:"Касание.", text:"Ощущение в пространстве —", options:["Почти вплотную","На расстоянии","Воздушно","Тяжело"] },
  { title:"Пауза.", text:"Если сделать паузу —", options:["Орех","Фрукт","Хлеб","Ничего"] },
  { title:"Скорость.", text:"Это время хочется прожить —", options:["Медленно","Рывками","Ровно","Не чувствуя времени"] },
  { title:"Материал.", text:"Ближе к чему?", options:["Бархат","Металл","Дерево","Стекло"] },
  { title:"Температура.", text:"Это должно быть —", options:["Холод","Тепло","Контраст","Без температуры"] },
  { title:"Запрет.", text:"Что сегодня нельзя впускать?", options:["Цитрус","Ягоды","Десерт","Тяжёлые специи","Мята"] },
  { title:"Вес.", text:"Финальное ощущение —", options:["Легко","Ровно","Плотно","Тяжело"] },
];

const EPITHETS = ["Холод Тень","Строгая Сцена","Тёмная Линия","Тяжёлая Привычка","Сухая Тишина","Нервная Комната","Белый Шум","Медный Пепел"];
function randomEpithet(){ return EPITHETS[Math.floor(Math.random()*EPITHETS.length)]; }

/* =========================
   COURSE STATE
   ========================= */
let qIndex = 0;
let answers = {};
let openMomentId = null;
let waitPoll = null;

function renderQuestion(){
  const q = QUESTIONS[qIndex];
  $("qTitle").textContent = q.title;
  $("qText").textContent = q.text;

  const box = $("qOptions");
  box.innerHTML = "";
  q.options.forEach(opt=>{
    const div = document.createElement("div");
    div.className = "option";
    div.textContent = opt;
    div.onclick = ()=>pickAnswer(opt);
    box.appendChild(div);
  });
}

async function pickAnswer(v){
  answers[String(qIndex+1)] = v;
  qIndex++;

  if(qIndex < QUESTIONS.length){
    renderQuestion();
    return;
  }

  await createMoment();
}

async function createMoment(){
  const id = Date.now()+"_"+Math.random().toString(36).slice(2,6);
  const m = {
    id,
    createdAt: Date.now(),
    status: "new",
    acceptedAt: null,
    rating: null,
    epithet: randomEpithet(),
    guest,
    answers
  };

  addMomentId(id);
  go("scr_wait");
  startWaitingLoop(); // сразу показываем ожидание (пока кухня не подтвердила)

  try{ await apiCreateMoment(m); }catch(e){ /* offline — но UI пусть живёт */ }
}

/* =========================
   WAITING: hourglass progress
   ========================= */
function fmt(ms){
  if(ms == null) return "—:—";
  const t = Math.max(0, Math.floor(ms/1000));
  const m = Math.floor(t/60);
  const s = t%60;
  return `${m}:${String(s).padStart(2,"0")}`;
}
function setHourglassProgress(p01){
  const p = Math.max(0, Math.min(1, p01));
  const top = $("hgTop");
  const bot = $("hgBottom");

  // top starts at 48%, goes down to ~4%
  const topH = 48 - (44*p);
  // bottom grows to 48%
  const botH = 48 * p;

  top.style.height = `${topH}%`;
  bot.style.height = `${botH}%`;
}

async function startWaitingLoop(){
  if(waitPoll) clearInterval(waitPoll);

  async function tick(){
    try{
      const ids = getMomentIds();
      const data = await apiGetMoments(250);
      const mine = (data.moments||[]).filter(m=>ids.includes(m.id)).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      const active = mine.find(m=>m.status !== "finished") || null;

      if(!active){
        await renderCabinet();
        go("scr_cabinet");
        showBottomTabs(true);
        setActiveTab("moments");
        return;
      }

      // if not accepted => locked
      if(!active.acceptedAt){
        $("waitTitle").textContent = "Процесс идёт.";
        $("waitSub").textContent = "Не вмешивайтесь.";
        $("waitTimer").textContent = "—:—";
        $("waitHint").textContent = "Время начнётся, когда кухня подтвердит.";
        setHourglassProgress(0);
        openMomentId = active.id;
        return;
      }

      const left = (active.acceptedAt + DURATION_MS) - Date.now();
      const progress = 1 - (left / DURATION_MS);

      if(left <= 0 || active.status === "finished"){
        $("waitTitle").textContent = "Момент случился.";
        $("waitSub").textContent = "Дальше — без интерфейса.";
        $("waitTimer").textContent = "Готово";
        $("waitHint").textContent = "Откройте момент в кабинете.";
        setHourglassProgress(1);
        openMomentId = active.id;
        return;
      }

      $("waitTitle").textContent = "Процесс идёт.";
      $("waitSub").textContent = "Не вмешивайтесь.";
      $("waitTimer").textContent = fmt(left);
      $("waitHint").textContent = "Песок идёт.";
      setHourglassProgress(progress);
      openMomentId = active.id;

    }catch(e){
      $("waitHint").textContent = "Нет связи.";
    }
  }

  await tick();
  waitPoll = setInterval(tick, 2000);
}

/* =========================
   CABINET / ARCHIVE / MOMENT
   ========================= */
function calcAchievements(moments){
  const sessions = moments.length;
  const rated = moments.filter(m=>!!m.rating).length;
  return [
    { t:"Первый момент", d:"Вы вошли.", ok: sessions>=1 },
    { t:"Возвращение", d:"Вы вернулись.", ok: sessions>=2 },
    { t:"Честность", d:"Вы оценили три.", ok: rated>=3 }
  ];
}

async function renderCabinet(){
  $("cabName").textContent = guest.name;

  const ids = getMomentIds();
  const lastBox = $("cabLast");
  const achBox = $("cabAch");

  lastBox.innerHTML = "";
  achBox.innerHTML = "";

  try{
    const data = await apiGetMoments(250);
    const mine = (data.moments||[]).filter(m=>ids.includes(m.id)).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

    const rated = mine.filter(m=>!!m.rating).length;
    $("cabMeta").textContent = `Моментов: ${mine.length} · Оценок: ${rated}`;

    const active = mine.find(m=>m.status !== "finished") || null;

    if(active){
      $("cabNowBadge").style.display = "inline-flex";
      $("cabNowCard").style.display = "block";
      $("cabNowState").textContent = active.acceptedAt ? "в процессе" : "новый";
      $("cabNowText").textContent = active.acceptedAt
        ? "Процесс уже начался. Не вмешивайтесь."
        : "Песок ещё не запущен.";
      openMomentId = active.id;
    }else{
      $("cabNowBadge").style.display = "none";
      $("cabNowCard").style.display = "none";
    }

    const last = mine.slice(0,3);
    if(!last.length){
      lastBox.innerHTML = `<div class="small">Пока пусто. Но зал уже здесь.</div>`;
    }else{
      last.forEach(m=>{
        const st = m.status || "…";
        const badge = (st==="finished") ? "случился" : (m.acceptedAt ? "в процессе" : "новый");
        lastBox.innerHTML += `
          <div class="card">
            <div class="row">
              <div>
                <div class="momentTitle">${escapeHtml(m.epithet||"Момент")}</div>
                <div class="momentDate">${new Date(m.createdAt||Date.now()).toLocaleString("ru-RU")}</div>
              </div>
              <span class="badge brass">${escapeHtml(badge)}</span>
            </div>
            <div class="btnRow">
              <button class="btn" onclick="openMoment('${escapeHtml(m.id)}')">Открыть</button>
            </div>
          </div>
        `;
      });
    }

    const ach = calcAchievements(mine);
    ach.forEach(a=>{
      achBox.innerHTML += `
        <div class="ach ${a.ok ? "" : "lock"}">
          <div class="t">${escapeHtml(a.t)}</div>
          <div class="d">${escapeHtml(a.d)}</div>
        </div>
      `;
    });

  }catch(e){
    $("cabMeta").textContent = "Нет связи.";
    lastBox.innerHTML = `<div class="small">Нет связи.</div>`;
  }
}

async function renderArchive(){
  const ids = getMomentIds();
  const box = $("archList");
  box.innerHTML = "";

  try{
    const data = await apiGetMoments(250);
    const mine = (data.moments||[]).filter(m=>ids.includes(m.id)).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

    $("archCount").textContent = String(mine.length);

    if(!mine.length){
      box.innerHTML = `<div class="small">Архив пуст.</div>`;
      return;
    }

    mine.forEach(m=>{
      const mark = m.rating ? "оценено" : "без оценки";
      box.innerHTML += `
        <div class="card">
          <div class="row">
            <div>
              <div class="momentTitle">${escapeHtml(m.epithet||"Момент")}</div>
              <div class="momentDate">${new Date(m.createdAt||Date.now()).toLocaleString("ru-RU")}</div>
            </div>
            <span class="badge">${escapeHtml(mark)}</span>
          </div>
          <div class="btnRow">
            <button class="btn" onclick="openMoment('${escapeHtml(m.id)}')">Открыть</button>
          </div>
        </div>
      `;
    });

  }catch(e){
    box.innerHTML = `<div class="small">Нет связи.</div>`;
  }
}

window.openMoment = async function(id){
  openMomentId = id;
  go("scr_moment");
  showBottomTabs(false);
  await renderMoment();
};

async function renderMoment(){
  const id = openMomentId;
  if(!id){
    $("mTitle").textContent = "Недоступно";
    $("mBody").innerHTML = "";
    return;
  }

  try{
    const data = await apiGetMoments(250);
    const m = (data.moments||[]).find(x=>String(x.id)===String(id));
    if(!m) return;

    $("mTitle").textContent = m.epithet || "Момент";
    $("mDate").textContent = new Date(m.createdAt||Date.now()).toLocaleString("ru-RU");
    $("mStatus").textContent = (m.status==="finished") ? "случился" : (m.acceptedAt ? "в процессе" : "новый");

    const ans = m.answers || {};
    const lines = Object.keys(ans)
      .sort((a,b)=>Number(a)-Number(b))
      .map(k=>`<div class="small"><b>q${escapeHtml(k)}:</b> ${escapeHtml(ans[k])}</div>`)
      .join("");

    $("mBody").innerHTML = `
      <div style="font-weight:900;margin-bottom:6px;">Условия</div>
      ${lines || `<div class="small">—</div>`}
    `;

  }catch(e){
    $("mBody").innerHTML = `<div class="small">Нет связи.</div>`;
  }
}

/* =========================
   MASTER
   ========================= */
async function renderKitchen(){
  const list = $("kList");
  list.innerHTML = "";

  try{
    const data = await apiGetMoments(250);
    const arr = (data.moments||[]).slice().sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    $("kCount").textContent = String(arr.length);

    if(!arr.length){
      list.innerHTML = `<div class="small">Нет активных моментов.</div>`;
      return;
    }

    arr.forEach(m=>{
      const isNew = (m.status==="new");
      const badge = (m.status==="finished") ? "случился" : (m.acceptedAt ? "в процессе" : "новый");
      list.innerHTML += `
        <div class="card" style="${isNew ? "border-color: rgba(231,194,122,.22);" : ""}">
          <div class="row">
            <div>
              <div class="momentTitle">${escapeHtml(m.guest?.name || "Гость")}</div>
              <div class="momentDate">${new Date(m.createdAt||Date.now()).toLocaleString("ru-RU")}</div>
              <div class="small">Песок: ${m.acceptedAt ? "идёт" : "ещё не запущен"}</div>
            </div>
            <span class="badge brass">${escapeHtml(badge)}</span>
          </div>

          <div class="kBtns">
            <button class="btn primary" onclick="kSet('${escapeHtml(m.id)}','accepted')">Кухня услышала</button>
            <button class="btn" onclick="kSet('${escapeHtml(m.id)}','in_progress')">Печь работает</button>
            <button class="btn" onclick="kSet('${escapeHtml(m.id)}','serving')">Подача</button>
            <button class="btn" onclick="kSet('${escapeHtml(m.id)}','finished')">Момент случился</button>
          </div>
        </div>
      `;
    });

  }catch(e){
    $("kCount").textContent = "нет связи";
    list.innerHTML = `<div class="small">Нет связи.</div>`;
  }
}
window.kSet = async function(id,status){
  try{
    await apiSetStatus(id,status);
    await renderKitchen();
  }catch(e){}
};

/* =========================
   DOOR FLOW
   ========================= */
async function openDoor(){
  try{
    const pos = await requestLocation();
    const ok = isInsideFence(pos.lat, pos.lon);

    if(!ok){
      go("scr_outside");
      showBottomTabs(false);
      return;
    }

    setGeoAccessUntil(Date.now()+GEO_TTL_MS);
    go("scr_gate");
    showBottomTabs(false);
  }catch(e){
    if(e && e.code === 1){
      go("scr_noPerm");
    }else{
      go("scr_geoErr");
    }
    showBottomTabs(false);
  }
}

/* =========================
   BUTTONS
   ========================= */
$("sealBtn").addEventListener("click", async ()=>{
  // start music + cinematic gate out
  await playMusic();
  $("scr_gate").classList.add("gateOut");
  setTimeout(()=>{
    $("scr_gate").classList.remove("gateOut");

    // if user has geo access => welcome
    go("scr_welcome");
    showBottomTabs(false);
  }, 520);
});

$("btnDoor").addEventListener("click", openDoor);
$("btnDoorHelp").addEventListener("click", ()=>{
  alert("Если гео не отдаётся: попробуйте открыть мини-апп в Telegram, и дать доступ к геолокации в настройках iOS. Если устройство молчит — сегодня без этого.");
});
$("btnOutsideRetry").addEventListener("click", openDoor);
$("btnOutsideBack").addEventListener("click", ()=>go("scr_door"));
$("btnNoPermRetry").addEventListener("click", openDoor);
$("btnNoPermBack").addEventListener("click", ()=>go("scr_door"));
$("btnGeoErrRetry").addEventListener("click", openDoor);
$("btnGeoErrBack").addEventListener("click", ()=>go("scr_door"));

$("btnStartCourse").addEventListener("click", ()=>{
  qIndex = 0;
  answers = {};
  go("scr_course");
  showBottomTabs(false);
  renderQuestion();
});

$("btnGoCabinet").addEventListener("click", async ()=>{
  await renderCabinet();
  go("scr_cabinet");
  showBottomTabs(true);
  setActiveTab("moments");
});

$("btnQBack").addEventListener("click", ()=>{
  if(qIndex<=0){ go("scr_welcome"); return; }
  qIndex = Math.max(0, qIndex-1);
  // remove last answer
  delete answers[String(qIndex+1)];
  renderQuestion();
});
$("btnQAbort").addEventListener("click", async ()=>{
  await renderCabinet();
  go("scr_cabinet");
  showBottomTabs(true);
  setActiveTab("moments");
});

$("btnWaitCab").addEventListener("click", async ()=>{
  await renderCabinet();
  go("scr_cabinet");
  showBottomTabs(true);
  setActiveTab("moments");
});

$("btnCabToWait").addEventListener("click", ()=>{
  go("scr_wait");
  showBottomTabs(false);
  startWaitingLoop();
});
$("btnCabOpenNow").addEventListener("click", async ()=>{
  if(!openMomentId){ return; }
  await window.openMoment(openMomentId);
});

$("btnOpenArchive").addEventListener("click", async ()=>{
  await renderArchive();
  go("scr_archive");
  showBottomTabs(true);
  setActiveTab("archive");
});

$("btnNewMoment").addEventListener("click", ()=>{
  // IMPORTANT: новый момент НЕ должен возвращать в дверь/гео
  qIndex = 0;
  answers = {};
  go("scr_course");
  showBottomTabs(false);
  renderQuestion();
});

$("btnArchBack").addEventListener("click", async ()=>{
  await renderCabinet();
  go("scr_cabinet");
  showBottomTabs(true);
  setActiveTab("moments");
});

$("btnMomentBack").addEventListener("click", async ()=>{
  // back to archive (if it was opened from archive) — проще: назад в кабинет
  await renderCabinet();
  go("scr_cabinet");
  showBottomTabs(true);
  setActiveTab("moments");
});

$("btnTip").addEventListener("click", ()=>window.open(TIP_URL, "_blank"));

$("rateBad").addEventListener("click", async ()=>{
  if(!openMomentId) return;
  try{ await apiSetRating(openMomentId,"bad"); }catch{}
  alert("Запомнил.");
});
$("rateOk").addEventListener("click", async ()=>{
  if(!openMomentId) return;
  try{ await apiSetRating(openMomentId,"ok"); }catch{}
  alert("Запомнил.");
});
$("ratePerfect").addEventListener("click", async ()=>{
  if(!openMomentId) return;
  try{ await apiSetRating(openMomentId,"perfect"); }catch{}
  alert("Запомнил.");
});

/* Tabs (нижняя панель) */
$("tabArchive").addEventListener("click", async ()=>{
  await renderArchive();
  go("scr_archive");
  showBottomTabs(true);
  setActiveTab("archive");
});
$("tabMoments").addEventListener("click", async ()=>{
  await renderCabinet();
  go("scr_cabinet");
  showBottomTabs(true);
  setActiveTab("moments");
});

/* Master refresh */
$("btnKRefresh").addEventListener("click", renderKitchen);

/* =========================
   START LOGIC
   ========================= */
document.addEventListener("DOMContentLoaded", async ()=>{
  try{ tg?.ready(); tg?.expand(); }catch{}

  // restore music btn state
  const on = localStorage.getItem(LS_MUSIC_ON)==="1";
  setMusicBtn(on);

  // MASTER
  if(isMaster){
    go("scr_master");
    showBottomTabs(false);
    await renderKitchen();
    setInterval(renderKitchen, 3000);
    return;
  }

  const ids = getMomentIds();
  const geoOk = hasGeoAccessNow();

  // If user already has moments: go cabinet immediately
  if(ids.length){
    await renderCabinet();
    go("scr_cabinet");
    showBottomTabs(true);
    setActiveTab("moments");
    return;
  }

  // New user: must open door first (concept)
  // After door verified, we show gate => music => welcome
  if(!geoOk){
    go("scr_door");
    showBottomTabs(false);
    return;
  }

  // geo ok (within TTL): show gate
  go("scr_gate");
  showBottomTabs(false);
});
</script>
</body>
</html>
