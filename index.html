<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>THE MENU</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root { color-scheme: dark; }

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  background: radial-gradient(1200px 800px at 30% 20%, #2b2b38 0%, #0b0b12 55%, #05050a 100%);
  color:#fff;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:24px;
}

.card{
  width:min(600px,100%);
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  padding:22px;
  backdrop-filter: blur(10px);
  box-shadow:0 20px 60px rgba(0,0,0,.45);
}

.screen{display:none}
.screen.active{display:block}

h1{margin:0 0 12px;font-size:24px}
p{opacity:.85;line-height:1.5;margin:0 0 10px}

.btn{
  width:100%;
  margin-top:16px;
  padding:14px;
  border-radius:14px;
  border:0;
  font-size:16px;
  font-weight:700;
  cursor:pointer;
  background:linear-gradient(90deg,#ff7a18,#ff3d77);
  color:#fff;
}

.btn.secondary{
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.14);
}

.btnRow{
  display:flex;
  gap:10px;
  margin-top:12px;
}
.btnRow .btn{margin-top:0;width:100%}

.option{
  padding:14px;
  border-radius:14px;
  background:rgba(255,255,255,.08);
  margin-top:10px;
  cursor:pointer;
}
.option:hover{background:rgba(255,255,255,.14)}

.small{font-size:13px;opacity:.7}

.timer{
  font-size:30px;
  text-align:center;
  letter-spacing:2px;
  margin:14px 0
}

.order{
  background:rgba(255,255,255,.08);
  border-radius:14px;
  padding:14px;
  margin-top:12px;
}

.row{
  display:flex;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
  align-items:center
}

.badge{
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.12);
}
.badge.warn{background:rgba(255,140,0,.15)}
.badge.good{background:rgba(0,255,140,.15)}
.badge.done{background:rgba(255,255,255,.15)}

hr{
  border:0;
  border-top:1px solid rgba(255,255,255,.12);
  margin:12px 0
}
</style>
</head>

<body>
<div class="card">

<!-- ===== –ì–û–°–¢: –°–¢–ê–†–¢ ===== -->

<div class="screen" id="s0">
  <h1>–ü—Ä–µ–∂–¥–µ —á–µ–º –º—ã –Ω–∞—á–Ω—ë–º.</h1>
  <p>
    –ó–¥–µ—Å—å –Ω–µ –ø–æ–¥–±–∏—Ä–∞—é—Ç –≤–∫—É—Å.<br><br>
    –ó–¥–µ—Å—å —Ñ–∏–∫—Å–∏—Ä—É—é—Ç –º–æ–º–µ–Ω—Ç.<br><br>
    –¢–æ, —á—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ,<br>
    –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∑–∞—Ä–∞–Ω–µ–µ.
  </p>
  <button class="btn" onclick="go('q1')">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
</div>

<!-- ===== –ì–û–°–¢: –í–û–ü–†–û–°–´ ===== -->

<div class="screen" id="q1">
  <h1>–ù–µ –¥—É–º–∞–π—Ç–µ –¥–æ–ª–≥–æ.</h1>
  <p>–ö –∫–∞–∫–æ–º—É —Ü–≤–µ—Ç—É —Ç—è–Ω–µ—Ç—Å—è —Ä—É–∫–∞ —Å–µ–π—á–∞—Å?</p>
  <div class="option" onclick="pick(1,'–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π')">üü§ –ö–æ—Ä–∏—á–Ω–µ–≤—ã–π</div>
  <div class="option" onclick="pick(1,'–ó–µ–ª—ë–Ω—ã–π')">üü¢ –ó–µ–ª—ë–Ω—ã–π</div>
  <div class="option" onclick="pick(1,'–°–∏–Ω–∏–π')">üîµ –°–∏–Ω–∏–π</div>
  <div class="option" onclick="pick(1,'–§–∏–æ–ª–µ—Ç–æ–≤—ã–π')">üü£ –§–∏–æ–ª–µ—Ç–æ–≤—ã–π</div>
  <div class="option" onclick="pick(1,'–ë–µ–ª—ã–π')">‚ö™ –ë–µ–ª—ã–π</div>
</div>

<div class="screen" id="q2">
  <h1>–û—â—É—â–µ–Ω–∏–µ.</h1>
  <p>–ù–µ –≤–∫—É—Å. –ù–µ –∑–∞–ø–∞—Ö. –û—â—É—â–µ–Ω–∏–µ –≤–æ —Ä—Ç—É ‚Äî</p>
  <div class="option" onclick="pick(2,'–°—É—Ö–æ')">–°—É—Ö–æ</div>
  <div class="option" onclick="pick(2,'–ú—è–≥–∫–æ')">–ú—è–≥–∫–æ</div>
  <div class="option" onclick="pick(2,'–ü–ª–æ—Ç–Ω–æ')">–ü–ª–æ—Ç–Ω–æ</div>
  <div class="option" onclick="pick(2,'–ü—É—Å—Ç–æ')">–ü—É—Å—Ç–æ</div>
</div>

<div class="screen" id="q3">
  <h1>–ï—Å–ª–∏ —Å–¥–µ–ª–∞—Ç—å –ø–∞—É–∑—É.</h1>
  <p>–ù–µ –ø–µ—Ä–µ–∫—É—Å–∏—Ç—å. –ü—Ä–æ—Å—Ç–æ –ø–∞—É–∑—É.</p>
  <div class="option" onclick="pick(3,'–û—Ä–µ—Ö')">–û—Ä–µ—Ö</div>
  <div class="option" onclick="pick(3,'–§—Ä—É–∫—Ç')">–§—Ä—É–∫—Ç</div>
  <div class="option" onclick="pick(3,'–•–ª–µ–±')">–•–ª–µ–±</div>
  <div class="option" onclick="pick(3,'–ù–∏—á–µ–≥–æ')">–ù–∏—á–µ–≥–æ</div>
</div>

<div class="screen" id="q4">
  <h1>–°–∫–æ—Ä–æ—Å—Ç—å.</h1>
  <p>–≠—Ç–æ –≤—Ä–µ–º—è —Ö–æ—á–µ—Ç—Å—è –ø—Ä–æ–∂–∏—Ç—å ‚Äî</p>
  <div class="option" onclick="pick(4,'–ú–µ–¥–ª–µ–Ω–Ω–æ')">–ú–µ–¥–ª–µ–Ω–Ω–æ</div>
  <div class="option" onclick="pick(4,'–†—ã–≤–∫–∞–º–∏')">–†—ã–≤–∫–∞–º–∏</div>
  <div class="option" onclick="pick(4,'–†–æ–≤–Ω–æ')">–†–æ–≤–Ω–æ</div>
  <div class="option" onclick="pick(4,'–ù–µ —á—É–≤—Å—Ç–≤—É—è –≤—Ä–µ–º–µ–Ω–∏')">–ù–µ —á—É–≤—Å—Ç–≤—É—è –≤—Ä–µ–º–µ–Ω–∏</div>
</div>

<div class="screen" id="q5">
  <h1>–ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ.</h1>
  <p>–ï—Å–ª–∏ –∑–∞–∫—Ä—ã—Ç—å –≥–ª–∞–∑–∞, –≤–æ–∫—Ä—É–≥ —Å–µ–π—á–∞—Å ‚Äî</p>
  <div class="option" onclick="pick(5,'–ü–æ–ª—É–º—Ä–∞–∫')">–ü–æ–ª—É–º—Ä–∞–∫</div>
  <div class="option" onclick="pick(5,'–Ø—Ä–∫–∏–π —Å–≤–µ—Ç')">–Ø—Ä–∫–∏–π —Å–≤–µ—Ç</div>
  <div class="option" onclick="pick(5,'–¢–µ–Ω—å')">–¢–µ–Ω—å</div>
  <div class="option" onclick="pick(5,'–ù–∏—á–µ–≥–æ')">–ù–∏—á–µ–≥–æ</div>
</div>

<div class="screen" id="q6">
  <h1>–≠—Ç–æ—Ç –º–æ–º–µ–Ω—Ç ‚Äî</h1>
  <p>–Ω–µ –ø—Ä–æ –ø–ª–∞–Ω—ã –∏ –Ω–µ –ø—Ä–æ —Ü–µ–ª–∏.</p>
  <div class="option" onclick="pick(6,'–ù–∞—á–∞–ª–æ')">–ù–∞—á–∞–ª–æ</div>
  <div class="option" onclick="pick(6,'–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ')">–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ</div>
  <div class="option" onclick="pick(6,'–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ')">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</div>
</div>

<!-- ===== –ì–û–°–¢: –û–ñ–ò–î–ê–ù–ò–ï ===== -->

<div class="screen" id="waiting">
  <h1 id="waitTitle">–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç.</h1>
  <p id="waitText">–ö–∞–ª—å—è–Ω —É–∂–µ –≥–æ—Ç–æ–≤–∏—Ç—Å—è.</p>
  <div class="timer" id="guestTimer">25:00</div>
  <p class="small" id="guestHint"></p>
</div>

<!-- ===== –ì–û–°–¢: –≠–ü–ò–õ–û–ì ===== -->

<div class="screen" id="epilogue">
  <h1>–≠—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ</h1>
  <p>
    –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞.<br><br>
    –î–∞–ª—å—à–µ ‚Äî –±–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.
  </p>
</div>

<!-- ===== –ì–û–°–¢: –õ–ò–ß–ù–´–ô –ö–ê–ë–ò–ù–ï–¢ ===== -->

<div class="screen" id="guest-dashboard">
  <h1>–í–∞—à–∏ –∫–∞–ª—å—è–Ω—ã</h1>
  <div id="guestOrders"></div>
  <button class="btn" onclick="resetGuestState(); go('q1')">–ó–∞–∫–∞–∑–∞—Ç—å –µ—â—ë –æ–¥–∏–Ω</button>
</div>

<!-- ===== –ú–ê–°–¢–ï–† ===== -->

<div class="screen" id="master">
  <div class="row">
    <h1 style="margin:0">–ó–∞–∫–∞–∑—ã</h1>
    <span class="badge" id="masterStatus">‚Ä¶</span>
  </div>
  <div id="orders"></div>
</div>

</div>

<script>
/* ===== –ù–ê–°–¢–†–û–ô–ö–ò ===== */
const MASTER_ID = 1292778768;
const DURATION_MS = 25 * 60 * 1000;
const BACKEND_BASE = "https://hookah-mix-bot-56x5.onrender.com";

const tg = window.Telegram?.WebApp;
const tgUser = tg?.initDataUnsafe?.user;
const isMaster = tgUser && tgUser.id === MASTER_ID;

const guest = {
  id: tgUser?.id,
  name: tgUser?.first_name || "–ì–æ—Å—Ç—å"
};

const LS_ORDER_IDS = "hm_orders_ids";

let answers = {};
let guestTimerInt = null;

/* ===== UI ===== */
function go(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id)?.classList.add("active");
}

/* ===== –ì–û–°–¢ ===== */
function pick(step,val){
  answers[step]=val;
  if(step<6) go("q"+(step+1));
  else placeOrder();
}

async function placeOrder(){
  const id = Date.now()+"_"+Math.random().toString(36).slice(2,6);
  const order = {
    id,
    start:Date.now(),
    status:"accepted",
    guest,
    answers
  };

  const ids = JSON.parse(localStorage.getItem(LS_ORDER_IDS)||"[]");
  ids.push(id);
  localStorage.setItem(LS_ORDER_IDS,JSON.stringify(ids));

  go("waiting");
  startTimer(order.start);

  await fetch(`${BACKEND_BASE}/order`,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(order)
  });
}

function startTimer(start){
  clearInterval(guestTimerInt);
  guestTimerInt=setInterval(()=>{
    const d=(start+DURATION_MS)-Date.now();
    if(d<=0){document.getElementById("guestTimer").textContent="–ì–æ—Ç–æ–≤–æ";return;}
    const m=Math.floor(d/60000);
    const s=Math.floor((d%60000)/1000);
    document.getElementById("guestTimer").textContent=`${m}:${String(s).padStart(2,"0")}`;
  },1000);
}

/* ===== –õ–ò–ß–ù–´–ô –ö–ê–ë–ò–ù–ï–¢ –ì–û–°–¢–Ø ===== */
async function showGuestDashboard(){
  const ids = JSON.parse(localStorage.getItem(LS_ORDER_IDS)||"[]");
  if(!ids.length){ go("s0"); return; }

  const r = await fetch(`${BACKEND_BASE}/orders?limit=200`);
  const data = await r.json();

  const list = data.orders.filter(o=>ids.includes(o.id));
  const box = document.getElementById("guestOrders");
  box.innerHTML="";

  if(!list.length){ go("s0"); return; }

  list.sort((a,b)=>b.start-a.start);

  list.forEach(o=>{
    let text="–ì–æ—Ç–æ–≤–∏—Ç—Å—è";
    if(o.status==="in_progress") text="–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω";
    if(o.status==="finished") text="–≠—Ç–æ—Ç –º–æ–º–µ–Ω—Ç —É–∂–µ —Å–ª—É—á–∏–ª—Å—è";

    box.innerHTML+=`
      <div class="order">
        <b>${text}</b><br>
        <span class="small">${new Date(o.start).toLocaleTimeString()}</span>
      </div>`;
  });

  go("guest-dashboard");
}

/* ===== –ú–ê–°–¢–ï–† ===== */
async function refreshOrders(){
  const r = await fetch(`${BACKEND_BASE}/orders?limit=200`);
  const data = await r.json();
  const box=document.getElementById("orders");
  box.innerHTML="";
  data.orders.forEach(o=>{
    box.innerHTML+=`
      <div class="order">
        <b>${o.guest.name}</b>
        <div class="btnRow">
          <button class="btn secondary" onclick="setStatus('${o.id}','in_progress')">–ù–∞—á–∞—Ç—å</button>
          <button class="btn" onclick="setStatus('${o.id}','finished')">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>
      </div>`;
  });
}

async function setStatus(id,status){
  await fetch(`${BACKEND_BASE}/order/${id}/status`,{
    method:"PATCH",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({status})
  });
  refreshOrders();
}

/* ===== START ===== */
document.addEventListener("DOMContentLoaded",()=>{
  if(isMaster){
    go("master");
    refreshOrders();
    setInterval(refreshOrders,3000);
  }else{
    showGuestDashboard();
  }
});
</script>

</body>
</html>
