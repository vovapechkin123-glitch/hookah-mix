<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>THE MENU</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700;800&family=Cormorant+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  color-scheme: dark;

  --ink: rgba(255,255,255,.93);
  --muted: rgba(255,255,255,.70);
  --soft: rgba(255,255,255,.55);

  --brass1: rgba(231,194,122,1);
  --brass2: rgba(183,122,51,1);

  --stroke: rgba(255,230,190,.12);
  --stroke2: rgba(255,255,255,.08);

  --paperTop: rgba(34,20,12,.82);
  --paperMid: rgba(22,13,8,.82);
  --paperBot: rgba(14,8,6,.86);

  --shadowA: 0 24px 70px rgba(0,0,0,.62);
  --shadowB: 0 14px 40px rgba(0,0,0,.52);

  --ease: cubic-bezier(.2,.9,.2,1);
  --r14: 14px;
  --r18: 18px;
  --r22: 22px;
  --r26: 26px;

  --safeTop: env(safe-area-inset-top, 0px);
  --safeBottom: env(safe-area-inset-bottom, 0px);
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  color:var(--ink);
  overflow:hidden;

  font-family: "Cormorant Garamond", ui-serif, Georgia, "Times New Roman", serif;
  background:
    radial-gradient(1200px 900px at 22% 10%, rgba(231,194,122,.10), transparent 60%),
    radial-gradient(900px 700px at 85% 35%, rgba(183,122,51,.12), transparent 60%),
    url("./bg.jpg") center/cover no-repeat fixed;
}

body::before{
  content:"";
  position:fixed;
  inset:0;
  z-index:0;
  pointer-events:none;
  background:
    radial-gradient(1200px 900px at 50% 42%, rgba(0,0,0,.18), rgba(0,0,0,.64) 72%, rgba(0,0,0,.86) 100%),
    linear-gradient(180deg, rgba(0,0,0,.58), rgba(0,0,0,.32) 40%, rgba(0,0,0,.60));
}

body::after{
  content:"";
  position:fixed;
  inset:0;
  z-index:0;
  pointer-events:none;
  opacity:.10;
  mix-blend-mode: overlay;
  background-image:
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.85'/%3E%3C/svg%3E");
}

#app{
  position:relative;
  z-index:1;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  padding: calc(14px + var(--safeTop)) 14px calc(14px + var(--safeBottom));
}

.frame{
  width:min(420px, 100%);
  border-radius: var(--r26);
  padding: 12px;
  background: rgba(0,0,0,.18);
  border: 1px solid rgba(255,255,255,.08);
  box-shadow: var(--shadowA);
  backdrop-filter: blur(10px);
  overflow:hidden;
}

.panel{
  border-radius: var(--r22);
  background:
    radial-gradient(900px 520px at 28% 10%, rgba(231,194,122,.08), transparent 62%),
    radial-gradient(860px 600px at 74% 92%, rgba(183,122,51,.09), transparent 60%),
    linear-gradient(180deg, var(--paperTop), var(--paperMid) 55%, var(--paperBot));
  border: 1px solid rgba(255,230,190,.12);
  box-shadow: var(--shadowB);
  position:relative;
  overflow:hidden;
}

.panel::before{
  content:"";
  position:absolute;
  inset: 10px;
  border-radius: var(--r18);
  border: 1px solid rgba(255,255,255,.08);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.06),
    inset 0 -18px 35px rgba(0,0,0,.38),
    0 0 0 1px rgba(231,194,122,.05);
  pointer-events:none;
  opacity:.95;
}

.glow{
  position:absolute;
  inset:-80px;
  background:
    radial-gradient(520px 420px at 20% 10%, rgba(231,194,122,.12), transparent 62%),
    radial-gradient(520px 420px at 80% 85%, rgba(183,122,51,.10), transparent 62%);
  opacity:.65;
  filter: blur(18px);
  animation: glow 7.5s ease-in-out infinite;
  pointer-events:none;
  z-index:1;
}
@keyframes glow{
  0%,100%{ transform: translate3d(0,0,0); opacity:.58; }
  50%{ transform: translate3d(0,-8px,0); opacity:.78; }
}

.topbar{
  position:relative;
  z-index:2;
  padding: 14px 14px 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.brand{
  display:flex;
  align-items:center;
  gap:10px;
  letter-spacing:.22em;
  text-transform:uppercase;
  font-weight:700;
  font-size:12px;
  font-family: "Cinzel", serif;
  color: rgba(255,255,255,.78);
}
.brand .dot{
  width:7px;height:7px;border-radius:999px;
  background: rgba(231,194,122,.76);
  box-shadow: 0 0 0 4px rgba(231,194,122,.10);
}

.iconBtn{
  width:36px;height:36px;
  border-radius:999px;
  border: 1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(120px 120px at 30% 20%, rgba(231,194,122,.10), transparent 60%),
    rgba(0,0,0,.22);
  color: rgba(255,255,255,.82);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
  transition: transform .14s var(--ease), border-color .14s var(--ease), box-shadow .14s var(--ease), opacity .14s var(--ease);
  user-select:none;
}
.iconBtn:hover{ border-color: rgba(231,194,122,.22); }
.iconBtn:active{ transform: translateY(1px) scale(.98); }
.iconBtn.on{
  border-color: rgba(231,194,122,.28);
  box-shadow: 0 0 0 4px rgba(231,194,122,.10);
}

.content{
  position:relative;
  z-index:2;
  padding: 10px 14px 12px;
  max-height: calc(100vh - 160px);
  overflow:auto;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
}
.content::-webkit-scrollbar{ width:8px; }
.content::-webkit-scrollbar-thumb{
  background: rgba(255,255,255,.10);
  border-radius: 999px;
}
.content::-webkit-scrollbar-track{ background: transparent; }

.bottombar{
  position:relative;
  z-index:2;
  padding: 10px 14px calc(12px + var(--safeBottom));
  display:flex;
  justify-content:space-between;
  gap:12px;
}

.tab{
  width:100%;
  padding: 14px 12px;
  border-radius: 18px;
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(520px 260px at 30% 10%, rgba(231,194,122,.08), transparent 58%),
    linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.22));
  color: rgba(255,255,255,.72);
  font-weight:800;
  font-size:12px;
  letter-spacing:.22em;
  text-transform:uppercase;
  font-family: "Cinzel", serif;
  cursor:pointer;
  transition: transform .14s var(--ease), background .14s var(--ease), border-color .14s var(--ease), color .14s var(--ease);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.06),
    inset 0 -18px 28px rgba(0,0,0,.34);
}

.tab:active{ transform: translateY(1px) scale(.99); }

.tab.active{
  background:
    radial-gradient(520px 260px at 30% 10%, rgba(231,194,122,.20), transparent 56%),
    linear-gradient(180deg, rgba(231,194,122,.10), rgba(0,0,0,.22));
  border-color: rgba(231,194,122,.22);
  color: rgba(255,255,255,.92);
}

.h1{
  font-family:"Cinzel", serif;
  font-size: 22px;
  margin:0 0 6px;
  letter-spacing:.03em;
  font-weight:800;
}
.sub{
  color: var(--muted);
  font-size: 14px;
  line-height:1.55;
  margin:0 0 10px;
}
.hr{
  height:1px;
  background: linear-gradient(90deg, transparent, rgba(231,194,122,.20), transparent);
  margin: 12px 0;
}

.card{
  background:
    radial-gradient(700px 320px at 20% 10%, rgba(231,194,122,.08), transparent 58%),
    linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.20));
  border:1px solid rgba(255,230,190,.10);
  border-radius: var(--r18);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.06),
    inset 0 -18px 34px rgba(0,0,0,.36);
  padding: 12px;
}
.card + .card{ margin-top: 10px; }

.row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.badge{
  font-size:11px;
  padding: 7px 12px;
  border-radius: 999px;
  border:1px solid rgba(255,255,255,.10);
  background:
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
  color: rgba(255,255,255,.74);
  letter-spacing:.18em;
  text-transform:uppercase;
  font-family:"Cinzel", serif;
  position:relative;
  overflow:hidden;
}
.badge::before{
  content:"";
  position:absolute;
  inset:0;
  background:
    radial-gradient(220px 120px at 20% 10%, rgba(255,255,255,.08), transparent 60%),
    linear-gradient(90deg, transparent, rgba(231,194,122,.10), transparent);
  opacity:.35;
  pointer-events:none;
}
.badge.brass{
  border-color: rgba(231,194,122,.26);
  background:
    radial-gradient(260px 160px at 30% 10%, rgba(231,194,122,.22), transparent 60%),
    linear-gradient(180deg, rgba(231,194,122,.12), rgba(0,0,0,.20));
  color: rgba(255,255,255,.92);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.08),
    inset 0 -18px 26px rgba(0,0,0,.26),
    0 10px 26px rgba(183,122,51,.10);
  position:relative;
  overflow:hidden;
}
.badge.brass::after{
  content:"";
  position:absolute;
  inset:-40px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent);
  transform: translateX(-60%);
  opacity:.55;
  animation: brassShine 3.8s ease-in-out infinite;
  pointer-events:none;
}
@keyframes brassShine{
  0%{ transform: translateX(-60%); opacity:0; }
  30%{ opacity:.55; }
  60%{ opacity:0; }
  100%{ transform: translateX(60%); opacity:0; }
}
.badge.pulse{ animation: badgePulse 2.4s ease-in-out infinite; }
@keyframes badgePulse{ 0%,100%{ filter: brightness(1); } 50%{ filter: brightness(1.18); } }

.btn{
  width:100%;
  padding: 12px 12px;
  border-radius: 16px;
  border:1px solid rgba(255,255,255,.10);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.22));
  color: rgba(255,255,255,.88);
  cursor:pointer;
  font-weight:800;
  font-family:"Cinzel", serif;
  letter-spacing:.08em;
  transition: transform .14s var(--ease), border-color .14s var(--ease), box-shadow .14s var(--ease), filter .14s var(--ease);
  user-select:none;
}
.btn:hover{ border-color: rgba(231,194,122,.16); }
.btn:active{ transform: translateY(1px) scale(.99); }

.btn.primary{
  border-color: rgba(231,194,122,.22);
  background:
    radial-gradient(520px 260px at 30% 10%, rgba(231,194,122,.18), transparent 56%),
    linear-gradient(180deg, rgba(231,194,122,.12), rgba(0,0,0,.22));
  box-shadow: inset 0 1px 0 rgba(255,255,255,.06), 0 10px 26px rgba(183,122,51,.10);
}
.btn.ghost{ background: rgba(0,0,0,.14); }

.btnRow{ display:flex; gap:10px; margin-top:10px; }
.btnRow .btn{ width:100%; }

.option{
  padding: 12px 12px;
  border-radius: 16px;
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(480px 220px at 20% 20%, rgba(231,194,122,.10), transparent 58%),
    rgba(0,0,0,.18);
  cursor:pointer;
  transition: transform .14s var(--ease), border-color .14s var(--ease), filter .14s var(--ease);
  user-select:none;
  font-size: 16px;
}
.option:hover{ border-color: rgba(231,194,122,.18); }
.option:active{ transform: translateY(1px) scale(.99); }
.option + .option{ margin-top: 10px; }

.small{ font-size:12px; color: var(--soft); line-height:1.45; }

.fadeIn{ animation: fadeIn .26s var(--ease) both; }
@keyframes fadeIn{ from{opacity:0; transform: translateY(6px);} to{opacity:1; transform:none;} }

.stagger{
  animation: fadeInStagger .28s var(--ease) both;
}
@keyframes fadeInStagger{
  from{ opacity:0; transform: translateY(10px); filter: blur(2px); }
  to{ opacity:1; transform: translateY(0); filter: blur(0); }
}

.screen{ display:none; }
.screen.active{ display:block; }

.gate{
  display:flex;
  align-items:center;
  justify-content:center;
  min-height: 420px;
  padding: 12px 6px 6px;
  text-align:center;
}

.seal{
  width: 98px;
  height: 98px;
  border-radius: 999px;
  display:flex;
  align-items:center;
  justify-content:center;
  margin: 10px auto 14px;
  cursor:pointer;
  user-select:none;

  background:
    radial-gradient(circle at 30% 30%, rgba(231,194,122,.96), rgba(183,122,51,.84));
  box-shadow:
    0 22px 70px rgba(183,122,51,.22),
    inset 0 1px 0 rgba(255,255,255,.14),
    inset 0 -18px 30px rgba(0,0,0,.28);
  border:1px solid rgba(255,255,255,.10);
  position:relative;
  transform: translateZ(0);
}

.seal::after{
  content:"";
  position:absolute;
  inset:-18px;
  border-radius:999px;
  background: radial-gradient(circle, rgba(231,194,122,.16), transparent 60%);
  opacity:.72;
  animation: pulse 2.8s ease-in-out infinite;
}
@keyframes pulse{
  0%,100%{ transform: scale(1); opacity:.62; }
  50%{ transform: scale(1.08); opacity:.92; }
}
.seal .note{
  font-size: 34px;
  font-weight: 900;
  transform: translateY(-1px);
  filter: drop-shadow(0 10px 22px rgba(0,0,0,.38));
  position:relative;
  z-index:1;
}

.gateOut{ animation: gateOut .56s var(--ease) both; }
@keyframes gateOut{
  from{ opacity:1; transform: translateY(0) scale(1); }
  to{ opacity:0; transform: translateY(10px) scale(.985); }
}

.profile{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
  margin-bottom: 10px;
}
.name{
  font-family:"Cinzel", serif;
  font-size:20px;
  font-weight:800;
  letter-spacing:.02em;
}
.meta{
  font-size:14px;
  color: rgba(255,255,255,.62);
  margin-top:4px;
}
.sectionTitle{
  font-family:"Cinzel", serif;
  font-size:12px;
  letter-spacing:.22em;
  text-transform:uppercase;
  color: rgba(255,255,255,.58);
  margin: 12px 0 8px;
}

.momentTitle{
  font-family:"Cinzel", serif;
  font-weight:800;
  font-size:18px;
}
.momentDate{
  color: rgba(255,255,255,.56);
  font-size:13px;
  margin-top:4px;
}

.grid2{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}

.medal{
  position:relative;
  border-radius: 18px;
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(420px 240px at 20% 20%, rgba(231,194,122,.10), transparent 60%),
    radial-gradient(380px 260px at 80% 90%, rgba(183,122,51,.08), transparent 60%),
    rgba(0,0,0,.16);
  padding: 12px;
  min-height: 96px;
  overflow:hidden;
  transition: transform .16s var(--ease), border-color .16s var(--ease), filter .16s var(--ease);
  user-select:none;
  cursor:pointer;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.06),
    inset 0 -22px 38px rgba(0,0,0,.36);
}
.medal:active{ transform: translateY(1px) scale(.99); }
.medal:hover{ border-color: rgba(231,194,122,.18); }
.medal.lock{
  opacity:.36;
  filter: grayscale(.55) brightness(.82);
  cursor:default;
}
.medal::after{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  background:
    radial-gradient(260px 160px at 30% 20%, rgba(255,255,255,.06), transparent 60%),
    linear-gradient(90deg, transparent, rgba(231,194,122,.08), transparent);
  opacity:.35;
}
.medal .head{
  display:flex;
  align-items:center;
  gap:12px;
}
.medal .sealCoin{
  width:46px;
  height:46px;
  border-radius:999px;
  position:relative;
  flex:0 0 auto;
  border:1px solid rgba(255,255,255,.12);
  background:
    radial-gradient(circle at 30% 28%, rgba(231,194,122,.96), rgba(183,122,51,.58));
  box-shadow:
    0 14px 34px rgba(183,122,51,.18),
    inset 0 1px 0 rgba(255,255,255,.12),
    inset 0 -16px 18px rgba(0,0,0,.40);
}
.medal .sealCoin::before{
  content:"";
  position:absolute;
  inset:6px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.35);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.06),
    inset 0 -10px 14px rgba(0,0,0,.28);
  opacity:.9;
}
.medal .sealCoin::after{
  content:"";
  position:absolute;
  inset:-14px;
  border-radius:999px;
  background: radial-gradient(circle, rgba(231,194,122,.14), transparent 60%);
  opacity:0;
  transform: scale(.95);
  transition: opacity .18s var(--ease), transform .18s var(--ease);
}
.medal.ok::before{
  content:"";
  position:absolute;
  inset:-80px;
  background: radial-gradient(circle, rgba(231,194,122,.14), transparent 60%);
  opacity:.65;
  filter: blur(18px);
  animation: medalGlow 3.4s ease-in-out infinite;
  pointer-events:none;
}
@keyframes medalGlow{
  0%,100%{ transform: translate3d(0,0,0); opacity:.45; }
  50%{ transform: translate3d(0,-6px,0); opacity:.85; }
}
.medal.ok:hover .sealCoin::after{
  opacity:.9;
  transform: scale(1);
}
.medal .sealIcon{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1;
  opacity:.78;
  filter: drop-shadow(0 1px 0 rgba(255,255,255,.08));
}
.medal .sealIcon svg{
  width:22px;
  height:22px;
}
.medal .sealIcon path,
.medal .sealIcon circle,
.medal .sealIcon polygon,
.medal .sealIcon line{
  stroke: rgba(0,0,0,.55);
  fill: none;
  stroke-width: 2.2;
  stroke-linecap: round;
  stroke-linejoin: round;
}
.medal .t{
  font-family:"Cinzel", serif;
  font-weight:800;
  font-size:13px;
  margin-bottom:2px;
  letter-spacing:.06em;
}
.medal .d{
  font-size:13px;
  color: rgba(255,255,255,.60);
  line-height:1.35;
}

.tabsHint{
  font-size:12px;
  color: rgba(255,255,255,.52);
  margin-top:10px;
  text-align:center;
}

.waitCenter{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding: 8px 6px 2px;
  min-height: 420px;
}

.hourIcon{
  width: 92px;
  height: 120px;
  position:relative;
  margin: 12px auto 12px;
  filter: drop-shadow(0 16px 42px rgba(0,0,0,.48));
}

.hgFrame{
  position:absolute;
  inset:0;
  border-radius: 26px;
  border: 1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(300px 220px at 30% 20%, rgba(231,194,122,.10), transparent 60%),
    rgba(0,0,0,.20);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.06),
    inset 0 -22px 44px rgba(0,0,0,.38);
}

.hgGlass{
  position:absolute;
  left:16px; right:16px;
  top:14px; bottom:14px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.08);
  overflow:hidden;
  background: rgba(0,0,0,.10);
}

.hgTop, .hgBottom{
  position:absolute;
  left:10px; right:10px;
  border-radius: 14px;
  background: linear-gradient(180deg, rgba(231,194,122,.78), rgba(183,122,51,.36));
  box-shadow: 0 12px 36px rgba(183,122,51,.12);
}
.hgTop{ top: 10px; height: 48%; }
.hgBottom{ bottom: 10px; height: 0%; }

.hgStream{
  position:absolute;
  left:50%;
  top:50%;
  width:2px;
  height:46px;
  transform: translate(-50%,-50%);
  background: rgba(231,194,122,.62);
  opacity:.75;
  animation: stream 1.2s ease-in-out infinite;
}
@keyframes stream{
  0%,100%{ opacity:.50; }
  50%{ opacity:.94; }
}

.timer{
  font-family:"Cinzel", serif;
  font-size: 32px;
  letter-spacing:.14em;
  font-weight: 800;
  margin: 8px 0 6px;
  color: rgba(255,255,255,.92);
}

.lockLine{
  font-size:13px;
  color: rgba(255,255,255,.64);
  margin-top:6px;
}

.kitchenTitle{
  font-family:"Cinzel", serif;
  font-size:18px;
  font-weight:800;
}
.kitchenSub{ color: rgba(255,255,255,.64); font-size:13px; margin-top:4px; }

.kBtns{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  margin-top: 10px;
}
.kBtns .btn{ padding: 11px 10px; font-size:12px; letter-spacing:.14em; text-transform:uppercase; }

.miniNote{
  color: rgba(255,255,255,.55);
  font-size:12px;
  margin-top:8px;
}

a{ color: inherit; text-decoration:none; }
</style>
</head>

<body>
<div id="app">
  <div class="frame">
    <div class="panel">
      <div class="glow"></div>

      <div class="topbar">
        <div class="brand">
          <span class="dot"></span>
          <span>THE MENU</span>
        </div>
        <button class="iconBtn" id="musicBtn" title="Музыка">♫</button>
      </div>

      <div class="content">

        <div class="screen active fadeIn" id="scr_gate">
          <div class="gate">
            <div>
              <div class="seal" id="sealBtn"><div class="note">♫</div></div>
              <div class="h1">Включите зал.</div>
              <div class="sub">Нажмите на знак.<br>Дальше — без лишних слов.</div>
              <div class="small">Громкость уже выставлена: 30%.</div>
            </div>
          </div>
        </div>

        <div class="screen fadeIn" id="scr_door">
          <div class="h1">Открыть дверь.</div>
          <div class="sub">Это вход не в заказ.<br>Это вход в процесс.</div>
          <div class="hr"></div>
          <button class="btn primary" id="btnDoor">Открыть</button>
          <button class="btn ghost" id="btnDoorHelp">Я не могу дать гео</button>
          <div class="tabsHint">Если устройство молчит — сегодня без этого.</div>
        </div>

        <div class="screen fadeIn" id="scr_outside">
          <div class="h1">Снаружи.</div>
          <div class="sub">Сейчас это место не совпадает с залом.<br>Вернитесь — и повторите.</div>
          <div class="btnRow">
            <button class="btn primary" id="btnOutsideRetry">Проверить снова</button>
            <button class="btn" id="btnOutsideBack">Назад</button>
          </div>
        </div>

        <div class="screen fadeIn" id="scr_noPerm">
          <div class="h1">Дверь закрыта.</div>
          <div class="sub">Без разрешения на геолокацию<br>зал не открывается.</div>
          <div class="btnRow">
            <button class="btn primary" id="btnNoPermRetry">Попробовать снова</button>
            <button class="btn" id="btnNoPermBack">Назад</button>
          </div>
        </div>

        <div class="screen fadeIn" id="scr_geoErr">
          <div class="h1">Тишина.</div>
          <div class="sub">Устройство молчит.<br>Сегодня — без этого.</div>
          <button class="btn primary" id="btnGeoErrRetry">Ещё раз</button>
          <button class="btn" id="btnGeoErrBack">Назад</button>
        </div>

        <div class="screen fadeIn" id="scr_welcome">
          <div class="h1">Прежде чем мы начнём.</div>
          <div class="sub">
            Здесь не подбирают вкус.<br><br>
            Здесь фиксируют момент.<br><br>
            То, что вы получите,<br>не существует заранее.
          </div>
          <div class="hr"></div>
          <button class="btn primary" id="btnStartCourse">Создать момент</button>
          <button class="btn ghost" id="btnGoCabinet">В кабинет</button>
        </div>

        <div class="screen fadeIn" id="scr_course">
          <div class="h1" id="qTitle">THE MENU</div>
          <div class="sub" id="qText">К какому цвету тянется рука сейчас?</div>
          <div id="qOptions"></div>
          <div class="btnRow">
            <button class="btn ghost" id="btnQBack">Назад</button>
            <button class="btn" id="btnQAbort">В кабинет</button>
          </div>
        </div>

        <div class="screen fadeIn" id="scr_wait">
          <div class="waitCenter">
            <div class="h1" id="waitTitle">Процесс идёт.</div>
            <div class="sub" id="waitSub">Не вмешивайтесь.</div>

            <div class="hourIcon" aria-hidden="true">
              <div class="hgFrame"></div>
              <div class="hgGlass">
                <div class="hgTop" id="hgTop"></div>
                <div class="hgStream"></div>
                <div class="hgBottom" id="hgBottom"></div>
              </div>
            </div>

            <div class="timer" id="waitTimer">—:—</div>
            <div class="lockLine" id="waitHint">Время начнётся, когда кухня подтвердит.</div>

            <button class="btn primary" id="btnWaitCab">В кабинет</button>
          </div>
        </div>

        <div class="screen fadeIn" id="scr_cabinet">
          <div class="profile">
            <div>
              <div class="brand" style="margin-bottom:10px;">
                <span class="dot"></span><span>THE MENU</span>
              </div>
              <div class="name" id="cabName">Гость</div>
              <div class="meta" id="cabMeta">Моментов: 0 · Оценок: 0</div>
            </div>
            <button class="iconBtn" id="musicBtn2" title="Музыка" style="margin-top:6px;">♫</button>
          </div>

          <div class="card" id="cabNowCard" style="display:none;">
            <div class="row">
              <div>
                <div class="momentTitle" style="font-size:16px;">Сейчас</div>
                <div class="small" id="cabNowText">Процесс уже начался. Не вмешивайтесь.</div>
              </div>
              <span class="badge brass pulse" id="cabNowState">…</span>
            </div>
            <div class="btnRow">
              <button class="btn primary" id="btnCabToWait">Вернуться к процессу</button>
              <button class="btn" id="btnCabOpenNow">Открыть</button>
            </div>
          </div>

          <div class="sectionTitle">Последние моменты</div>
          <div id="cabLast"></div>

          <div class="btnRow">
            <button class="btn" id="btnOpenArchive">Архив</button>
            <button class="btn primary" id="btnNewMoment">Создать новый момент</button>
          </div>

          <div class="sectionTitle">Знаки</div>
          <div class="grid2" id="cabAch"></div>

          <div class="tabsHint">Оценка — это не вкус. Это след.</div>
        </div>

        <div class="screen fadeIn" id="scr_archive">
          <div class="row">
            <div class="h1" style="margin:0;">Архив</div>
            <span class="badge" id="archCount">0</span>
          </div>
          <div class="sub">Здесь лежат моменты, которые уже случились.</div>
          <div id="archList"></div>
          <button class="btn" id="btnArchBack">Назад</button>
        </div>

        <div class="screen fadeIn" id="scr_moment">
          <div class="row">
            <div>
              <div class="h1" id="mTitle" style="margin:0;">Момент</div>
              <div class="small" id="mDate">—</div>
            </div>
            <span class="badge brass" id="mStatus">…</span>
          </div>

          <div class="hr"></div>

          <div class="card" id="mBody"></div>

          <div class="card" style="margin-top:10px;">
            <div class="momentTitle" style="font-size:14px;margin-bottom:6px;">Жест</div>
            <div class="small" style="margin-bottom:10px;">Не вкус. Не табак. Результат момента.</div>

            <div class="btnRow">
              <button class="btn" id="rateBad">Слабо</button>
              <button class="btn" id="rateOk">Честно</button>
              <button class="btn primary" id="ratePerfect">Идеально</button>
            </div>

            <button class="btn ghost" id="btnTip" style="margin-top:10px;">Оставить жест</button>
          </div>

          <button class="btn" id="btnMomentBack">Назад</button>
        </div>

        <div class="screen fadeIn" id="scr_master">
          <div class="row">
            <div>
              <div class="kitchenTitle">Кухня</div>
              <div class="kitchenSub">Здесь не “заказы”. Здесь — моменты.</div>
            </div>
            <span class="badge" id="kCount">…</span>
          </div>

          <div id="kList" style="margin-top:10px;"></div>

          <button class="btn" id="btnKRefresh">Обновить</button>
          <div class="miniNote">Песок у гостя начнётся, когда вы нажмёте “Кухня услышала”.</div>
        </div>

      </div>

      <div class="bottombar" id="bottomTabs" style="display:none;">
        <button class="tab" id="tabArchive">Архив</button>
        <button class="tab active" id="tabMoments">Моменты</button>
      </div>

    </div>
  </div>
</div>

<audio id="bgMusic" src="./7441574b62bac5e.mp3" loop preload="auto"></audio>

<script>
/* =========================
   CONFIG
   ========================= */
const BACKEND_BASE = "https://hookah-mix-bot-56x5.onrender.com";
const MASTER_ID = 1292778768;

const TIP_URL = "https://netmonet.co/qr/192937/tip?o=6";
const DURATION_MS = 25 * 60 * 1000;
const MUSIC_VOLUME = 0.30;

const GEOFENCE = { lat: 56.519963, lon: 84.933527, radiusM: 40 };
const GEO_TTL_MS = 2 * 60 * 60 * 1000;

const tg = window.Telegram?.WebApp;
const tgUser = tg?.initDataUnsafe?.user || null;
const isMaster = !!(tgUser && tgUser.id === MASTER_ID);

const guest = {
  id: tgUser?.id,
  name: tgUser?.first_name || "Гость",
  username: tgUser?.username || ""
};

const LS_MOMENT_IDS = "hm_moment_ids";
const LS_GEO_UNTIL = "hm_geo_until";
const LS_MUSIC_ON = "hm_music_on";

const $ = (id)=>document.getElementById(id);
function escapeHtml(str=""){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

const screens = [
  "scr_gate","scr_door","scr_outside","scr_noPerm","scr_geoErr",
  "scr_welcome","scr_course","scr_wait",
  "scr_cabinet","scr_archive","scr_moment",
  "scr_master"
];
function go(id){
  screens.forEach(s=>$(s).classList.remove("active"));
  $(id).classList.add("active");
}

function showBottomTabs(on){
  $("bottomTabs").style.display = on ? "flex" : "none";
}
function setActiveTab(tab){
  $("tabArchive").classList.toggle("active", tab==="archive");
  $("tabMoments").classList.toggle("active", tab==="moments");
}

/* Micro haptics */
function tap(){
  try{ tg?.HapticFeedback?.impactOccurred("light"); }catch{}
}

/* MUSIC */
const audioEl = $("bgMusic");
const musicBtn = $("musicBtn");
const musicBtn2 = $("musicBtn2");

function setMusicBtn(on){
  musicBtn?.classList.toggle("on", !!on);
  musicBtn2?.classList.toggle("on", !!on);
}
async function playMusic(){
  try{
    audioEl.volume = MUSIC_VOLUME;
    await audioEl.play();
    localStorage.setItem(LS_MUSIC_ON,"1");
    setMusicBtn(true);
    tap();
  }catch(e){
    localStorage.setItem(LS_MUSIC_ON,"0");
    setMusicBtn(false);
  }
}
function pauseMusic(){
  audioEl.pause();
  localStorage.setItem(LS_MUSIC_ON,"0");
  setMusicBtn(false);
  tap();
}
function toggleMusic(){
  if(audioEl.paused) playMusic();
  else pauseMusic();
}
musicBtn.addEventListener("click", toggleMusic);
musicBtn2.addEventListener("click", toggleMusic);

/* GEO */
function distanceMeters(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const toRad = v => v * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function isInsideFence(lat, lon){
  return distanceMeters(lat, lon, GEOFENCE.lat, GEOFENCE.lon) <= GEOFENCE.radiusM;
}
function requestLocation(){
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation) return reject(new Error("no_geolocation"));
    navigator.geolocation.getCurrentPosition(
      (pos)=>resolve({lat:pos.coords.latitude, lon:pos.coords.longitude, accuracy:pos.coords.accuracy}),
      (err)=>reject(err),
      { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
    );
  });
}
function setGeoAccessUntil(ts){ localStorage.setItem(LS_GEO_UNTIL, String(ts)); }
function hasGeoAccessNow(){ return Date.now() < Number(localStorage.getItem(LS_GEO_UNTIL)||0); }

/* STORAGE */
function getMomentIds(){
  try{ return JSON.parse(localStorage.getItem(LS_MOMENT_IDS)||"[]"); }catch{ return []; }
}
function addMomentId(id){
  const ids = getMomentIds();
  if(!ids.includes(id)) ids.push(id);
  localStorage.setItem(LS_MOMENT_IDS, JSON.stringify(ids));
  return ids;
}

/* API */
async function safeJson(r){
  const t = await r.text();
  try{ return JSON.parse(t); }catch{ return { ok:false, raw:t }; }
}
async function apiGetMoments(limit=200){
  const r = await fetch(`${BACKEND_BASE}/moments?limit=${limit}`);
  const data = await safeJson(r);
  if(!r.ok) throw new Error("getMoments failed");
  return data;
}
async function apiCreateMoment(m){
  const r = await fetch(`${BACKEND_BASE}/moment`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(m)
  });
  const data = await safeJson(r);
  if(!r.ok) throw new Error("createMoment failed");
  return data;
}
async function apiSetStatus(id,status){
  const r = await fetch(`${BACKEND_BASE}/moment/${id}/status`,{
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({status})
  });
  const data = await safeJson(r);
  if(!r.ok) throw new Error("setStatus failed");
  return data;
}
async function apiSetRating(id,rating){
  const r = await fetch(`${BACKEND_BASE}/moment/${id}/rating`,{
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({rating})
  });
  const data = await safeJson(r);
  if(!r.ok) throw new Error("setRating failed");
  return data;
}

/* QUESTIONS */
const QUESTIONS = [
  { title:"THE MENU", text:"К какому цвету тянется рука сейчас?", options:["Тень","Свет","Пепел","Медь","Холод"] },
  { title:"Касание.", text:"Ощущение в пространстве —", options:["Почти вплотную","На расстоянии","Воздушно","Тяжело"] },
  { title:"Пауза.", text:"Если сделать паузу —", options:["Орех","Фрукт","Хлеб","Ничего"] },
  { title:"Скорость.", text:"Это время хочется прожить —", options:["Медленно","Рывками","Ровно","Не чувствуя времени"] },
  { title:"Материал.", text:"Ближе к чему?", options:["Бархат","Металл","Дерево","Стекло"] },
  { title:"Температура.", text:"Это должно быть —", options:["Холод","Тепло","Контраст","Без температуры"] },
  { title:"Запрет.", text:"Что сегодня нельзя впускать?", options:["Цитрус","Ягоды","Десерт","Тяжёлые специи","Мята"] },
  { title:"Вес.", text:"Финальное ощущение —", options:["Легко","Ровно","Плотно","Тяжело"] },
];
const EPITHETS = ["Холод Тень","Строгая Сцена","Тёмная Линия","Тяжёлая Привычка","Сухая Тишина","Нервная Комната","Белый Шум","Медный Пепел"];
function randomEpithet(){ return EPITHETS[Math.floor(Math.random()*EPITHETS.length)]; }

/* COURSE STATE */
let qIndex = 0;
let answers = {};
let openMomentId = null;
let waitPoll = null;

function renderQuestion(){
  const q = QUESTIONS[qIndex];
  $("qTitle").textContent = q.title;
  $("qText").textContent = q.text;

  const box = $("qOptions");
  box.innerHTML = "";
  q.options.forEach(opt=>{
    const div = document.createElement("div");
    div.className = "option";
    div.textContent = opt;
    div.onclick = ()=>{ tap(); pickAnswer(opt); };
    box.appendChild(div);
  });
}

async function pickAnswer(v){
  answers[String(qIndex+1)] = v;
  qIndex++;

  if(qIndex < QUESTIONS.length){
    renderQuestion();
    return;
  }
  await createMoment();
}

async function createMoment(){
  const id = Date.now()+"_"+Math.random().toString(36).slice(2,6);
  const m = {
    id,
    createdAt: Date.now(),
    status: "new",
    acceptedAt: null,
    rating: null,
    epithet: randomEpithet(),
    guest,
    answers
  };

  addMomentId(id);
  go("scr_wait");
  startWaitingLoop();

  try{ await apiCreateMoment(m); }catch(e){}
}

/* WAITING */
function fmt(ms){
  if(ms == null) return "—:—";
  const t = Math.max(0, Math.floor(ms/1000));
  const m = Math.floor(t/60);
  const s = t%60;
  return `${m}:${String(s).padStart(2,"0")}`;
}
function setHourglassProgress(p01){
  const p = Math.max(0, Math.min(1, p01));
  const top = $("hgTop");
  const bot = $("hgBottom");
  const topH = 48 - (44*p);
  const botH = 48 * p;
  top.style.height = `${topH}%`;
  bot.style.height = `${botH}%`;
}

async function startWaitingLoop(){
  if(waitPoll) clearInterval(waitPoll);

  async function tick(){
    try{
      const ids = getMomentIds();
      const data = await apiGetMoments(250);
      const mine = (data.moments||[]).filter(m=>ids.includes(m.id)).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      const active = mine.find(m=>m.status !== "finished") || null;

      if(!active){
        await renderCabinet();
        go("scr_cabinet");
        showBottomTabs(true);
        setActiveTab("moments");
        return;
      }

      if(!active.acceptedAt){
        $("waitTitle").textContent = "Процесс идёт.";
        $("waitSub").textContent = "Не вмешивайтесь.";
        $("waitTimer").textContent = "—:—";
        $("waitHint").textContent = "Время начнётся, когда кухня подтвердит.";
        setHourglassProgress(0);
        openMomentId = active.id;
        return;
      }

      const left = (active.acceptedAt + DURATION_MS) - Date.now();
      const progress = 1 - (left / DURATION_MS);

      if(left <= 0 || active.status === "finished"){
        $("waitTitle").textContent = "Момент случился.";
        $("waitSub").textContent = "Дальше — без интерфейса.";
        $("waitTimer").textContent = "Готово";
        $("waitHint").textContent = "Откройте момент в кабинете.";
        setHourglassProgress(1);
        openMomentId = active.id;
        return;
      }

      $("waitTitle").textContent = "Процесс идёт.";
      $("waitSub").textContent = "Не вмешивайтесь.";
      $("waitTimer").textContent = fmt(left);
      $("waitHint").textContent = "Песок идёт.";
      setHourglassProgress(progress);
      openMomentId = active.id;

    }catch(e){
      $("waitHint").textContent = "Нет связи.";
    }
  }

  await tick();
  waitPoll = setInterval(tick, 2000);
}

function calcAchievements(moments){
  const sessions = moments.length;
  const rated = moments.filter(m=>!!m.rating).length;

  return [
    { key:"first", t:"Первый момент", d:"Вы вошли.", ok:sessions>=1, icon:"spark" },
    { key:"return", t:"Возвращение", d:"Вы вернулись.", ok:sessions>=2, icon:"loop" },
    { key:"honest", t:"Честность", d:"Вы оценили три.", ok:rated>=3, icon:"eye" }
  ];
}

async function renderCabinet(){
  $("cabName").textContent = guest.name;

  const ids = getMomentIds();
  const lastBox = $("cabLast");
  const achBox = $("cabAch");
  lastBox.innerHTML = "";
  achBox.innerHTML = "";

  try{
    const data = await apiGetMoments(250);
    const mine = (data.moments||[]).filter(m=>ids.includes(m.id)).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    const rated = mine.filter(m=>!!m.rating).length;

    $("cabMeta").textContent = `Моментов: ${mine.length} · Оценок: ${rated}`;

    const active = mine.find(m=>m.status !== "finished") || null;
    if(active){
      $("cabNowCard").style.display = "block";
      $("cabNowState").textContent = active.acceptedAt ? "В ПРОЦЕССЕ" : "НОВЫЙ";
      $("cabNowText").textContent = active.acceptedAt
        ? "Процесс уже начался. Не вмешивайтесь."
        : "Песок ещё не запущен.";
      openMomentId = active.id;
    }else{
      $("cabNowCard").style.display = "none";
    }

    const last = mine.slice(0,3);
    if(!last.length){
      lastBox.innerHTML = `<div class="small">Пока пусто. Но зал уже здесь.</div>`;
    }else{
      last.forEach((m, idx)=>{
        const badge = (m.status==="finished")
          ? "СЛУЧИЛСЯ"
          : (m.acceptedAt ? "В ПРОЦЕССЕ" : "НОВЫЙ");

        lastBox.innerHTML += `
          <div class="card stagger" style="animation-delay:${idx*70}ms;">
            <div class="row">
              <div>
                <div class="momentTitle">${escapeHtml(m.epithet||"Момент")}</div>
                <div class="momentDate">${new Date(m.createdAt||Date.now()).toLocaleString("ru-RU")}</div>
              </div>
              <span class="badge brass">${escapeHtml(badge)}</span>
            </div>
            <div class="btnRow">
              <button class="btn" onclick="tap(); openMoment('${escapeHtml(m.id)}')">Открыть</button>
            </div>
          </div>
        `;
      });
    }

    const ach = calcAchievements(mine);

    function achIcon(type){
      if(type === "spark"){
        return `
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 2 L14.2 9.1 L22 12 L14.2 14.9 L12 22 L9.8 14.9 L2 12 L9.8 9.1 Z"></path>
          </svg>
        `;
      }
      if(type === "loop"){
        return `
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M7 8c1.6-2.4 4-3.6 6.6-3.6 4 0 7.2 3.2 7.2 7.2"></path>
            <path d="M21 11l-2.2-2.2"></path>
            <path d="M17 16c-1.6 2.4-4 3.6-6.6 3.6-4 0-7.2-3.2-7.2-7.2"></path>
            <path d="M3 13l2.2 2.2"></path>
          </svg>
        `;
      }
      if(type === "eye"){
        return `
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M2.5 12s3.6-6.5 9.5-6.5S21.5 12 21.5 12s-3.6 6.5-9.5 6.5S2.5 12 2.5 12z"></path>
            <circle cx="12" cy="12" r="2.6"></circle>
          </svg>
        `;
      }
      return "";
    }

    ach.forEach(a=>{
      achBox.innerHTML += `
        <div class="medal ${a.ok ? "ok" : "lock"}">
          <div class="head">
            <div class="sealCoin">
              <div class="sealIcon">${achIcon(a.icon)}</div>
            </div>
            <div>
              <div class="t">${escapeHtml(a.t)}</div>
              <div class="d">${escapeHtml(a.d)}</div>
            </div>
          </div>
        </div>
      `;
    });

  }catch(e){
    $("cabMeta").textContent = "Нет связи.";
    lastBox.innerHTML = `<div class="small">Нет связи.</div>`;
  }
}

async function renderArchive(){
  const ids = getMomentIds();
  const box = $("archList");
  box.innerHTML = "";

  try{
    const data = await apiGetMoments(250);
    const mine = (data.moments||[]).filter(m=>ids.includes(m.id)).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

    $("archCount").textContent = String(mine.length);

    if(!mine.length){
      box.innerHTML = `<div class="small">Архив пуст.</div>`;
      return;
    }

    mine.forEach(m=>{
      const mark = m.rating ? "ОЦЕНЕНО" : "БЕЗ ОЦЕНКИ";
      box.innerHTML += `
        <div class="card">
          <div class="row">
            <div>
              <div class="momentTitle">${escapeHtml(m.epithet||"Момент")}</div>
              <div class="momentDate">${new Date(m.createdAt||Date.now()).toLocaleString("ru-RU")}</div>
            </div>
            <span class="badge">${escapeHtml(mark)}</span>
          </div>
          <div class="btnRow">
            <button class="btn" onclick="tap(); openMoment('${escapeHtml(m.id)}')">Открыть</button>
          </div>
        </div>
      `;
    });

  }catch(e){
    box.innerHTML = `<div class="small">Нет связи.</div>`;
  }
}

window.openMoment = async function(id){
  openMomentId = id;
  go("scr_moment");
  showBottomTabs(false);
  await renderMoment();
};

async function renderMoment(){
  const id = openMomentId;
  if(!id){
    $("mTitle").textContent = "Недоступно";
    $("mBody").innerHTML = "";
    return;
  }

  try{
    const data = await apiGetMoments(250);
    const m = (data.moments||[]).find(x=>String(x.id)===String(id));
    if(!m) return;

    $("mTitle").textContent = m.epithet || "Момент";
    $("mDate").textContent = new Date(m.createdAt||Date.now()).toLocaleString("ru-RU");
    $("mStatus").textContent = (m.status==="finished") ? "СЛУЧИЛСЯ" : (m.acceptedAt ? "В ПРОЦЕССЕ" : "НОВЫЙ");

    const ans = m.answers || {};
    const lines = Object.keys(ans)
      .sort((a,b)=>Number(a)-Number(b))
      .map(k=>`<div class="small"><b>q${escapeHtml(k)}:</b> ${escapeHtml(ans[k])}</div>`)
      .join("");

    $("mBody").innerHTML = `
      <div class="momentTitle" style="font-size:14px;margin-bottom:6px;">Условия</div>
      ${lines || `<div class="small">—</div>`}
    `;
  }catch(e){
    $("mBody").innerHTML = `<div class="small">Нет связи.</div>`;
  }
}

/* MASTER */
async function renderKitchen(){
  const list = $("kList");
  list.innerHTML = "";

  try{
    const data = await apiGetMoments(250);
    const arr = (data.moments||[]).slice().sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    $("kCount").textContent = String(arr.length);

    if(!arr.length){
      list.innerHTML = `<div class="small">Нет активных моментов.</div>`;
      return;
    }

    arr.forEach(m=>{
      const badge = (m.status==="finished") ? "СЛУЧИЛСЯ" : (m.acceptedAt ? "В ПРОЦЕССЕ" : "НОВЫЙ");
      list.innerHTML += `
        <div class="card">
          <div class="row">
            <div>
              <div class="momentTitle">${escapeHtml(m.guest?.name || "Гость")}</div>
              <div class="momentDate">${new Date(m.createdAt||Date.now()).toLocaleString("ru-RU")}</div>
              <div class="small">Песок: ${m.acceptedAt ? "идёт" : "ещё не запущен"}</div>
            </div>
            <span class="badge brass">${escapeHtml(badge)}</span>
          </div>

          <div class="kBtns">
            <button class="btn primary" onclick="tap(); kSet('${escapeHtml(m.id)}','accepted')">Кухня услышала</button>
            <button class="btn" onclick="tap(); kSet('${escapeHtml(m.id)}','in_progress')">Печь работает</button>
            <button class="btn" onclick="tap(); kSet('${escapeHtml(m.id)}','serving')">Подача</button>
            <button class="btn" onclick="tap(); kSet('${escapeHtml(m.id)}','finished')">Момент случился</button>
          </div>
        </div>
      `;
    });

  }catch(e){
    $("kCount").textContent = "нет связи";
    list.innerHTML = `<div class="small">Нет связи.</div>`;
  }
}
window.kSet = async function(id,status){
  try{
    await apiSetStatus(id,status);
    await renderKitchen();
  }catch(e){}
};

/* DOOR FLOW */
async function openDoor(){
  tap();
  try{
    const pos = await requestLocation();
    const ok = isInsideFence(pos.lat, pos.lon);

    if(!ok){
      go("scr_outside");
      showBottomTabs(false);
      return;
    }

    setGeoAccessUntil(Date.now()+GEO_TTL_MS);
    go("scr_gate");
    showBottomTabs(false);
  }catch(e){
    if(e && e.code === 1){
      go("scr_noPerm");
    }else{
      go("scr_geoErr");
    }
    showBottomTabs(false);
  }
}

/* BUTTONS */
$("sealBtn").addEventListener("click", async ()=>{
  await playMusic();
  $("scr_gate").classList.add("gateOut");
  setTimeout(()=>{
    $("scr_gate").classList.remove("gateOut");
    go("scr_welcome");
    showBottomTabs(false);
  }, 560);
});

$("btnDoor").addEventListener("click", openDoor);
$("btnDoorHelp").addEventListener("click", ()=>{
  tap();
  alert("Если гео не отдаётся: попробуйте открыть мини-апп в Telegram и дать доступ к геолокации в настройках iOS. Если устройство молчит — сегодня без этого.");
});
$("btnOutsideRetry").addEventListener("click", openDoor);
$("btnOutsideBack").addEventListener("click", ()=>{ tap(); go("scr_door"); });
$("btnNoPermRetry").addEventListener("click", openDoor);
$("btnNoPermBack").addEventListener("click", ()=>{ tap(); go("scr_door"); });
$("btnGeoErrRetry").addEventListener("click", openDoor);
$("btnGeoErrBack").addEventListener("click", ()=>{ tap(); go("scr_door"); });

$("btnStartCourse").addEventListener("click", ()=>{
  tap();
  qIndex = 0;
  answers = {};
  go("scr_course");
  showBottomTabs(false);
  renderQuestion();
});

$("btnGoCabinet").addEventListener("click", async ()=>{
  tap();
  await renderCabinet();
  go("scr_cabinet");
  showBottomTabs(true);
  setActiveTab("moments");
});

$("btnQBack").addEventListener("click", ()=>{
  tap();
  if(qIndex<=0){ go("scr_welcome"); return; }
  qIndex = Math.max(0, qIndex-1);
  delete answers[String(qIndex+1)];
  renderQuestion();
});
$("btnQAbort").addEventListener("click", async ()=>{
  tap();
  await renderCabinet();
  go("scr_cabinet");
  showBottomTabs(true);
  setActiveTab("moments");
});

$("btnWaitCab").addEventListener("click", async ()=>{
  tap();
  await renderCabinet();
  go("scr_cabinet");
  showBottomTabs(true);
  setActiveTab("moments");
});

$("btnCabToWait").addEventListener("click", ()=>{
  tap();
  go("scr_wait");
  showBottomTabs(false);
  startWaitingLoop();
});
$("btnCabOpenNow").addEventListener("click", async ()=>{
  tap();
  if(!openMomentId){ return; }
  await window.openMoment(openMomentId);
});

$("btnOpenArchive").addEventListener("click", async ()=>{
  tap();
  await renderArchive();
  go("scr_archive");
  showBottomTabs(true);
  setActiveTab("archive");
});

$("btnNewMoment").addEventListener("click", ()=>{
  tap();
  qIndex = 0;
  answers = {};
  go("scr_course");
  showBottomTabs(false);
  renderQuestion();
});

$("btnArchBack").addEventListener("click", async ()=>{
  tap();
  await renderCabinet();
  go("scr_cabinet");
  showBottomTabs(true);
  setActiveTab("moments");
});

$("btnMomentBack").addEventListener("click", async ()=>{
  tap();
  await renderCabinet();
  go("scr_cabinet");
  showBottomTabs(true);
  setActiveTab("moments");
});

$("btnTip").addEventListener("click", ()=>{ tap(); window.open(TIP_URL, "_blank"); });

$("rateBad").addEventListener("click", async ()=>{
  tap();
  if(!openMomentId) return;
  try{ await apiSetRating(openMomentId,"bad"); }catch{}
  alert("Запомнил.");
});
$("rateOk").addEventListener("click", async ()=>{
  tap();
  if(!openMomentId) return;
  try{ await apiSetRating(openMomentId,"ok"); }catch{}
  alert("Запомнил.");
});
$("ratePerfect").addEventListener("click", async ()=>{
  tap();
  if(!openMomentId) return;
  try{ await apiSetRating(openMomentId,"perfect"); }catch{}
  alert("Запомнил.");
});

$("tabArchive").addEventListener("click", async ()=>{
  tap();
  await renderArchive();
  go("scr_archive");
  showBottomTabs(true);
  setActiveTab("archive");
});
$("tabMoments").addEventListener("click", async ()=>{
  tap();
  await renderCabinet();
  go("scr_cabinet");
  showBottomTabs(true);
  setActiveTab("moments");
});

$("btnKRefresh").addEventListener("click", ()=>{ tap(); renderKitchen(); });

/* START */
document.addEventListener("DOMContentLoaded", async ()=>{
  try{ tg?.ready(); tg?.expand(); }catch{}

  const on = localStorage.getItem(LS_MUSIC_ON)==="1";
  setMusicBtn(on);

  if(isMaster){
    go("scr_master");
    showBottomTabs(false);
    await renderKitchen();
    setInterval(renderKitchen, 3000);
    return;
  }

  const ids = getMomentIds();
  const geoOk = hasGeoAccessNow();

  if(ids.length){
    await renderCabinet();
    go("scr_cabinet");
    showBottomTabs(true);
    setActiveTab("moments");
    return;
  }

  if(!geoOk){
    go("scr_door");
    showBottomTabs(false);
    return;
  }

  go("scr_gate");
  showBottomTabs(false);
});
</script>
</body>
</html>
